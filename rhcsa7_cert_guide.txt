
New system:
    yum install openssh-server
    In VirtualBox, add Port Forwarding for ssh: TCP 2122 -> TCP 22
    yum install epel-release

Connect to VirtualBox:
    ssh -p 2122 ladmin@127.0.0.1



# # # # # # # # # # # # # # # # # # # # # # # # # # # # #
#                                                       #
#  Part 1-1: Performing Basic System Management Tasks   #
#                                                       #
# # # # # # # # # # # # # # # # # # # # # # # # # # # # #


1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1
1-1-1                                                                       1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1
1-1-1    Chapter 1: Installing Red Hat Enterprise Linux Server (25 pg.)     1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1
1-1-1                                                                       1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1
1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1-1

Do I Know This Already?
A D A C A C D D D B

Just a simple overview of a graphical installation.

Review Questions
1. CentOS
2. Not able to use virtualization on a 32-bit system
3. 512MB
4. Need access to updates and packages
5. Use a disk (ISO) image
6. Some features require a GUI
7. XFS
8. Yes, using an installation disk
9. Repository access
10. Minimal install

@@@
@@@ Lab 1.1
@@@
    Configure "server1" with a GUI
    Configure "server2" with a CL (minimal)
@@@



2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2
2-2-2                                                 2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2
2-2-2    Chapter 2: Using Essential Tools (23 pg.)    2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2
2-2-2                                                 2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2
2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2-2

Do I Know This Already?
B A&B C D A D D A B C

Three kinds of commands; run in the following order
    Alias: user-defined
    Internal Command: available when the shell is loaded; run from memory
    External Command: exists as an executable file on disk

alias newcommand='oldcommand'

which ls

@@@
@@@ Exercise 2.1 Using Internal and External Commands from the Shell
@@@
    time ls
        Desktop  Documents  Downloads  Music  Pictures  Public  Templates  Videos
        real    0m0.005s
        user    0m0.000s
        sys     0m0.005s
    which time
        /usr/bin/time
    echo $PATH
        /usr/local/bin:/usr/bin:/usr/local/sbin:/usr/sbin:/home/ladmin/.local/bin:/home/ladmin/bin
    /usr/bin/time ls
    -OR-
    `which time` ls
        Desktop  Documents  Downloads  Music  Pictures  Public  Templates  Videos
        0.00user 0.00system 0:00.00elapsed 100%CPU (0avgtext+0avgdata 972maxresident)k
        0inputs+0outputs (0major+302minor)pagefaults 0swaps
@@@

type time
    time is a shell keyword
type /usr/bin/time
    /usr/bin/time is /usr/bin/time
type cp
    cp is aliased to 'cp -i'

STDIN: 0<
STDOUT (overwrite): 1>
STDOUT (append): 1>>
STDERR: 2>
STDERR to STDOUT: 2>&1

Redirect standard output as well as errors to a file:
    date -s 'tomorrow' 2>&1 | tee result.txt
Same command with no terminal output:
    date -s 'tomorrow' 2>&1 | tee result.txt > /dev/null
Same result, but not POSIX:
    date -s 'tomorrow' &> result.txt
Append rather than overwrite:
    date -s 'tomorrow' 2>&1 | tee -a result.txt > /dev/null

/usr/bin/time ls 2> /dev/null
/usr/bin/time ls 2> /dev/tty1
/usr/bin/time ls 2> /dev/pts/0

@@@
@@@ Exercise 2.2 Using I/O Redirection and Pipes
@@@
    [As user ladmin]
        cd
        pwd
            /home/ladmin
        ls
            Desktop  Documents  Downloads  Music  Pictures  Public  Templates  Videos
        ls > /dev/null
        ls ilwehgi > /dev/null
            ls: cannot access ilwehgi: No such file or directory
        ls ilwehgi 2> /dev/null
        ls ilwehgi Documents 2> /dev/null
            Documents:
        ls ilwehgi Documents 2> /dev/null > output
        cat output
            Documents:
        echo hello > output
        cat output
            hello
        ls >> output
        cat output
            hello
            Desktop
            Documents
            ...
        ls -R /
            ...
        ls -R / | less
            [Opens results in less]
        ls > /dev/tty1
            -bash: /dev/tty1: Permission denied
@@@

Working with history:
    history
    Ctrl+R
    !number
        e.g., !118
        [Re-executes line 118 from the history]
    !sometext
        e.g., !vi
        [Re-executes the last line containing 'vi' from the history]

@@@
@@@ Exercise 2.3 Working with History
@@@
    history
        1  exit
        2  grep '{vmx|svm}' /proc/cpuinfo
        3  yum install kvm
        ...
    history | grep cat
        9  cat less
        44  cat output.txt
        48  cat output.txt
        ...
    !44
        hello
    history -c
    exit
    history
        1  exit
        2  grep '{vmx|svm}' /proc/cpuinfo
        3  yum install kvm
        ...
    history -c
    history -w
    exit
    history
        1  history -w
        2  exit
        3  history
@@@

@@@
@@@ Exercise 2.4 Using Bash Completion
@@@
    gd <tab> <tab>
        gdb              gdbus    gdk-pixbuf-query-loaders-64    gdm-screenshot
        gdb-add-index    gdisk    gdm                            gdmflexiserver
    gdi <tab>
        gdisk
    cd /etc
        cat pas <tab>
            cat passwd
@@@

@@@
@@@ Exercise 2.5 Vim Practice
@@@
    vim ~/testfile
        cow
        sheep
        ox
        chicken
        snake
        fish
        oxygen
    :w
        [Writes changes to the file]
    :3
        [Goes to line #3]
    dd
        [Deletes the line]
    dd
        [Deletes another line]
    u
        [Undoes the last deletion]
    o
        [Opens a new line below the current line]
        tree
        farm
    :%s/ox/OX/g
        oxygen -> OXygen
    :wq
@@@

/etc/motd
    echo "You have just logged in; don't dick around" | sudo tee -a /etc/motd > /dev/null

/etc/issue
    echo "Before you log in, remember; don't dick around" | sudo tee -a /etc/issue > /dev/null

env
    [Prints all environment variables]

@@@
@@@ Exercise 2.6 Managing the Shell Environment
@@@
    echo $LANG
        undefined.UTF-8
    ls --help
        [Shows help in English]
    LANG=fr_FR.UTF-8
    ls --help
        [Shows help in French]
    LANG=en_US.UTF-8
    echo 'COLOR=red' >> ~/.bashrc
    cat ~/.bashrc
    . ~/.bashrc
    echo $COLOR
        red
@@@

Finding help:
    --help
        [Sometimes available as '-h']
    man
        man -f passwd
            [Quick description of 'passwd']
    info/pinfo
        Use if a man page states "The full documentation for ... is maintained as a Texinfo manual."
    /usr/share/doc
        Usually for services and larger systems

man -f <some-command>
    [Shows a short description of the command]

@@@
@@@ Exercise 2.7 Using man -k
@@@
    man -k partition
    man -k password | grep 5
    man man
        /-k
    man apropos
        /mandb
    man mandb
    sudo mandb
@@@

@@@
@@@ Exercise 2.8 Using info
@@@
    man ls
        <shift> G
        q
    info coreutils 'ls invocation'
        n
            [Page down]
        p
            [Page up]
        q
@@@

Review Questions
1. A variable is an assignable placeholder that represents another value
2. man -k <keyword>
3. /etc/bashrc
4. [p]info <command>
5. ~/.bash_history
6. mandb
7. u
8. <command> 2> /dev/null
9. echo $PATH
10. !dog

@@@
@@@ Lab 2.1
@@@
    1. Add a new sh script file to /etc/profile.d/
        echo 'COLOR=red' | sudo tee -a /etc/profile.d/lab2.1.sh > /dev/null
    2. sudo date -Ins -s $(date -Ins -d '+1 minute')
        2017-02-13T21:06:22,948110923+0100
@@@



3-3-3-3-3-3-3-3-3-3-3-3-3-3-3-3-3-3-3-3-3-3-3-3-3-3-3-3-3-3-3-3-3-3-3-3-3-3-3-3-3-3-3-3-3-3-3-3-3-3-3-3-3-3-3-3-3-3-3-3-3-3-3
3-3-3                                                           3-3-3-3-3-3-3-3-3-3-3-3-3-3-3-3-3-3-3-3-3-3-3-3-3-3-3-3-3-3-3
3-3-3    Chapter 3: Essential File Management Tools (26 pg.)    3-3-3-3-3-3-3-3-3-3-3-3-3-3-3-3-3-3-3-3-3-3-3-3-3-3-3-3-3-3-3
3-3-3                                                           3-3-3-3-3-3-3-3-3-3-3-3-3-3-3-3-3-3-3-3-3-3-3-3-3-3-3-3-3-3-3
3-3-3-3-3-3-3-3-3-3-3-3-3-3-3-3-3-3-3-3-3-3-3-3-3-3-3-3-3-3-3-3-3-3-3-3-3-3-3-3-3-3-3-3-3-3-3-3-3-3-3-3-3-3-3-3-3-3-3-3-3-3-3

Do I Know This Already?
D C A C C C A D C C

Get an overview of devices and mount points:
    mount
        [Reads /proc/mounts]
    df -hT
        [Shows disk space on mounted devices]
    findmnt
        [Shows all mounts as a tree]

@@@
@@@ Exercise 3.1 Getting an Overview of Current Mounts
@@@
    mount
        sysfs on /sys type sysfs (rw,nosuid,nodev,noexec,relatime,seclabel)
        proc on /proc type proc (rw,nosuid,nodev,noexec,relatime)
        devtmpfs on /dev type devtmpfs (rw,nosuid,seclabel,size=926268k,nr_inodes=231567,mode=755)
        ...
    df -hT
        Filesystem               Type      Size  Used Avail Use% Mounted on
        /dev/mapper/cl_odin-root xfs       8.0G  5.5G  2.6G  69% /
        devtmpfs                 devtmpfs  905M     0  905M   0% /dev
        tmpfs                    tmpfs     920M   84K  920M   1% /dev/shm
        tmpfs                    tmpfs     920M  8.8M  912M   1% /run
        tmpfs                    tmpfs     920M     0  920M   0% /sys/fs/cgroup
        /dev/sda1                xfs      1014M  172M  843M  17% /boot
        tmpfs                    tmpfs     184M   16K  184M   1% /run/user/42
        tmpfs                    tmpfs     184M     0  184M   0% /run/user/1000
    findmnt
        TARGET                          SOURCE                      FSTYPE      OPTIONS
        /                               /dev/mapper/cl_odin-root    xfs         rw,relatime,seclabel,attr2,inode64,noquota
        |-/sys                          sysfs                       sysfs       rw,nosuid,nodev,noexec,relatime,seclabel
        | |-/sys/kernel/security        securityfs                  securityfs  rw,nosuid,nodev,noexec,relatime
        | |-/sys/fs/cgroup              tmpfs                       tmpfs       ro,nosuid,nodev,noexec,seclabel,mode=755
        | | |-/sys/fs/cgroup/systemd    cgroup                      cgroup      rw,nosuid,nodev,noexec,relatime,xattr,release_agent=/usr/lib/systemd/systemd-cgroups-a
        ...
@@@

ls c*
    cal, cat, catman, cd, chattr, cot, cut
ls c?t
    cat, cet, cit, cot, cut
ls c[aou]
    cat, cot, cut

@@@
@@@ Exercise 3.2 Working with Directories
@@@
    [As user ladmin]
        cd
        pwd
            /home/ladmin
        touch file1
            [Success]
        cd /
        touch file2
            touch: cannot touch 'file2': Permission denied
        cd /tmp
        touch file2
            [Success]
        cd
        mkdir files
            [Success]
        mkdir /home/$USER/files
            mkdir: cannot create directory '/home/ladmin/files': File exists
        rmdir files
            [Success; only works if folder is empty]
@@@

ls -l
    [Long listing of information]
ls -a
    [Shows all files, including hidden files]
ls -lrt
    [Most recent files shown last]
ls -d
    [List directories, not their contents]
ls -R
    [Recursive listing]

cp /somedir/* .
    [Copies all visible files to the pwd]
cp -R /somedir/* .
    [Copies all visible files and visible directories to the pwd; if a directory contains hidden content, it is copied as well]
cp /somedir/.* .
    [Copies all hidden files to the pwd]
cp -R /somedir/.* .
    [Copies all hidden files and hidden directories to the pwd; TODO also tries to copy the above directory for some reason?]
cp -a /somedir/. .
    [Copies all visible and hidden files/directories to the pwd]
cp -a /somedir/ .
    [Copies the entire somedir directory to the pwd]

@@@
@@@ Exercise 3.2 Working with Files
@@@
    cd /home/$USER
    mkdir newfiles
    mkdir oldfiles
    touch newfiles/.hidden
    touch newfiles/unhidden
    cd oldfiles
    ls -la
        .
        ..
    ls -la ../newfiles
        .
        ..
        .hidden
        unhidden
    cp -a ../newfiles/ .
    ls -la
        .
        ..
        newfiles
    rm -rf newfiles
    cp -a ../newfiles/* .
    ls -la
        .
        ..
        unhidden
    cp -a ../newfiles/. .
    ls -la
        .
        ..
        .hidden
        unhidden
@@@

ln <source> <destination>
ln /etc/hosts .
    [Creates a hard link to /etc/hosts in pwd]
ln -s /etc/hosts .
    [Creates a symbolic link to /etc/hosts in pwd]
ln -s /home /tmp
    [Creates a symbolic link to /home in /tmp]

@@@
@@@ Link Exercise
@@@
    mkdir ~/test
    cp /etc/[a-e]* ~/test
    ln -s test link
    rm link
    ls -la
        [Link is removed]
    ln -s test link
    rm -rf link
    ls -la
        [Link is removed]
    ln -s test link
    rm -rf link/
               ^
    ls -la
        [Link remains but its destination, test, is empty now]
@@@

@@@
@@@ Exercise 3.4 Working with Symbolic Links and Hard Links
@@@
    [As user ladmin]
        cd
        ln /etc/passwd .
            ln: failed to create hard link './passwd' => '/etc/passwd': Operation not permitted
        ln -s /etc/passwd .
            [Success]
        ln -s /etc/hosts
        touch newfile
        ln newfile linkedfile
            ls -la
                [inode counter is 2]
        ln -s newfile symlinkfile
        rm newfile
        cat symlinkfile
            cat: symlinkfile: No such file or directory
        cat linkedfile
            [Success]
        ls -la
            [symlinkfile still shows a link to the non-existent newfile]
        ln linkedfile newfile
        ls -la
            [link from symlinkfile to newfile is restored]
@@@

tar -cvf files.tar file1 file2 dir1 dir2

tar -tvf files.tar

tar -xvf files.tar -C place/

tar -xvf files.tar etc/hosts

file files.tar
    files.tar: POSIX tar archive (GNU)

gzip
    -z
bzip2
    -j

@@@
@@@ Exercise 3.5 Using tar
@@@
    sudo -i
    cd
    tar -cvf etc.tar /etc
    file etc.tar
        etc.tar: POSIX tar archive (GNU)
    gzip etc.tar
        [etc.tar is replaced by the compressed file etc.tar.gz]
    tar -tvf etc.tar.gz
        [Lists all files in the compressed archive, using a relative path]
    tar -xvf etc.tar.gz etc/hosts
        [etc/hosts is extracted in pwd]
    ls -R
        ./etc/hosts
    gunzip etc.tar.gz
        [etc.tar.gz is replaced by the uncompressed file etc.tar]
    tar -xvf etc.tar -C /tmp etc/passwd
    ls /tmp/etc
        passwd
    tar -cjvf home.tar /home
        [Success]
    rm -rf *gz *tar
@@@

Review Questions
1. /etc
2. ls -lat
3. mv myfile yourfile
4. rm -rf <directory>
5. ln -s /tmp ~
6. cp /etc/[abc]* .
7. ln -s /etc ~
8. rm <symbolic-link>
9. tar -czvf /tmp/etchome.tgz /etc /home
10. tar -xvf /tmp/etchome.tgz etc/passwd

@@@
@@@ Lab 3.1
@@@
    1.  sudo -i
        tar -cvf essentials.tar /home /etc
        tar -tvf essentials.tar | less
    2.  cp /root/essentials.tar /tmp
        ln essentials.tar /
    3.  mv /essentials.tar /archive.tar
    4.  ln -s /archive.tar /root/link.tar
    5.  rm -rf /archive.tar
        ls -la /root/link.tar
        rm /root/link.tar
    6.  gzip /root/essentials.tar
            ls /root | grep 'tar'
                essentials.tar.gz
@@@



4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4
4-4-4                                                   4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4
4-4-4    Chapter 4: Working with Text Files (17 pg.)    4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4
4-4-4                                                   4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4
4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4-4

Do I Know This Already?
A D D A A D A B D-NOT-B B

@@@
@@@ Exercise 4.1 Applying Basic Less Skills
@@@
    less /etc/passwd
        [/etc/passwd is opened in less]
    G
        [Scrolls to the bottom of the file]
    /root
        [Forward searches for root]
    ?root
        [Backward searches for root]
    q
    ps aux | less
        [Results are displayed in less]
    q
@@@

cat /etc/passwd
    [Results displayed in normal order]

tac
    [Inverse results displayed]

@@@
@@@ Exercise 4.2 Using Basic head and tail Operations
@@@
    tail -f /var/log/messages
        [Real-time view of the file]
    Ctrl+C
    head -n 5 /etc/passwd
        root:x:0:0:root:/root:/bin/bash
        bin:x:1:1:bin:/bin:/sbin/nologin
        daemon:x:2:2:daemon:/sbin:/sbin/nologin
        adm:x:3:4:adm:/var/adm:/sbin/nologin
        lp:x:4:7:lp:/var/spool/lpd:/sbin/nologin
    tail -n 2 /etc/passwd
        tcpdump:x:72:72::/:/sbin/nologin
        ladmin:x:1000:1000:ladmin:/home/ladmin:/bin/bash
    head -n 5 /etc/passwd | tail -n 1
        lp:x:4:7:lp:/var/spool/lpd:/sbin/nologin
@@@

cut -d : -f 1-3 /etc/passwd
    root:x:0
    bin:x:1
    daemon:x:2
    adm:x:3
    lp:x:4
    ...

cut -d : -f 1 /etc/passwd | sort
    abrt
    adm
    avahi
    bin
    chrony
    ...

cut -d : -f 3 /etc/passwd | sort -n
    0
    1
    2
    3
    4
    ...

cut -d : -f 3 /etc/passwd | sort -nr
    65534
    1000
    999
    998
    997
    ...

du -h * | sort -hr
    2.7M    anaconda
    836K    audit
    748K    sa
    460K    messages
    108K    gdm
    ...

sort -k3 -t : -hr /etc/passwd
    nfsnobody:x:65534:65534:Anonymous NFS User:/var/lib/nfs:/sbin/nologin
    ladmin:x:1000:1000:ladmin:/home/ladmin:/bin/bash
    systemd-bus-proxy:x:999:998:systemd Bus Proxy:/:/sbin/nologin
    polkitd:x:998:997:User for polkitd:/:/sbin/nologin
    unbound:x:997:996:Unbound DNS resolver:/etc/unbound:/sbin/nologin
    ...

ps aux | sort -k4 -r
    USER       PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND
    gdm       2488  0.0  5.1 1374232 97508 ?       Sl   Feb13   0:07 gnome-shell --mode=gdm
    root       726  0.0  1.4 327292 26744 ?        Ssl  Feb13   0:01 /usr/bin/python -Es /usr/sbin/firewalld --nofork --nopid
    gdm       2574  0.0  1.0 713768 18888 ?        Sl   Feb13   0:00 /usr/libexec/goa-daemon
    root      1046  0.0  1.0 620968 20208 ?        Ssl  Feb13   0:00 /usr/sbin/libvirtd
    gdm       2463  0.0  0.9 960608 18820 ?        Sl   Feb13   0:00 /usr/libexec/gnome-settings-daemon
    ...

ps aux | wc
    144    1810   14114
ps aux | wc -l
    144
ps aux | wc -w
    1810
ps aux | wc -c
    14114

Always escape regular expressions, even if both work
    USE: grep '^anna' /etc/passwd
    NOT: grep ^anna /etc/passwd

^text
    [Line starts with 'text']
text$
    [Line ends with 'text']
.
    [Wildcard for any single character]
[abc]
    [Matches a, b, or c]
*
    [Match zero to infinite of previous character/expression]
\{2\}
    [Matches exactly 2 of previous character]
\{1,3\}
    [Matches min 1 / max 3 of previous character]
colou?r
    [Matches 0 or 1 of previous character/expression]

@@@
@@@ Exercise 4.3 Using Common grep Options
@@@
    grep '^#' /etc/sysconfig/sshd
        # Configuration file for the sshd service.
        # The server keys are automatically generated if they are missing.
        # To change the automatic creation uncomment and change the appropriate
        ...
    grep -v '^#' /etc/sysconfig/sshd
        SSH_USE_STRONG_RNG=0
    grep -v '^#' /etc/sysconfig/sshd -B 5
        [Shows the five lines preceeding each match]
    grep -v -e "^#" -e "^$" /etc/sysconfig/sshd
        [Shows non-commented, non-blank lines; the $ requires "" rather than '']
@@@

awk -F : '{ print $4 }' /etc/passwd
    [Prints the fourth field from /etc/passwd; if cut doesn't work, use awk]

awk -F : '/user/ { print $1 }' /etc/passwd
    [Searches for 'user' and prints the first field of any matching line]

sed -n 5p /etc/passwd
    [Prints the fifth line of /etc/passwd]

sed -i s/oldtext/newtext/g ~/myfile
    [Updates 'myfile' directly with replacement text]

sed -i -e '2d' ~/myfile
    [Deletes line 2 in 'myfile']

sed -i -e '2d;10,15d' ~/myfile
    [Deletes line 2 and lines 10-15 in 'myfile']

Review Questions
1. ps aux | less
2. tail -n 5 ~/samplefile
3. wc -w ~/samplefile
4. Ctrl+C
5. grep -v -e '^#' -e '^;' <file>
6. + (NOT ?; ? is for zero or one)
7. grep -i 'text' <file>
8. grep -B 5 'PATH' <file>
9. sed -n p9 ~/samplefile
10. sed -i 's/user/users/g' ~/samplefile

@@@
@@@ Lab 4.1
@@@
    1.  Show line 5 from /etc/passwd (two ways)
            head -n 5 /etc/passwd | tail -n 1
            sed -n 5p /etc/passwd
    2.  Locate all text files on your server that contain the current IP address
            find / -type f -exec grep -l `ip address show dev enp0s3 | grep -Eo '([0-9]*\.){3}[0-9]*/' | cut -d/ -f1` {} \;
            grep -rnwl '/' -e "`ip address show dev enp0s3 | grep -Eo '([0-9]*\.){3}[0-9]*/' | cut -d/ -f1`"
    3.  You have just used the sed command that replaces all occurrences of the text Administrator with root. How do you revert?
            Identify recently modified files:
                find / -type f -cmin -1 | grep -v '/\.'
            In the future, use a backup extension when using 'sed -i'
                sed -i.bak 's/Administrator/root/g' sample.txt
    4.  Process the output of 'ps aux' to show the process that has the heaviest memory utilization first in the results list
            ps aux | sort -k4 -r | head -n 10
    5.  Filter the sixth column of ps aux output
            ps aux | awk '{ print $6 }'
    6.  Delete the sixth line from the file ~/myfile
            sed -i.bak -e '6d' ~/myfile
@@@



5-5-5-5-5-5-5-5-5-5-5-5-5-5-5-5-5-5-5-5-5-5-5-5-5-5-5-5-5-5-5-5-5-5-5-5-5-5-5-5-5-5-5-5-5-5-5-5-5-5-5-5-5-5-5-5-5-5-5-5-5-5-5
5-5-5                                                                     5-5-5-5-5-5-5-5-5-5-5-5-5-5-5-5-5-5-5-5-5-5-5-5-5-5
5-5-5    Chapter 5: Connecting to Red Hat Enterprise Linux 7 (19 pg.)     5-5-5-5-5-5-5-5-5-5-5-5-5-5-5-5-5-5-5-5-5-5-5-5-5-5
5-5-5                                                                     5-5-5-5-5-5-5-5-5-5-5-5-5-5-5-5-5-5-5-5-5-5-5-5-5-5
5-5-5-5-5-5-5-5-5-5-5-5-5-5-5-5-5-5-5-5-5-5-5-5-5-5-5-5-5-5-5-5-5-5-5-5-5-5-5-5-5-5-5-5-5-5-5-5-5-5-5-5-5-5-5-5-5-5-5-5-5-5-5

Do I Know This Already?
B A C B A&C-NOT-B D C D C C

@@@
@@@ Exercise 5.1 Working from Several Terminal Windows Simultaneously
@@@
    Open two terminal sessions on the same server
    As root:
        tail -f /var/log/secure
    As ladmin:
        su - (with the wrong password)
            unix_chkpwd[11791]: password check failed for user (root)
            su: pam_unix(su-l:auth): authentication failure; logname=ladmin uid=1000 euid=0 tty=pts/1 ruser=ladmin rhost=  user=root
            su: pam_succeed_if(su-l:auth): requirement "uid >= 1000" not met by user "root"
@@@

Virtual terminal switching in a non-graphical environment (/dev/tty1 ... /dev/tty6)
    Alt+F1
    ...
    Alt+F6

Virtual terminal switching in a graphical environment (/dev/tty1 ... /dev/tty6)
    Alt+Ctrl+F1
    ...
    Alt+Ctrl+F2

-OR-

Just use the 'chvt' command (/dev/tty1 ... /dev/tty6)
    chvt 1
    ...
    chvt 6

@@@
@@@ Exercise 5.2 Working with Pseudo Terminals
@@@
    In the graphical environment, open the Terminal application
        w
            20:44:23 up 10:50,  3 users,  load average: 0.00, 0.01, 0.05
            USER     TTY     FROM   LOGIN@   IDLE     JCPU     PCPU WHAT
            ladmin   :0      :0     Tue07    ?xdm?    54.68s   0.33s gdm-session-worker [pam/gdm-password]
            ladmin   pts/0   :0     Tue07    37:12m   0.02s    0.02s w
    Open another Terminal application
        w
            21:01:19 up 11:07,  6 users,  load average: 0.27, 0.18, 0.15
            USER     TTY     FROM   LOGIN@   IDLE     JCPU    PCPU WHAT
            ladmin   :0      :0     Tue07    ?xdm?    1:30    0.38s gdm-session-worker [pam/gdm-password]
            ladmin   pts/0   :0     Tue07    37:29m   0.02s   0.02s -bash
            ladmin   pts/1   :0     20:59    7.00s    0.08s   2.90s /usr/libexec/gnome-terminal-server
@@@

Pseudo terminal identification
    /dev/pts/0
    ...
    /dev/pts/5

@@@
@@@ Exercise 5.3 Using SSH to Log In to a Remote Server
@@@
    On Server2 as root:
        systemctl status sshd
        systemctl stop firewalld
        ip address | grep 'inet '
    On Server1 as ladmin:
        ssh 10.0.1.6 -l root
        yes
        w
            12:36:58 up 7 min,  2 users,  load average: 0.00, 0.05, 0.05
            USER     TTY     FROM       LOGIN@   IDLE     JCPU    PCPU    WHAT
            ladmin   tty1               12:34    58.00s   0.16s   0.16s   login -- ladmin
            root     pts/0   10.0.1.5   12:36    2.00s    0.02s   0.02s   w
        exit
@@@

Regular connections:
    ssh ladmin@172.25.1.102
    ssh 172.25.1.102 -l ladmin
Custom port:
    ssh ladmin@172.25.1.102 -p 2222
Untrusted X11 Forwarding:
    ssh -X ladmin@172.25.1.102
Trusted X11 Forwarding:
    ssh -Y ladmin@172.25.1.102

To make X11 Forwarding active by default on a client:
    vi /etc/ssh/ssh_config
        ForwardX11 yes

Copy a file to remote server as current user:
    scp /etc/hosts 172.25.1.102:/tmp

Copy a file from remote server as specified user to local server:
    scp root@172.25.1.102:/etc/hosts /home/ladmin

Copy a remote directory the the local home directory as a specified user:
    scp -r ladmin@172.25.1.102:/etc/ssh ~

scp uses '-P' for custom port specification, not '-p'

@@@
@@@ Exercise 5.4 Connecting to a Remote Server with Public/Private Keys
@@@
    On Server1 as root:
        ssh-keygen
            Generating public/private rsa key pair.
            Enter file in which to save the key (/root/.ssh/id_rsa): <Enter>
            Created directory '/root/.ssh'.
            Enter passphrase (empty for no passphrase):
            Enter same passphrase again:
            Your identification has been saved in /root/.ssh/id_rsa.
            Your public key has been saved in /root/.ssh/id_rsa.pub.
            The key fingerprint is:
            65:74:6e:c9:70:5e:c4:8f:13:15:ae:22:c3:ba:46:8a root@Server1
            The key's randomart image is:
            +--[ RSA 2048]----+
            |          o ooooo|
            |         . B o+  |
            |          o *  = |
            |        .o .  + .|
            |        S+ . . . |
            |       .. o .    |
            |    . o.         |
            |   E . ..        |
            |      ..         |
            +-----------------+
        ssh-copy-id 172.25.1.102
            The authenticity of host '172.25.1.102 (172.25.1.102)' can't be established.
            ECDSA key fingerprint is 94:5c:13:f8:a0:df:1b:12:b5:67:96:80:10:41:a0:be.
            Are you sure you want to continue connecting (yes/no)? yes
            /bin/ssh-copy-id: INFO: attempting to log in with the new key(s), to filter out any that are already installed
            /bin/ssh-copy-id: INFO: 1 key(s) remain to be installed -- if you are prompted now it is to install the new keys
            root@172.25.1.102's password:

            Number of key(s) added: 1

            Now try logging into the machine, with:   "ssh '172.25.1.102'"
            and check to make sure that only the key(s) you wanted were added.
        ssh 172.25.1.102
            [Connects successfully without a password]
@@@

ssh-keygen's default is rsa and 2048 bits; use options to change:
    ssh-keygen -t rsa -b 4096

Copy keys to the same user on the remote server:
    ssh-copy-id 172.25.1.102

Copy keys to the 'ladmin' user on the remote server (same keys can be copied to multiple remote users):
    ssh-copy-id ladmin@172.25.1.102

Scan for remote keys:
    ssh-keyscan 172.25.1.102
    ssh-keyscan -t rsa 172.25.1.102

Using the 'screen' utility
    [Open an ssh session]
    screen
        [Execute a command]
            w
                USER     TTY     FROM         LOGIN@   IDLE     JCPU    PCPU WHAT
                ladmin   pts/0   172.25.1.1   13:39    28.00s   0.10s   0.20s sshd: ladmin [p
                root     pts/1   :tty1:S.0    15:22    4.00s    0.01s   0.00s w
                                      ^^^^
        [List screen commands]
            Ctrl+A, ?
        [Disconnect]
            Ctrl+A, d
    [As the same user, reconnect to the screen session]
        screen -r
    [List all screen sessions]
        screen -ls
            There are screens on:
            4707.tty1.Server2       (Attached)
            4696.pts-0.Server2      (Detached)
            2 Sockets in /var/run/screen/S-root.
    [Connect to an available, detached screen session]
        screen -r 4696
    [Connect to a shared session]
        screen -x
        screen -x 4786
    [Disconnect current screen session from terminal (from within screen or external)]
        screen -d
    [Disconnect and terminate]
        Ctrl+D
    [Terminate the screen session]
        Ctrl+A, \

Review Questions
1. The physical screen
2. Alt+F1
3. w
4. /dev/pts/0
5. ssh -v
6. ssh -X (or ssh -Y)
7. /etc/ssh/ssh_config
8. scp /etc/hosts lisa@server2:/tmp
9. ~/.ssh/authorized_keys
10. ssh-keygen [-t rsa -b 4096]

@@@
@@@ Lab 5.1
@@@
    1.  Alt+Ctrl+F6
            /dev/tty6
        Alt+F1
            /dev/tty1
    2.  [As ladmin on server2]
            ssh -X server1
                [Login with the ladmin password for server1]
                exit
            ssh-keygen -t rsa -b 4096
                [Answer all questions by pressing <Enter>]
            ssh-copy-id server1
                [Enter the ladmin password for server1]
            ssh -X server1
                [Login is successful without a password]
@@@



6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6
6-6-6                                                     6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6
6-6-6    Chapter 6: User and Group Management (26 pg.)    6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6
6-6-6                                                     6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6
6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6-6

Do I Know This Already?
C D B B C A B C A D

'su -' is better than 'su'

Edit sudoers list with visudo

@@@
@@@ Exercise 6.1 Switching User Accounts
@@@
    As ladmin:
        whoami
            ladmin
        id
            uid=1000(ladmin) gid=1000(ladmin) groups=1000(ladmin),10(wheel) context=unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c1023
        su
        id
            uid=0(root) gid=0(root) groups=0(root) context=unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c1023
        visudo
            %wheel ALL=(ALL) ALL
        useradd -G wheel lisa
        id lisa
            uid=1001(lisa) gid=1001(lisa) groups=1001(lisa),10(wheel)
        passwd lisa
        su - lisa
        sudo useradd lori
        id lori
            uid=1002(lori) gid=1002(lori) groups=1002(lori)
@@@

Create the file /etc/nologin.txt with a message to display when someone tries to log in to a /sbin/nologin account

Update password properties directly in /etc/shadow, or using 'passwd', or using 'chage'

@@@
@@@ Exercise 6.2 Creating User Accounts
@@@
    [As the root user]
    vi /etc/login.defs
        /CREATE_HOME
            CREATE_HOME yes
        /USERGROUPS_ENAB
            USERGROUPS_ENAB no
                When 'yes', the new user's default group is the same as their name
                When 'no', the new user's default group is 'users'
    cd /etc/skel
        mkdir Pictures
        mkdir Documents
        echo "export EDITOR=/usr/bin/vim" | sudo tee -a .bashrc
    useradd linda
    id linda
        uid=1001(linda) gid=100(users) groups=100(users)
    ls /home/linda
    passwd linda
    passwd -n 30 -w 3 -x 90 linda
    for i in lisa lori bob; do useradd $i; done
    grep lori /etc/passwd /etc/shadow /etc/group
@@@

vigr
    [Command line editing of groups and secondary group members]
groupadd
    [Add new groups]
groupmod
    [Update a group's name or gid, but not members; use usermod to change membership]

@@@
@@@ Exercise 6.3 Working with Groups
@@@
    groupadd sales
    groupadd account
    groups linda
        linda : linda
    id linda
        uid=1001(linda) gid=100(users) groups=100(users)
    usermod -aG sales linda
    usermod -aG sales lisa
    usermod -aG account lori
    usermod -aG account bob
    id linda
        uid=1001(linda) gid=100(users) groups=100(users),1005(sales)
@@@

groupmems -g sales -l
    linda  lisa

groupmems -g wheel -a lisa
id lisa
    uid=1002(lisa) gid=100(users) groups=100(users),10(wheel),1005(sales)
groupmems -g wheel -d lisa
id lisa
    uid=1002(lisa) gid=100(users) groups=100(users),1005(sales)

lid -g mail
    mail(uid=8)
    postfix(uid=89)
lid -g mail | cut -d'(' -f1
    mail
    postfix

lid lisa
    users(gid=100)
    sales(gid=1005)
lid lisa | cut -d'(' -f1
    users
    sales

@@@
@@@ Exercise 6.4 Connecting to an External LDAP Server
@@@
    [Set up the FreeIPA Server as described in Appendix D]
    vi /etc/hosts
        172.25.1.103 ipa.example.com
        :wq
    yum groupinstall directory-client

    #mkdir -p /etc/openldap/cacerts
    scp ipa.example.com:/root/cacert.p12 /etc/openldap/cacerts/

    *DEPRECATED*
        authconfig-tui
            User Information -> Use LDAP
            Authentication -> Use LDAP Authentication
            [Next]
            Use TLS
            ldap://ipa.example.com
            dc=example,dc=com
            [Ok]

    Configure LDAP using sssd without TLS:
        authconfig --help | grep 'ldap'
        authconfig --enableldap --enableldapauth --update
        authconfig --ldapserver=ipa.example.com --ldapbasedn="dc=example,dc=com" --update

    Add TLS:
        authconfig --enableldaptls --update
        vi /etc/sssd/sssd.conf
            ldap_tls_reqcert = never

    Make a local home directory for LDAP users:
        authconfig --enablemkhomedir --update

    Restart sssd service to use LDAP:
        systemctl restart sssd
        getent passwd lara
        su - lara

    Other sssd configs that don't seem necessary:
        #authconfig --help | grep 'rfc'
        #authconfig --enablesssd --enablesssdauth --update
        #authconfig --enablerfc2307bis --update
        #authconfig --ldaploadcacert=ftp://ipa.example.com/pub/cacert.p12 --update

    Use nslcd instead of sssd:
        yum install openldap-clients nss-pam-ldapd
        authconfig --enableforcelegacy --update
        authconfig --enableldap --enableldapauth --update
        authconfig --ldapserver=ipa.example.com --ldapbasedn="dc=example,dc=com" --update
        authconfig --enableldaptls --update
        authconfig --enablemkhomedir --update
        vi /etc/nslcd.conf
            tls_reqcert never
        vi /etc/sysconfig/authconfig
            FORCELEGACY=yes
        systemctl restart nslcd
        getent passwd lara
        su - lara
@@@

Review Questions
1. 0
2. /etc/sudoers
3. visudo
4. /etc/login.defs; /etc/default/useradd
5. 1 (primary group GID)
6. wheel
7. vigr
8. passwd; chage
9. /etc/shadow
10. /etc/group

@@@
@@@ Lab 6.1
@@@
    1.1     groupadd sales
            groupadd account
    1.2     vi /etc/login.defs
                USERGROUPS_ENAB yes
            for i in bobby betty bill beatrix; do useradd $i; done
    1.3     for i in bobby betty; do usermod -aG sales $i; done
            for i in bill beatrix; do usermod -aG account $i; done
    1.4     vi /etc/login.defs
                PASS_MAX_DAYS   90
            for i in bobby betty bill beatrix; do passwd -x 90 $i; done
            for i in bobby betty bill beatrix; do chage -l $i; done
@@@

@@@
@@@ Lab 6.2
@@@
    1.  [Set up the FreeIPA Server as described in Appendix D]
        [Configure LDAP locally]
        su - lara
        su - linda
        su - lisa
        su - admin
@@@



7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7
7-7-7                                                   7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7
7-7-7    Chapter 7: Configuring Permissions (24 pg.)    7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7
7-7-7                                                   7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7
7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7-7

Do I Know This Already?
C A C C C D B A C C

find / -user linda
find / -group users

chown <who> <what>
chown linda account
chown <user>:<group> file
chown <user>.<group> file

chown -R linda /home/linda
chown -R :account /home/account
chown -R .account /home/account

chgrp account /home/account
chgrp -R account /home/account

groups lisa
    lisa : users sales

su - lisa
    groups
        users sales
    touch stuff
    ls -la stuff
        -rw-r--r--. 1 lisa users 0 Feb 20 19:29 stuff
                           ^^^^^
    newgrp sales
    groups
        sales users
    touch toes
    ls -la toes
        -rw-r--r--. 1 lisa sales 0 Feb 20 19:30 toes
                           ^^^^^
    exit
    groups
        users sales

gpasswd wheel
    Changing the password for group wheel
    New Password:
    Re-enter new password:
su - lisa
    groups
        users sales
    newgrp wheel
        Password:
    groups
        wheel users sales
    exit
    groups
        users sales

chmod 755 <somefile>
chmod +x <somefile>
chmod g+w,o-r <somefile>

chmod -R o+rx /data
    [Sets execute permissions on all files and directories in /data]
chmod -R o+rX /data
    [Sets execute permissions only on directories in /data]
    [Also works with the command 'setfacl']

@@@
@@@ Exercise 7.1 Managing Basic Permissions
@@@
    mkdir -p /data/sales /data/account
    chown linda:sales /data/sales
    chown linda:account /data/account
    chmod 770 /data/sales
    chmod 770 /data/account
    su - lisa
        cd /data/account
            -bash: cd: /data/account: Permission denied
        cd /data/sales
            [Success]
        touch emptyfile
            [Success]
@@@

[Set User ID (SUID)]
    ls -la /bin/passwd
        -rwsr-xr-x. 1 root root 27832 Jun 10  2014 /bin/passwd
           ^
    touch somefile
    chmod 755 somefile
    ls -l somefile
        -rwxr-xr-x. 1 root root 0 Feb 20 20:18 somefile
           ^
    chmod u+s somefile
    ls -l somefile
        -rwsr-xr-x. 1 root root 0 Feb 20 20:18 somefile
           ^
    chmod 4700 somefile
          ^
    ls -l somefile
        -rws------. 1 root root 0 Feb 20 20:18 somefile
           ^

[Set Group ID (SGID)]
    mkdir somedir
    ls -ld somedir
        drwxr-xr-x. 2 root root 6 Feb 20 20:22 somedir
              ^
    chmod g+s somedir
    ls -ld somedir
        drwxr-sr-x. 2 root root 6 Feb 20 20:22 somedir
              ^
    chmod 2070 somedir
          ^
    ls -ld somedir
        d---rws---. 2 root root 6 Feb 20 20:22 somedir
              ^

[Set Sticky Bit]
    mkdir stickydir
    chmod 755 stickydir
    ls -ld stickydir
        drwxr-xr-x. 2 root root 6 Feb 20 20:35 stickydir
                 ^
    chmod +t stickydir
    ls -ld stickydir
        drwxr-xr-t. 2 root root 6 Feb 20 20:35 stickydir
                 ^
    chmod 1005 stickydir
          ^
    ls -ld stickydir
        d------r-t. 2 root root 6 Feb 20 20:35 stickydir
                 ^

@@@
@@@ Exercise 7.2 Working with Special Permissions
@@@
    su - linda
        cd /data/sales
        touch linda1
        touch linda2
    su - lisa
        cd /data/sales
        ls -l
            -rw-r--r--. 1 linda users 0 Feb 20 20:43 linda1
            -rw-r--r--. 1 linda users 0 Feb 20 20:43 linda2
        rm -rf linda*
        ls -l
            [None]
        touch lisa1
        touch lisa2
    su -
        chmod g+s,o+t /data/sales
        ls -ld /data/sales
            drwxrws--T. 2 linda sales 49 Feb 20 20:45 /data/sales
                  ^  ^          ^^^^^
                [T means others have no execute, whereas t means others have execute; same for S and s]
    su - linda
        groups
            users sales
        cd /data/sales
        touch linda3
        touch linda4
        ls -l
            -rw-r--r--. 1 linda sales 0 Feb 20 20:56 linda3
            -rw-r--r--. 1 linda sales 0 Feb 20 20:56 linda4
                                ^^^^^
        mkdir place
        ls -ld place
            drwxr-sr-x. 2 linda sales 6 Feb 20 20:58 place/
                  ^             ^^^^^
            [Group sales is inherited, even though linda's default group is users]
            [The SGID is inherited by new directories, but not by files; sticky bit is not inherited by anything]
        rm -rf lisa*
            [Even with sticky bit set on /data/sales, files were removed because linda owns /data/sales]

    su - lisa
        cd /data/sales
        rm -rf linda*
            rm: cannot remove ‘linda3’: Operation not permitted
            rm: cannot remove ‘linda4’: Operation not permitted
                [Because sticky bit is set (and lisa doesn't own the directory), lisa cannot remove files owned by linda]
@@@

[If archiving with ACL, use star instead of tar; star is not installed by default]

getfacl -R /directory > file.acl
setfacl --restore=file.acl

setfacl -m u:linda:rwx /data
    [Gives permissions to linda on /data without making her the owner and without changing the current owner assignment]

setfacl -R -m <u,g,o>:<the-user,the-group,blank>:<r,w,x,-> <file-or-directory>
    [Modify the ACLs for current files]

setfacl -m d:<u,g,o>:<the-user,the-group,blank>:<r,w,x,-> <file-or-directory>
    [Take care of all new items that will be created]

setfacl -m d:o::- /data
    [On every new file that will ever be created in /data, others have no permissions]

@@@
@@@ Exercise 7.3 Managing Advanced Permissions Using ACLs
@@@
    setfacl -m g:account:rx /data/sales
        ls -ld /data/sales
            drwxrws--T+ 3 linda sales 60 Feb 20 21:02 /data/sales
        getfacl /data/sales
            # file: sales
            # owner: linda
            # group: sales
            # flags: -st
            user::rwx
            group::rwx
            group:account:r-x
            mask::rwx
            other::---
    setfacl -m g:sales:rx /data/account
        ls -ld /data/account
            drwxrwx---+ 2 linda account 6 Feb 20 20:03 /data/account
        getfacl /data/account
            # file: account
            # owner: linda
            # group: account
            user::rwx
            group::rwx
            group:sales:r-x
            mask::rwx
            other::---
    setfacl -m d:g:sales:rwx,d:g:account:rx /data/sales
    setfacl -m d:g:account:rwx,d:g:sales:rx /data/account
    touch /data/sales/newfile
    ls -la newfile
        -rw-rw----+ 1 root sales 0 Feb 20 21:19 newfile
    getfacl /data/sales/newfile
        # file: data/sales/newfile
        # owner: root
        # group: sales
        user::rw-
        group::rwx                      #effective:rw-
        group:sales:rwx                 #effective:rw-
        group:account:r-x               #effective:r--
        mask::rw-
        other::---
    mkdir newdir
    ls -ld /data/sales/newdir
        drwxrws---+ 2 root sales 6 Feb 20 21:52 /data/sales/newdir
    getfacl /data/sales/newdir
        # file: data/sales/newdir
        # owner: root
        # group: sales
        # flags: -s-
        user::rwx
        group::rwx
        group:sales:rwx
        group:account:r-x
        mask::rwx
        other::---
        default:user::rwx
        default:group::rwx
        default:group:sales:rwx
        default:group:account:r-x
        default:mask::rwx
        default:other::---
@@@

umask 666
    [files]
umask 777
    [directories]

man chattr
touch /root/fuzzy
chattr +i /root/fuzzy
ls -la /root/fuzzy
    -rw-r--r--. 1 root root 0 Feb 20 22:28 /root/fuzzy
lsattr /root/fuzzy
    ----i----------- /root/fuzzy
rm -rf /root/fuzzy
    rm: cannot remove ‘/root/fuzzy’: Operation not permitted
chattr -i /root/fuzzy
lsattr /root/fuzzy
    ---------------- /root/fuzzy
rm -rf /root/fuzzy
    [Success]

Review Questions
1. chown :<group> <file>
2. find / -user <user>
3. chmod -R 770 /data
4. chmod +x <file>
5. chmod g+s <directory>
6. chmod +t <directory>
7. setfacl -m g:sales:r *
8. setfact -R -m g:sales:rx <directory>; setfacl -R -m d:g:sales:rx <directory>
9. ##7 (027, etc.)
10. chattr +i myfile

@@@
@@@ Lab 7.1
@@@
    1.  mkdir -p /data/sales
        mkdir -p /data/account
        chown root:sales /data/sales
        chown root:account /data/account
    2.  chmod 770 /data/sales
        chmod 770 /data/account
        setfacl -R -m d:o::- /data
    3.  setfacl -m g:account:rx /data/sales
        setfacl -m g:sales:rx /data/account
        setfacl -m d:g:account:rx /data/sales
        setfacl -m d:g:sales:rx /data/account
    4.  chmod g+s /data/sales
        chmod g+s /data/account
    5.  chmod +t /data/sales
        chmod +t /data/account
@@@



8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8
8-8-8                                                   8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8
8-8-8    Chapter 8: Configuring Networking (26 pg.)     8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8
8-8-8                                                   8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8
8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8-8

Do I Know This Already?
D B C D A B C D A C

ip addr
    [Configure and monitor network addresses]
ip route
    [Configure and monitor routing information]
ip link
    [Configure and monitor network link state]

If interface is DOWN:
    ip link set dev enp0s3 up

@@@
@@@ Exercise 8.1 Validating Network Configuration
@@@
    Log in as root
        ip -s link
            1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN mode DEFAULT qlen 1
                link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
                RX: bytes  packets  errors  dropped overrun mcast
                52744      309      0       0       0       0
                TX: bytes  packets  errors  dropped carrier collsns
                52744      309      0       0       0       0
            2: enp0s3: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP mode DEFAULT qlen 1000
                link/ether 08:00:27:a9:50:a9 brd ff:ff:ff:ff:ff:ff
                RX: bytes  packets  errors  dropped overrun mcast
                28427114   35328    0       0       0       0
                TX: bytes  packets  errors  dropped carrier collsns
                1090323    17274    0       0       0       0

        ip link show
            1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN mode DEFAULT qlen 1
                link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
            2: enp0s3: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP mode DEFAULT qlen 1000
                link/ether 08:00:27:a9:50:a9 brd ff:ff:ff:ff:ff:ff

        ip addr show
            1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN qlen 1
                link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
                inet 127.0.0.1/8 scope host lo
                   valid_lft forever preferred_lft forever
                inet6 ::1/128 scope host
                   valid_lft forever preferred_lft forever
            2: enp0s3: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP qlen 1000
                link/ether 08:00:27:a9:50:a9 brd ff:ff:ff:ff:ff:ff
                inet 10.0.2.15/24 brd 10.0.2.255 scope global dynamic enp0s3
                    valid_lft 86252sec preferred_lft 86252sec
                inet6 fe80::8a70:e37:e28:ea25/64 scope link
                    valid_lft forever preferred_lft forever
@@@

ip route show
    default via 10.0.2.2 dev enp0s3  proto static  metric 100
    10.0.2.0/24 dev enp0s3  proto kernel  scope link  src 10.0.2.15  metric 100
    172.25.1.0/24 dev enp0s8  proto kernel  scope link  src 172.25.1.101  metric 100
    192.168.122.0/24 dev virbr0  proto kernel  scope link  src 192.168.122.1

Network ports and services
    netstat -uplant
        Active Internet connections (servers and established)
        Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name
        tcp        0      0 0.0.0.0:111             0.0.0.0:*               LISTEN      1/systemd
        tcp        0      0 192.168.122.1:53        0.0.0.0:*               LISTEN      2536/dnsmasq
        tcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN      1604/sshd
        tcp        0      0 127.0.0.1:631           0.0.0.0:*               LISTEN      1201/cupsd
        tcp        0      0 127.0.0.1:25            0.0.0.0:*               LISTEN      2398/master
        tcp        0      0 172.25.1.101:22         172.25.1.1:49537        ESTABLISHED 21572/sshd: ladmin
        tcp        0      0 172.25.1.101:22         172.25.1.1:62648        ESTABLISHED 13089/sshd: ladmin
        tcp        0      0 172.25.1.101:45628      172.25.1.103:389        ESTABLISHED 4860/nslcd
        ...
    -OR-
    ss -t
        State    Recv-Q    Send-Q    Local Address:Port    Peer Address:Port
        ESTAB    0         0         172.25.1.101:ssh      172.25.1.1:49537
        ESTAB    0         0         172.25.1.101:ssh      172.25.1.1:62648
        ESTAB    0         0         172.25.1.101:45628    172.25.1.103:ldap

@@@
@@@ Exercise 8.2 Verifying Network Settings
@@@
    ip addr show
    ip route show
    ping -c 4 8.8.8.8
    ip addr add 10.0.0.10/24 dev enp0s3
    ip addr show
        2: enp0s3: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP qlen 1000
            link/ether 08:00:27:a9:50:a9 brd ff:ff:ff:ff:ff:ff
            inet 10.0.2.15/24 brd 10.0.2.255 scope global dynamic enp0s3
               valid_lft 84532sec preferred_lft 84532sec
            inet 10.0.0.10/24 scope global enp0s3
               valid_lft forever preferred_lft forever
    ifconfig
        enp0s3: flags=4163<UP,BROADCAST,RUNNING,MULTICAST>  mtu 1500
            inet 10.0.2.15  netmask 255.255.255.0  broadcast 10.0.2.255
            inet6 fe80::8a70:e37:e28:ea25  prefixlen 64  scopeid 0x20<link>
            ether 08:00:27:a9:50:a9  txqueuelen 1000  (Ethernet)
        [Can't see newly added 10.0.0.10/24; don't use ifconfig]
    ss -tul
        Netid   State    Recv-Q   Send-Q   Local Address:Port    Peer Address:Port
        udp     UNCONN   0        0                    *:mdns               *:*
        udp     UNCONN   0        0                    *:58664              *:*
        udp     UNCONN   0        0            127.0.0.1:323                *:*
        udp     UNCONN   0        0                    *:44770              *:*
    ip addr del 10.0.0.10/24 dev enp0s3
        [Removes 10.0.0.10/24 from enp0s3]
@@@

systemctl status NetworkManager
    ● NetworkManager.service - Network Manager
       Loaded: loaded (/usr/lib/systemd/system/NetworkManager.service; enabled; vendor preset: enabled)
       Active: active (running) since Mon 2017-02-20 13:14:08 CET; 1 day 23h ago
         Docs: man:NetworkManager(8)
      Main PID: 820 (NetworkManager)
      ...

cd /etc/sysconfig/network-scripts
ls ifcfg-*
    ifcfg-enp0s3  ifcfg-lo

The 'ip' command is non-persistent. User 'nmtui' or 'nmcli' for persistent changes.

nmcli con show
    NAME                UUID                                  TYPE            DEVICE
    Wired connection 1  e2cf784c-5ce4-30a6-86af-a4ca2bc93eb3  802-3-ethernet  enp0s8
    enp0s3              f5dad1bf-ce1b-460e-99fd-f5e9ceb48360  802-3-ethernet  enp0s3
    virbr0              5c43228c-068c-4bbf-afd4-ca135d5ffff6  bridge          virbr0

nmcli con show 'Wired connection 1'
nmcli con show 'Wired connection 1' | tr -d ' '
nmcli con show 'Wired connection 1' | tr -d ' ' | cut -d':' -f2-10

nmcli con show 'Wired connection 1' | grep 'IP4.ADDRESS'
nmcli con show 'Wired connection 1' | grep 'IP4.ADDRESS' | tr -d ' '
nmcli con show 'Wired connection 1' | grep 'IP4.ADDRESS' | tr -d ' ' | cut -d':' -f2-10

nmcli dev status
    DEVICE      TYPE      STATE      CONNECTION
    virbr0      bridge    connected  virbr0
    enp0s3      ethernet  connected  enp0s3
    enp0s8      ethernet  connected  Wired connection 1
    lo          loopback  unmanaged  --
    virbr0-nic  tun       unmanaged  --

nmcli dev show enp0s8
    GENERAL.DEVICE:                         enp0s8
    GENERAL.TYPE:                           ethernet
    GENERAL.HWADDR:                         08:00:27:64:75:9C
    GENERAL.MTU:                            1500
    GENERAL.STATE:                          100 (connected)
    GENERAL.CONNECTION:                     Wired connection 1
    GENERAL.CON-PATH:                       /org/freedesktop/NetworkManager/ActiveConnection/5
    WIRED-PROPERTIES.CARRIER:               on
    IP4.ADDRESS[1]:                         172.25.1.101/24
    IP4.GATEWAY:
    IP6.ADDRESS[1]:                         fe80::7800:f963:db51:8583/64
    IP6.GATEWAY:

@@@
@@@ Exercise 8.3 Managing Network Connections with nmcli
@@@
    nmcli con add con-name "dhcp" type ethernet ifname enp0s3
        Connection 'dhcp' (cd925c78-c58b-4f18-9f68-b965c8fd18f1) successfully added.

    nmcli con add con-name "static" type ethernet ifname enp0s3 autoconnect no ip4 10.0.0.20/24 gw4 10.0.2.2
        Connection 'static' (7b4c3aa4-fd3a-4b72-a9a0-7dd98e1b3e87) successfully added.

    nmcli con show
        NAME                UUID                                  TYPE            DEVICE
        Wired connection 1  e2cf784c-5ce4-30a6-86af-a4ca2bc93eb3  802-3-ethernet  enp0s8
        enp0s3              f5dad1bf-ce1b-460e-99fd-f5e9ceb48360  802-3-ethernet  enp0s3
        virbr0              5c43228c-068c-4bbf-afd4-ca135d5ffff6  bridge          virbr0
        dhcp                da584d6b-b114-4553-88f8-9617abc72e48  802-3-ethernet  --
        static              54bf6aee-3d6e-495d-b379-fb69d61a5ca0  802-3-ethernet  --

    nmcli con down "enp0s3"
        Connection 'enp0s3' successfully deactivated (D-Bus active path: /org/freedesktop/NetworkManager/ActiveConnection/8)

    nmcli con up "static"
        Connection successfully activated (D-Bus active path: /org/freedesktop/NetworkManager/ActiveConnection/11)

    nmcli dev status
        DEVICE      TYPE      STATE      CONNECTION
        virbr0      bridge    connected  virbr0
        enp0s3      ethernet  connected  static
        enp0s8      ethernet  connected  Wired connection 1
        lo          loopback  unmanaged  --
        virbr0-nic  tun       unmanaged  --

    nmcli con delete static
        Connection 'static' (7b4c3aa4-fd3a-4b72-a9a0-7dd98e1b3e87) successfully deleted.

    nmcli con up "dhcp"
        Connection successfully activated (D-Bus active path: /org/freedesktop/NetworkManager/ActiveConnection/15)

    nmcli con up "enp0s3"
        Connection successfully activated (D-Bus active path: /org/freedesktop/NetworkManager/ActiveConnection/16)

    nmcli con down "dhcp"
        Connection 'dhcp' successfully deactivated (D-Bus active path: /org/freedesktop/NetworkManager/ActiveConnection/17)

    [enp0s3 remains up]

    nmcli con delete dhcp
        Connection 'dhcp' (cd925c78-c58b-4f18-9f68-b965c8fd18f1) successfully deleted.
@@@

@@@
@@@ Exercise 8.4 Changing Connection Parameters with nmcli
@@@
    nmcli con add con-name "dhcp" type ethernet ifname enp0s3
    nmcli con add con-name "static" type ethernet ifname enp0s3 autoconnect no ip4 10.0.0.20/24 gw4 10.0.2.2

    nmcli con mod "static" connection.autoconnect no
    nmcli con show "static" | grep connection.autoconnect:
        connection.autoconnect: no

    nmcli con mod "static" ipv4.dns 10.0.0.10
    nmcli con show "static" | grep ipv4.dns:
        ipv4.dns: 10.0.0.10
    nmcli con mod "static" +ipv4.dns 8.8.8.8
    nmcli con show "static" | grep ipv4.dns:
        ipv4.dns: 10.0.0.10,8.8.8.8

    nmcli con mod "static" ipv4.addresses "10.0.0.20/24" ip4 10.0.0.100/24
    nmcli con show "static" | grep ipv4.addresses:
        ipv4.addresses: 10.0.0.100/24

    nmcli con mod "static" +ipv4.addresses "10.20.30.40/16"
    nmcli con show "static" | grep ipv4.addresses:
        ipv4.addresses: 10.0.0.100/24, 10.20.30.40/16

    nmcli con up "static"
    nmcli dev status
        DEVICE      TYPE      STATE      CONNECTION
        virbr0      bridge    connected  virbr0
        enp0s3      ethernet  connected  static
        enp0s8      ethernet  connected  Wired connection 1
        lo          loopback  unmanaged  --
        virbr0-nic  tun       unmanaged  --
    nmcli con up enp0s3
@@@

man nmcli-examples

nmtui

cd /etc/sysconfig/network-scripts
ls ifcfg-*
    ifcfg-dhcp  ifcfg-enp0s3  ifcfg-lo  ifcfg-static  ifcfg-textgui

vi /etc/sysconfig/network-scripts/ifcfg-static
    BOOTPROTO=dhcp
    :wq
    [Adds a dynamic IP address to a configuration that already has a static IP; two IPs under one connection]

If editing an 'ifcfg-' file directly, activate the changes:
    nmcli con reload

hostnamectl set-hostname server1.local
hostnamectl status
   Static hostname: server1.local
         Icon name: computer-vm
           Chassis: vm
        Machine ID: b101d0db23e44e9f9a4be5f01ca6416e
           Boot ID: 4174f1b9ffbf41998daa2fa87bf1e7d6
    Virtualization: kvm
  Operating System: CentOS Linux 7 (Core)
       CPE OS Name: cpe:/o:centos:centos:7

            Kernel: Linux 3.10.0-514.6.1.el7.x86_64
      Architecture: x86-64

Four ways to set DNS:
    1. Use nmtui
    2. nmcli con mod <con-name> [+]ipv4.dns <ip-of-dns>
    3. Edit 'DNS1' and 'DNS2' in the /etc/sysconfig/network-scripts/ifcfg-* files
    4. Rely on DHCP

Two ways to ignore DNS from DHCP:
    1. nmcli con mod <con-name> ipv4.ignore-auto-dns yes
    2. Edit /etc/sysconfig/network-scripts/ifcfg-* files to include PEERDNS=no

Verify hostname resolution:
    getent hosts <hostname>
        [Checks both /etc/hosts and DNS to resolve the specified hostname]

DO NOT specify DNS in /etc/resolv.conf because it will be overwritten by NM!

Review Questions
1. 213.214.215.96
2. ip link [show]
3. NetworkManager
4. /etc/hostname
5. hostnamectl <hostname>
6. nmcli con reload
7. /etc/hosts
8. ip route [show]
9. systemctl status NetworkManager
10. nmcli con mod <con-name> ipv4.addresses "10.0.2.15/24" ip4 10.11.12.13/24

@@@
@@@ Lab 8.1a
@@@
    1.  server1 and server2:
            vi /etc/hosts
                192.168.222.100 server1a.example.com server1a
                192.168.222.110 server2a.example.com server2a
    2.  server1:
            nmcli device | grep -v -e "connected\ " -e "unmanaged" | cut -d' ' -f1
                DEVICE
                enp0s9
            nmcli con add con-name internal ifname enp0s9 type ethernet ip4 192.168.222.100/24
                Connection 'internal' (4ebc24b7-c465-4998-b025-afc96d941a64) successfully added.
            nmcli dev status
                DEVICE      TYPE      STATE      CONNECTION
                virbr0      bridge    connected  virbr0
                enp0s3      ethernet  connected  static
                enp0s8      ethernet  connected  Wired connection 1
                enp0s9      ethernet  connected  internal
                lo          loopback  unmanaged  --
                virbr0-nic  tun       unmanaged  --
            ip addr show | grep enp0s9: -A 5
                4: enp0s9: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP qlen 1000
                    link/ether 08:00:27:16:17:ff brd ff:ff:ff:ff:ff:ff
                    inet 192.168.222.100/24 brd 192.168.222.255 scope global enp0s9
                       valid_lft forever preferred_lft forever
                    inet6 fe80::b19e:83ca:bb35:93d5/64 scope link
                       valid_lft forever preferred_lft forever
        server2:
            nmcli device | grep -v -e "connected\ " -e "unmanaged" | cut -d' ' -f1
                DEVICE
                enp0s9
            nmcli con add con-name internal ifname enp0s9 type ethernet ip4 192.168.222.110/24
                Connection 'internal' (6687939a-c8a7-45b8-86a9-62f3235bf3ae) successfully added.
            nmcli dev status
                DEVICE      TYPE      STATE      CONNECTION
                virbr0      bridge    connected  virbr0
                enp0s3      ethernet  connected  enp0s3
                enp0s8      ethernet  connected  Wired connection 1
                enp0s9      ethernet  connected  internal
                lo          loopback  unmanaged  --
                virbr0-nic  tun       unmanaged  --
            ip addr show | grep enp0s9: -A 5
                4: enp0s9: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP qlen 1000
                    link/ether 08:00:27:a9:1c:64 brd ff:ff:ff:ff:ff:ff
                    inet 192.168.222.110/24 brd 192.168.222.255 scope global enp0s9
                       valid_lft forever preferred_lft forever
                    inet6 fe80::cb5d:8cb3:a148:9d6f/64 scope link
                       valid_lft forever preferred_lft forever
    3.  server1:
            ping 192.168.222.110
            ping server2a.example.com
            ping server2a
        server2:
            ping 192.168.222.100
            ping server1a.example.com
            ping server1a
    4.  server1:
            vi /etc/sysconfig/network-scripts/ifcfg-internal
                BOOTPROTO=dhcp
            nmcli con show internal
        server2:
            vi /etc/sysconfig/network-scripts/ifcfg-internal
                BOOTPROTO=dhcp
            nmcli con show internal
@@@

@@@
@@@ Lab 8.1b
@@@
    1.  server1 and server2:
            vi /etc/hosts
                10.11.12.100 server1b.example.com server1b
                10.11.12.110 server2b.example.com server2b
    2.  server1:
            nmcli device | grep 'Wired'
                DEVICE
                enp0s10
            nmcli con mod 'Wired connection 2' ipv4.addresses 10.11.12.100/24
            nmcli con mod 'Wired connection 2' connection.id 'NatNet'
            mv /etc/sysconfig/network-scripts/ifcfg-Wired_connection_2 /etc/sysconfig/network-scripts/ifcfg-NatNet
            nmcli con show
                NAME                UUID                                  TYPE            DEVICE
                NatNet              6e0b382b-02ac-3325-9d01-21354311a424  802-3-ethernet  enp0s10
                Wired connection 1  e2cf784c-5ce4-30a6-86af-a4ca2bc93eb3  802-3-ethernet  enp0s8
                internal            81ea4bba-eae9-464f-a9f6-2dd6cc83f689  802-3-ethernet  enp0s9
                static              ac3a5276-d197-4d25-a87f-90ff73550c3f  802-3-ethernet  enp0s3
                virbr0              2e7d796b-5100-4580-9f28-2bcff5ebd0df  bridge          virbr0
                dhcp                d0ad6209-37c2-4710-a8a7-6b27dfdd19b9  802-3-ethernet  --
                enp0s3              f5dad1bf-ce1b-460e-99fd-f5e9ceb48360  802-3-ethernet  --
                textgui             a2f2e11e-ce73-4934-a609-2a7d2c632637  802-3-ethernet  --
            nmcli con down NatNet
                Connection 'NatNet' successfully deactivated (D-Bus active path: /org/freedesktop/NetworkManager/ActiveConnection/3)
            nmcli con up NatNet
                Connection successfully activated (D-Bus active path: /org/freedesktop/NetworkManager/ActiveConnection/35)
            ip addr show | grep enp0s10: -A 7
                5: enp0s10: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP qlen 1000
                    link/ether 08:00:27:6f:be:6b brd ff:ff:ff:ff:ff:ff
                    inet 10.11.12.100/24 brd 10.11.12.255 scope global enp0s10
                       valid_lft forever preferred_lft forever
                    inet 10.11.12.5/24 brd 10.11.12.255 scope global secondary dynamic enp0s10
                       valid_lft 1187sec preferred_lft 1187sec
                    inet6 fe80::4dc9:848e:b489:5ac9/64 scope link
                       valid_lft forever preferred_lft forever
        server2:
            nmcli device | grep 'Wired'
                DEVICE
                enp0s10
            nmcli con mod 'Wired connection 2' ipv4.addresses 10.11.12.110/24
            nmcli con mod 'Wired connection 2' connection.id 'NatNet'
            mv /etc/sysconfig/network-scripts/ifcfg-Wired_connection_2 /etc/sysconfig/network-scripts/ifcfg-NatNet
            nmcli con show
                NAME                UUID                                  TYPE            DEVICE
                NatNet              8b0670ea-c091-3be2-bd18-38b5546162d7  802-3-ethernet  enp0s10
                Wired connection 1  7842047d-a6b4-38c5-9bcb-3afa4971a615  802-3-ethernet  enp0s8
                enp0s3              1c3dc7e0-d3cb-4b99-b956-ab4a351776b7  802-3-ethernet  enp0s3
                internal            6687939a-c8a7-45b8-86a9-62f3235bf3ae  802-3-ethernet  enp0s9
                virbr0              2c4ade77-504f-49c7-b6c3-33aafb14b368  bridge          virbr0
            nmcli con down NatNet
                Connection 'NatNet' successfully deactivated (D-Bus active path: /org/freedesktop/NetworkManager/ActiveConnection/3)
            nmcli con up NatNet
                Connection successfully activated (D-Bus active path: /org/freedesktop/NetworkManager/ActiveConnection/35)
            ip addr show | grep enp0s10: -A 7
                5: enp0s10: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP qlen 1000
                link/ether 08:00:27:5c:e9:b6 brd ff:ff:ff:ff:ff:ff
                inet 10.11.12.110/24 brd 10.11.12.255 scope global enp0s10
                   valid_lft forever preferred_lft forever
                inet 10.11.12.4/24 brd 10.11.12.255 scope global secondary dynamic enp0s10
                   valid_lft 1198sec preferred_lft 1198sec
                inet6 fe80::d70c:8a20:e89c:a105/64 scope link
                   valid_lft forever preferred_lft forever
    3.  server1:
            ping 10.11.12.110
            ping server2b.example.com
            ping server2b
        server2:
            ping 10.11.12.100
            ping server1b.example.com
            ping server1b
    4.  server1:
            nmcli con show NatNet
        server2:
            nmcli con show NatNet
@@@



# # # # # # # # # # # # # # # # # # # # #
#                                       #
#  Part 1-2: Operating Running Systems  #
#                                       #
# # # # # # # # # # # # # # # # # # # # #


9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9
9-9-9                                               9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9
9-9-9    Chapter 9: Managing Processes (18 pg.)     9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9
9-9-9                                               9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9
9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9-9

Do I Know This Already?
B&D B A A&B A C C B A A

@@@
@@@ Exercise 9.1 Managing jobs
@@@
    sleep 3600 &
    dd if=/dev/zero of=/dev/null &
    sleep 7200
    Ctrl+Z
    jobs
        [1]   Running                 sleep 3600 &
        [2]-  Running                 dd if=/dev/zero of=/dev/null &
        [3]+  Stopped                 sleep 7200
    bg 3
        [Sends job 3 to the background]
    fg 1
        [Moves job 1 to the foreground]
    Ctrl+C
    jobs
        [2]-  Running                 dd if=/dev/zero of=/dev/null &
        [3]+  Running                 sleep 7200 &
    fg 2
    Ctrl+C
    fg 3
    Ctrl+C
    jobs
        [None]
    [Open second terminal]
        dd if=/dev/zero of=/dev/null &
        exit
    [Return to original server]
        top
        k
            [kill the dd job]
@@@

Still use '<command> &' to start a process in the bg, but no longer need 'nohup' in front.

Kernel threads are within [] in the output of 'ps aux'; can't manage or kill them.

ps
    [Processes started by the current user]

ps aux
    [Summary of all active processes]

ps -ef
    [Less info but includes PPID with PID]

ps fax
    [Shows parent/child process hierarchy]

pgrep <string>
    [Returns PIDs of all processes with <string> in the name]
pgrep dnsmasq
    2659
    2661

Priority ranges from 0 (highest priority) to 39 (lowest priority); default is 20.

Setting process priority using 'niceness' adjustment (-20 to 19; lower number is higher priority, because it's less 'nice'):
    nice -n <niceness> <process>
        [Start a process with adjusted priority]
    renice -n <niceness> -p <process-pid>
        [Adjust the priority of an active process]
    top -> r
        [Adjust the priority of the selected process]

nice -n 5 dd if=/dev/zero of=/dev/null &
ps aux | grep 'dd if'
    5441
renice -n 10 -p 5441
    5441 (process ID) old priority 5, new priority 10

Regular users can decrease priority; only root can increase priority.

Signals:
    SIGTERM (15)
        [Asks a process to stop]
    SIGKILL (9)
        [Forces a process to stop]
    SIGHUP (1)
        [Hang up; forces a process to re-read its config files]

kill -l
    1) SIGHUP       2) SIGINT       3) SIGQUIT      4) SIGILL       5) SIGTRAP
    6) SIGABRT      7) SIGBUS       8) SIGFPE       9) SIGKILL      10) SIGUSR1
    11) SIGSEGV     12) SIGUSR2     13) SIGPIPE     14) SIGALRM     15) SIGTERM
    16) SIGSTKFLT   17) SIGCHLD     18) SIGCONT     19) SIGSTOP     20) SIGTSTP
    21) SIGTTIN     22) SIGTTOU     23) SIGURG      24) SIGXCPU     25) SIGXFSZ
    26) SIGVTALRM   27) SIGPROF     28) SIGWINCH    29) SIGIO       30) SIGPWR
    31) SIGSYS      34) SIGRTMIN    35) SIGRTMIN+1  36) SIGRTMIN+2  37) SIGRTMIN+3
    38) SIGRTMIN+4  39) SIGRTMIN+5  40) SIGRTMIN+6  41) SIGRTMIN+7  42) SIGRTMIN+8
    43) SIGRTMIN+9  44) SIGRTMIN+10 45) SIGRTMIN+11 46) SIGRTMIN+12 47) SIGRTMIN+13
    48) SIGRTMIN+14 49) SIGRTMIN+15 50) SIGRTMAX-14 51) SIGRTMAX-13 52) SIGRTMAX-12
    53) SIGRTMAX-11 54) SIGRTMAX-10 55) SIGRTMAX-9  56) SIGRTMAX-8  57) SIGRTMAX-7
    58) SIGRTMAX-6  59) SIGRTMAX-5  60) SIGRTMAX-4  61) SIGRTMAX-3  62) SIGRTMAX-2
    63) SIGRTMAX-1  64) SIGRTMAX

kill -##
    e.g. kill -9

pkill <process-name>
    [Sends a signal to processes based on PATTERN MATCHING on a name instead of using a PID; kills everything it matches]

killall <process-name>
    [Kills all processes with the same EXACT name; safer than pkill]

@@@
@@@ Exercise 9.2 Managing Processes from the Command Line
@@@
    dd if=/dev/zero of=/dev/null &
    dd if=/dev/zero of=/dev/null &
    dd if=/dev/zero of=/dev/null &
    ps aux | grep dd | tail -n 4 | head -n 3
        root      5687 35.9  0.0 107940   596 pts/0    R    13:51   0:14 dd if=/dev/zero of=/dev/null
        root      5688 33.8  0.0 107940   592 pts/0    R    13:51   0:12 dd if=/dev/zero of=/dev/null
        root      5689 33.1  0.0 107940   592 pts/0    R    13:51   0:12 dd if=/dev/zero of=/dev/null
    renice -n 5 5687
        5687 (process ID) old priority 0, new priority 5
    ps fax | grep -B6 dd
        1400 ?        Ss     0:00 /usr/sbin/sshd
        3059 ?        Ss     0:00  \_ sshd: ladmin [priv]
        3064 ?        S      0:00      \_ sshd: ladmin@pts/0
        3066 pts/0    Ss     0:00          \_ -bash
        3116 pts/0    S      0:00              \_ sudo -i
        3117 pts/0    S      0:00                  \_ -bash
        5687 pts/0    RN     0:34                      \_ dd if=/dev/zero of=/dev/null
        5688 pts/0    R      0:54                      \_ dd if=/dev/zero of=/dev/null
        5689 pts/0    R      0:54                      \_ dd if=/dev/zero of=/dev/null
        5725 pts/0    R+     0:00                      \_ ps fax
        5726 pts/0    S+     0:00                      \_ grep --color=auto -B6 dd
    kill -9 3117
        [Killing bash doesn't actually kill the 'dd' process as was expected]
        [Orphaned processes (those whose parents are killed) are adopted by init (PID=0)]
@@@

top
    k
        <PID>
            <SIGNAL> (default is 15)

top
    r
        <PID>
            <niceness>

[top commands to execute]
    ? - Show all available commands
    f - Add columns and change default sort column
    x - Highlight sort column
    y - Highlight running tasks
    R - Reverses the sort
    C - Show scroll coordinates
    E - Toggle summary memory scale
    e - Toggle task memory scale
    z - Turn on colors
        Z - change colors
            S2 M2 H7 T6
    m - Toggle memory display (numbers vs. graphs)
    u - Toggle user
    W - Write settings as default

Review Questions
1. jobs
2. Ctrl+Z -> bg
3. Ctrl+C
4. pidof <process-name> -> kill [-9] <PID>
5. ps fax
6. renice -n <niceness> -p 1234
7. killall dd
8. kill mycommand
9. k
10. nice -n -5 <command>

@@@
@@@ Lab 9.1
@@@
    1.  dd if=/dev/zero of=/dev/null &
            [1] 7490
        dd if=/dev/zero of=/dev/null &
            [2] 7491
        dd if=/dev/zero of=/dev/null &
            [3] 7500
        dd if=/dev/zero of=/dev/null &
            [4] 7523

        jobs
            [1]   Running                 dd if=/dev/zero of=/dev/null &
            [2]   Running                 dd if=/dev/zero of=/dev/null &
            [3]-  Running                 dd if=/dev/zero of=/dev/null &
            [4]+  Running                 dd if=/dev/zero of=/dev/null &

        fg
            dd if=/dev/zero of=/dev/null
        Ctrl+C
            9402544+0 records in
            9402543+0 records out
            4814102016 bytes (4.8 GB) copied, 17.4815 s, 275 MB/s

    2.  jobs
            [1]   Running                 dd if=/dev/zero of=/dev/null &
            [2]-  Running                 dd if=/dev/zero of=/dev/null &
            [3]+  Running                 dd if=/dev/zero of=/dev/null &

        top
            PID USER      PR  NI    VIRT    RES    SHR S %CPU %MEM     TIME+ COMMAND
            7491 root      20   0  107940    596    504 R 33.6  0.0   0:58.17 dd
            7490 root      20   0  107940    596    504 R 33.2  0.0   1:06.82 dd
            7500 root      20   0  107940    592    504 R 33.2  0.0   0:50.82 dd

        renice -n -5 -p 7491
            7491 (process ID) old priority 0, new priority -5

        top
            PID USER      PR  NI    VIRT    RES    SHR S %CPU %MEM     TIME+ COMMAND
            7491 root      15  -5  107940    596    504 R 60.3  0.0   1:22.43 dd
            7500 root      20   0  107940    592    504 R 19.9  0.0   1:07.42 dd
            7490 root      20   0  107940    596    504 R 19.5  0.0   1:23.41 dd

        renice -n -15 -p 7491
            7491 (process ID) old priority -5, new priority -15

        top
            PID USER      PR  NI    VIRT    RES    SHR S %CPU %MEM     TIME+ COMMAND
            7491 root       5 -15  107940    596    504 R 93.1  0.0   2:11.03 dd
            7490 root      20   0  107940    596    504 R  3.3  0.0   1:33.43 dd
            7500 root      20   0  107940    592    504 R  3.0  0.0   1:17.42 dd

    3.  killall dd
@@@



10-10-10-10-10-10-10-10-10-10-10-10-10-10-10-10-10-10-10-10-10-10-10-10-10-10-10-10-10-10-10-10-10-10-10-10-10-10-10-10-10-10
10-10                                                          10-10-10-10-10-10-10-10-10-10-10-10-10-10-10-10-10-10-10-10-10
10-10    Chapter 10: Working with Virtual Machines (23 pg.)    10-10-10-10-10-10-10-10-10-10-10-10-10-10-10-10-10-10-10-10-10
10-10                                                          10-10-10-10-10-10-10-10-10-10-10-10-10-10-10-10-10-10-10-10-10
10-10-10-10-10-10-10-10-10-10-10-10-10-10-10-10-10-10-10-10-10-10-10-10-10-10-10-10-10-10-10-10-10-10-10-10-10-10-10-10-10-10

Do I Know This Already?
B B A C&D A C D C C D

@@@
@@@ Exercise 10.1 Setting Up Your Server as a KVM Hypervisor Host
@@@
    Host Requirements:
        arch
            x86_64
        uname -i
            x86_64
        cat /proc/cpuinfo | grep -E 'svm|vmx'
            vmx

        lscpu
            Architecture:          x86_64
            CPU op-mode(s):        32-bit, 64-bit
            Byte Order:            Little Endian
            CPU(s):                4
            On-line CPU(s) list:   0-3
            Thread(s) per core:    1
            Core(s) per socket:    1
            Socket(s):             4
            NUMA node(s):          1
            Vendor ID:             GenuineIntel
            CPU family:            6
            Model:                 42
            Model name:            Intel(R) Core(TM) i7-2720QM CPU @ 2.20GHz
            Stepping:              7
            CPU MHz:               2199.131
            BogoMIPS:              4400.21
            Virtualization:        VT-x
            Hypervisor vendor:     VMware
            Virtualization type:   full
            L1d cache:             32K
            L1i cache:             32K
            L2 cache:              256K
            L3 cache:              6144K
            NUMA node0 CPU(s):     0-3

    yum grouplist
        Available Environment Groups:
            Minimal Install
            ...
            Virtualization Host
            Server with GUI
            ...
        Available Groups:
            CIFS file server
            ...
            Eclipse
            NFS file server
            ...
        Done

    yum groupinstall "Virtualization Host"
@@@

brctl show
    bridge name     bridge id               STP enabled     interfaces
    virbr0          8000.525400c397cf       yes             virbr0-nic

@@@
@@@ Exercise 10.2 Installing a Virtual Machine
@@@
    lsmod | grep kvm
        kvm_intel             170181  0
        kvm                   554609  1 kvm_intel
        [If no output: 'modprobe kvm']

    systemctl status libvirtd
        ● libvirtd.service - Virtualization daemon
           Loaded: loaded (/usr/lib/systemd/system/libvirtd.service; enabled; vendor preset: enabled)
           Active: active (running) since Fri 2017-02-24 14:19:09 CET; 17min ago
             Docs: man:libvirtd(8)
                   http://libvirt.org
         Main PID: 1352 (libvirtd)
           CGroup: /system.slice/libvirtd.service
                   ├─1352 /usr/sbin/libvirtd
                   ├─2685 /sbin/dnsmasq --conf-file=/var/lib/libvirt/dnsmasq/default.conf --leasefile-ro --dh...
                   └─2687 /sbin/dnsmasq --conf-file=/var/lib/libvirt/dnsmasq/default.conf --leasefile-ro --dh...

    df -h
        Filesystem           Size  Used Avail Use% Mounted on
        /dev/mapper/cl-root   17G  8.3G  8.8G  49% /
        devtmpfs             897M     0  897M   0% /dev
        tmpfs                912M  152K  912M   1% /dev/shm
        tmpfs                912M  9.0M  903M   1% /run
        tmpfs                912M     0  912M   0% /sys/fs/cgroup
        /dev/sda1           1014M  229M  786M  23% /boot
        tmpfs                183M   20K  183M   1% /run/user/1000

    yum install virt-manager

    virt-manager &
        [Starts 'Virtual Machine Manager' GUI]
        File -> New Virtual Machine
            [Follow the prompts]

    The VM virtual disk is stored in:
        /var/lib/libvirt/images
        [In production, LVM is often used instead of disk image files.]

    The VM configuration file is:
        /etc/libvirt/qemu/<vm-name>.xml
@@@

On new KVM-hosted VM:
    grubby --update-kernel=ALL --args=“console=ttyS0”
        [Sends VM output to the serial console]
    reboot

On KVM host:
    virsh list
        Id    Name                           State
        ----------------------------------------------------
        4     smallvm1                       running

    virsh list --all
        Id    Name                           State
        ----------------------------------------------------
        4     smallvm1                       running
        -     smallvm2                       shut off

    virsh console smallvm1
        Connected to domain smallvm1
        Escape character is ^]

        CentOS Linux 7 (Core)
        Kernel 3.10.0-514.6.2.el7.x86_64 on an x86_64

        smallvm1 login:

    top
        PID USER      PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND
        4127 qemu      20   0 1501640 979456   2812 S   1.3 52.5   9:42.70 qemu-kvm
        3392 ladmin    20   0 2139452 341752  17108 S   5.6 18.3   7:05.52 gnome-shell

Autostart VM on KVM host boot:
    virsh autostart smallvm1
    virsh autostart --disable smallvm1

qemu-img create -f qcow2 smallvm2.qcow2 4G

virt-install --hvm --name smallvm2 --memory 768 --vcpus 2 --disk /var/lib/libvirt/images/smallvm2.qcow2,size=4 --cdrom /root/CentOS-7-x86_64-DVD-1611.iso --graphics none

Review Questions
1. kvm, kvm_intel (Intel) or kvm_amd (AMD)
2. vmx
3. Left Ctrl+Alt
4. uname -r; arch
5. cat /proc/cpuinfo; lscpu
6. virt-manager &
7. libvirtd
8. /var/lib/libvirt/images
9. virsh list --all
10. virsh destroy vm1

@@@
@@@ Lab 10.1
@@@
    1.  [Set up a server as a hypervisor host; VirtualBox not supported -- using VMware Fusion]
    2.  [Install a KVM virtual machine]
            Via the GUI:
                virt-manager &
            Via the CL:
                virt-install
@@@



11-11-11-11-11-11-11-11-11-11-11-11-11-11-11-11-11-11-11-11-11-11-11-11-11-11-11-11-11-11-11-11-11-11-11-11-11-11-11-11-11-11
11-11                                              11-11-11-11-11-11-11-11-11-11-11-11-11-11-11-11-11-11-11-11-11-11-11-11-11
11-11    Chapter 11: Managing Software (30 pg.)    11-11-11-11-11-11-11-11-11-11-11-11-11-11-11-11-11-11-11-11-11-11-11-11-11
11-11                                              11-11-11-11-11-11-11-11-11-11-11-11-11-11-11-11-11-11-11-11-11-11-11-11-11
11-11-11-11-11-11-11-11-11-11-11-11-11-11-11-11-11-11-11-11-11-11-11-11-11-11-11-11-11-11-11-11-11-11-11-11-11-11-11-11-11-11

Do I Know This Already?
D B C D D C D A C C

Repo file must contain:
    [<repo-label>]
    name=<repo-name>
    baseurl=<http://, ftp://, file:///>

Repo file may contain:
    mirrorlist=<http://>
    gpgcheck=<0,1>
    gpgkey=<file:///>
    enabled=<0,1>

Default repo labels:
    base
    optional
    updates
    supplementary
    extras

Repo files are stored in /etc/yum.repos.d

GPG keys are stored in /etc/pki/rpm-gpg

@@@
@@@ Exercise 11.1 Creating Your Own Repository
@@@
    mount -o loop /root/CentOS-7-x86_64-DVD-1611.iso /mnt
    mkdir /repo
    cp /mnt/Packages/* /repo
    yum install createrepo
    createrepo /repo
        Spawning worker 0 with 958 pkgs
        Spawning worker 1 with 958 pkgs
        Spawning worker 2 with 958 pkgs
        Spawning worker 3 with 957 pkgs
        Workers Finished
        Saving Primary metadata
        Saving file lists metadata
        Saving other metadata
        Generating sqlite DBs
        Sqlite DBs complete
    cd /etc/yum.repos.d
    vi /etc/yum.repos.d/my.repo
        [myrepo]
        name=thisismyrepo
        baseurl=file:///repo
        :wq
    yum repolist
        repo id             repo name             status
        base/7/x86_64       CentOS-7 - Base       9363
        extras/7/x86_64     CentOS-7 - Extras      264
        myrepo              thisismyrepo          3831
        updates/7/x86_64    CentOS-7 - Updates     856
        repolist: 14314
@@@

ls -l /repo | awk '{print $9}' | tail -n +2 | tee > myrepo_ISO.txt
cat myrepo_ISO.txt | sort | tee > myrepo_ISO_sorted.txt
cat myrepo_ISO_sorted.txt | wc -l
    3833
grep 'myrepo_ISO_sorted.txt' -v -e ".rpm$"
    [Extra file "TRANS.TBL"]
    [Extra file "repodata"]
grep 'myrepo_ISO_sorted.txt' -e ".rpm$" | wc -l
    3831
[Remove the two extra files]
cat myrepo_ISO_sorted.txt | wc -l
    3831

yum repolist | grep 'myrepo'
    myrepo   myrepo   3831

yum --disablerepo="*" --enablerepo="myrepo" list all | tail -n +4 | tee > myrepo_all.txt
cat myrepo_all.txt | wc -l
    3883 (three columns, with spillover lines)

cat myrepo_all_anaconda.txt | awk '{print $1}' | tee > myrepo_all_anaconda_clean.txt
cat myrepo_all_anaconda_clean.txt | wc -l
    1281 (one column)

cat myrepo_all_myrepo.txt | awk '{print $1}' | tee > myrepo_all_myrepo_clean.txt
cat myrepo_all_myrepo_clean.txt | wc -l
    2551 (one column)

1281+2551=3832 (1 extra)

cat myrepo_all_anaconda_clean.txt > myrepo_all_rebuild.txt
cat myrepo_all_myrepo_clean.txt >> myrepo_all_rebuild.txt
cat myrepo_all_rebuild.txt | sort | tee > myrepo_all_rebuild_sorted.txt
cat myrepo_all_rebuild_sorted.txt | wc -l
    3832

Compare:
    myrepo_ISO_sorted.txt (3831)
    myrepo_all_rebuild_sorted.txt (3832)

cat myrepo_ISO_sorted.txt | cut -c-6 | tee > myrepo_ISO_sorted_cut.txt
cat myrepo_all_rebuild_sorted.txt | cut -c-6 | tee > myrepo_all_rebuild_sorted_cut.txt

diff myrepo_all_rebuild_sorted_cut.txt myrepo_ISO_sorted_cut.txt | less
    *kernel*

yum --disablerepo="*" --enablerepo="myrepo" list available | tail -n +4 | tee > myrepo_avail.txt
cat myrepo_avail.txt | grep -v -e "^ " | awk '{print $1}' | tee > myrepo_avail_clean.txt
cat myrepo_avail_clean.txt | wc -l
    2551

Download RPMs as files (with dependencies):
    yumdownloader nmap /root

yum commands:
    yum search nmap
        nmap-frontend.noarch : The GTK+ front end for nmap
        nmap-ncat.x86_64 : Nmap's Netcat replacement
        nmap.x86_64 : Network exploration tool and security scanner
    yum provides */traceroute
        3:traceroute-2.0.22-2.el7.x86_64 : Traces the route taken by packets over an IPv4/IPv6 network
        Repo        : base
        Matched from:
        Filename    : /bin/traceroute
        Filename    : /usr/bin/traceroute
    yum info rsync
        Installed Packages
        Name        : rsync
        Arch        : x86_64
        Version     : 3.0.9
        Release     : 17.el7
        Size        : 732 k
        Repo        : installed
        From repo   : anaconda
        Summary     : A program for synchronizing files over a network
        URL         : http://rsync.samba.org/
        License     : GPLv3+
        Description : Rsync uses a reliable algorithm to bring remote and host files into
                    : sync very quickly. Rsync is fast because it just sends the differences
                    : in the files over the network instead of sending the complete
                    : files. Rsync is often used as a very powerful mirroring process or
                    : just as a more capable replacement for the rcp command. A technical
                    : report which describes the rsync algorithm is included in this
                    : package.
    yum install <package>
    yum remove <package>
    yum list [all | installed]
    yum group list [hidden]
    yum group install "<group>"
    yum update
    yum clean all

yum list kernel
    Installed Packages
    kernel.x86_64   3.10.0-514.el7       @anaconda
    kernel.x86_64   3.10.0-514.6.2.el7   @updates

yum group info "Basic Web Server"
    Environment Group: Basic Web Server
     Environment-Id: web-server-environment
     Description: Server for serving static and dynamic internet content.
     Mandatory Groups:
        base
        core
       +web-server
     Optional Groups:
       +backup-client
       +debugging
       +directory-client
       ...

yum history
    ID     | Login user               | Date and time    | Action(s)      | Altered
    -------------------------------------------------------------------------------
        12 | ladmin <ladmin>          | 2017-02-25 15:09 | Install        |   51
        11 | ladmin <ladmin>          | 2017-02-25 15:07 | Install        |    9
        10 | ladmin <ladmin>          | 2017-02-24 18:22 | Install        |    1
         9 | ladmin <ladmin>          | 2017-02-24 16:01 | Install        |    1
         8 | ladmin <ladmin>          | 2017-02-24 14:40 | Install        |    6
         7 | ladmin <ladmin>          | 2017-02-24 13:58 | Erase          |    2
         6 | ladmin <ladmin>          | 2017-02-24 13:57 | Install        |    5
         5 | ladmin <ladmin>          | 2017-02-24 13:55 | Install        |    1
         4 | ladmin <ladmin>          | 2017-02-24 13:55 | Install        |    1
         3 | ladmin <ladmin>          | 2017-02-24 13:13 | Install        |   10
         2 | ladmin <ladmin>          | 2017-02-24 13:04 | I, U           |  108 EE
         1 | System <unset>           | 2017-02-24 12:37 | Install        | 1257

vi /var/log/yum.log

yum history undo 12
yum groups mark remove directory-client
    Marked remove: directory-client

@@@
@@@ Exercise 11.2 Using yum for Package Management
@@@
    yum repolist
        repo id             repo name             status
        base/7/x86_64       CentOS-7 - Base       9363
        extras/7/x86_64     CentOS-7 - Extras      264
        myrepo              myrepo                3831
        updates/7/x86_64    CentOS-7 - Updates     856
        repolist: 14314
    yum search xeyes
        Warning: No matches found for: xeyes
        No matches found
    yum provides */xeyes
        xorg-x11-apps-7.7-6.el7.x86_64 : X.Org X11 applications
        Repo        : base
        Matched from:
        Filename    : /usr/bin/xeyes
    yum install xorg-x11-apps -y
        Complete!
    yum list xorg-x11-apps
        Installed Packages
        xorg-x11-apps.x86_64    7.7-6.el7    @base
    yum history
        ID     | Login user               | Date and time    | Action(s)      | Altered
        -------------------------------------------------------------------------------
            14 | ladmin <ladmin>          | 2017-02-25 15:19 | Install        |    2
            ...
    yum history undo 14 -y
        Complete!
    yum list xorg-x11-apps
        Available Packages
        xorg-x11-apps.x86_64    7.7-6.el7    @base
@@@

RPM package installation commands:
    rpm -ivh <package-filename>
        [Installs the package if not already present]
            rpm -ivh nmap-6.40-7.el7.x86_64.rpm
                Preparing...                          ################################# [100%]
                Updating / installing...
                1:nmap-2:6.40-7.el7                ################################# [100%]
    rpm -Uvh <package-filename>
        [Installs the package, and upgrades if already present]
            rpm -Uvh nmap-6.40-7.el7.x86_64.rpm
                Preparing...                          ################################# [100%]
                package nmap-2:6.40-7.el7.x86_64 is already installed

RPM package selection commands (queries RPM database):
    rpm -qa
        [Query all installed packages]
            rpm -qa | wc -l
                1291
    rpm -qf <file-name>
        [Query package owning <file-name>]
            rpm -qf /bin/ls
                coreutils-8.22-18.el7.x86_64
    rpm -qg <group-name>
        [Query packages with the group of <group-name>]
            rpm -qg "System Environment/Daemons"
                libtdb-1.3.8-1.el7_2.x86_64
                libtalloc-2.1.6-1.el7.x86_64
                libtevent-0.9.28-1.el7.x86_64
                ...

RPM package query commands (queries RPM database):
    rpm -qc <package-name>
        [List only configuration files]
            rpm -qc openldap
                /etc/openldap/ldap.conf
    rpm -qd <package-name>
        [List only documentation files]
            rpm -qd openldap
                /usr/share/doc/openldap-2.4.40/ANNOUNCEMENT
                /usr/share/doc/openldap-2.4.40/CHANGES
                ...
    rpm -qi <package-name>
        [Display package information, including name, version, and description]
            rpm -qi openldap
                [Lots of info; similar to 'yum info openldap', but not exact]
    rpm -ql <package-name>
        [List files in package]
            rpm -ql openldap
                /etc/openldap
                /etc/openldap/certs
                /etc/openldap/ldap.conf
                /usr/lib64/liblber-2.4.so.2
                ...
    rpm -qR <package-name>
        [List package dependencies]
            rpm -qR openldap
                [Lots of binaries]

RPM package query commands (queries RPM file):
    rpm -qpc <package-filename>
        [List only configuration files]
            rpm -qpc /repo/openldap-2.4.40-13.el7.x86_64.rpm
                /etc/openldap/ldap.conf
    rpm -qpd <package-filename>
        [List only documentation files]
            rpm -qpd /repo/openldap-2.4.40-13.el7.x86_64.rpm
                /usr/share/doc/openldap-2.4.40/ANNOUNCEMENT
                /usr/share/doc/openldap-2.4.40/CHANGES
                ...
    rpm -qpi <package-filename>
        [Display package information, including name, version, and description]
            rpm -qpi /repo/openldap-2.4.40-13.el7.x86_64.rpm
                [Lots of info; similar to 'yum info openldap', but not exact]
    rpm -qpl <package-filename>
        [List files in package]
            rpm -qpl /repo/openldap-2.4.40-13.el7.x86_64.rpm
                /etc/openldap
                /etc/openldap/certs
                /etc/openldap/ldap.conf
                /usr/lib64/liblber-2.4.so.2
                ...
    rpm -qp --scripts <package-filename>
        [Check which scripts a package file contains]
            rpm -qp --scripts /repo/openldap-2.4.40-13.el7.x86_64.rpm
                [Prints the script(s) content to the screen]
    rpm -qpR <package-filename>
        [List package dependencies]
            rpm -qpR /repo/openldap-2.4.40-13.el7.x86_64.rpm
                [Lots of binaries]

yum install yum-utils
rpm -qi kubernetes-unit-test
    package kubernetes-unit-test is not installed
repoquery -i kubernetes-unit-test
    Name        : kubernetes-unit-test
    Version     : 1.4.0
    Release     : 0.1.git87d9d8d.el7
    ...

@@@
@@@ Exercise 11.3 Using RPM Queries
@@@
    which dnsmasq
        /sbin/dnsmasq
    rpm -qf $(which dnsmasq)
        dnsmasq-2.66-21.el7.x86_64
    rpm -qi dnsmasq
        [Lots of info]
    rpm -ql dnsmasq
        /etc/dbus-1/system.d/dnsmasq.conf
        /etc/dnsmasq.conf
        /etc/dnsmasq.d
        ...
    rpm -qd dnsmasq
        ...
        /usr/share/doc/dnsmasq-2.66/doc.html
        /usr/share/doc/dnsmasq-2.66/setup.html
        ...
    rpm -qc dnsmasq
        /etc/dbus-1/system.d/dnsmasq.conf
        /etc/dnsmasq.conf
    rpm -q --scripts dnsmasq
        [Prints the script(s) content to the screen]
@@@

Review Questions
1. createrepo
2. [repo-label]
   name=Repo Name
   baseurl=http://server.example.com/repo
3. yum repolist
4. yum provides */useradd
5. yum group list; yum group info "Security Tools"
6. yum install <package-filename>
7. rpm -q[p] --scripts <package-filename>
8. rpm -q[p]d <package-filename>
9. rpm -qf <file-name>
10. repoquery -i <package-name>

@@@
@@@ Lab 11.1
@@@
    1.  mkdir /myrepo
        cp /mnt/Packages/openldap* /myrepo
        createrepo /myrepo
            Spawning worker 0 with 1 pkgs
            Spawning worker 1 with 1 pkgs
            Spawning worker 2 with 1 pkgs
            Spawning worker 3 with 1 pkgs
            Workers Finished
            Saving Primary metadata
            Saving file lists metadata
            Saving other metadata
            Generating sqlite DBs
            Sqlite DBs complete
        vi /etc/yum.repos.d/lab11.repo
            [lab11repo]
            name=Lab 11 Repo
            baseurl=file:///myrepo
            :wq
    2.  yum repolist
        repo id                 repo name             status
            base/7/x86_64       CentOS-7 - Base       9363
            extras/7/x86_64     CentOS-7 - Extras      264
            lab11repo           Lab 11 Repo              4
            myrepo              thisismyrepo          3831
            updates/7/x86_64    CentOS-7 - Updates     856
            repolist: 14318
    3.  yum search 'cach' | grep 'DNS'
            dnsmasq.x86_64 : A lightweight DHCP/caching DNS server
            unbound.x86_64 : Validating, recursive, and caching DNS(SEC) resolver
    4.  repoquery -l dnsmasq
            /etc/dbus-1/system.d/dnsmasq.conf
            /etc/dnsmasq.conf
            /etc/dnsmasq.d
            ...
        repoquery -R dnsmasq
            /bin/sh
            chkconfig
            libc.so.6(GLIBC_2.15)(64bit)
            ...
        rpm -ql dnsmasq
            /etc/dbus-1/system.d/dnsmasq.conf
            /etc/dnsmasq.conf
            /etc/dnsmasq.d
            ...
        rpm -qR dnsmasq
            /bin/sh
            chkconfig
            config(dnsmasq) = 2.66-21.el7
            ...
        rpm -qd dnsmasq
            /usr/share/doc/dnsmasq-2.66/CHANGELOG
            /usr/share/doc/dnsmasq-2.66/COPYING
            ...
        rpm -qc dnsmasq
            /etc/dbus-1/system.d/dnsmasq.conf
            /etc/dnsmasq.conf
    5.  yumdownloader dnsmasq
            dnsmasq-2.66-21.el7.x86_64.rpm
        rpm -qp --scripts dnsmasq-2.66-21.el7.x86_64.rpm
            [Prints the script(s) content to the screen]
    6.  yum install dnsmasq-2.66-21.el7.x86_64.rpm
            [Already installed]
    7.  yum history
            ID     | Login user               | Date and time    | Action(s)      | Altered
            -------------------------------------------------------------------------------
                16 | ladmin <ladmin>          | 2017-02-25 17:17 | Install        |    2
                15 | ladmin <ladmin>          | 2017-02-25 15:22 | Erase          |    2
                14 | ladmin <ladmin>          | 2017-02-25 15:19 | Install        |    2
                ...
        yum history undo 16 -y
            [Uninstalled]
@@@



12-12-12-12-12-12-12-12-12-12-12-12-12-12-12-12-12-12-12-12-12-12-12-12-12-12-12-12-12-12-12-12-12-12-12-12-12-12-12-12-12-12
12-12                                              12-12-12-12-12-12-12-12-12-12-12-12-12-12-12-12-12-12-12-12-12-12-12-12-12
12-12    Chapter 12: Scheduling Tasks (13 pg.)     12-12-12-12-12-12-12-12-12-12-12-12-12-12-12-12-12-12-12-12-12-12-12-12-12
12-12                                              12-12-12-12-12-12-12-12-12-12-12-12-12-12-12-12-12-12-12-12-12-12-12-12-12
12-12-12-12-12-12-12-12-12-12-12-12-12-12-12-12-12-12-12-12-12-12-12-12-12-12-12-12-12-12-12-12-12-12-12-12-12-12-12-12-12-12

Do I Know This Already?
B C A A&D B A D D B C

systemctl status crond -l

cron timing:
    minute          0-59
    hour            0-23
    day of month    1-31
    month           1-12
    day of week     0-7

man 5 crontab

cat /etc/crontab
    [Don't update directly]

cron jobs are activated automatically; no need to restart crond

To edit a cron job:
    Login as the user and execute 'crontab -e'
        crontab -e
            no crontab for root - using an empty one
            crontab: installing new crontab
    -OR-
    As root, execute 'crontab -e -u <username>'
        crontab -e -u ladmin
            no crontab for ladmin - using an empty one
            crontab: installing new crontab
    [Editing takes place via vi]
    [Do NOT specify a user when editing cron via 'crontab -e'; the shell will interpret the user as a command and fail]
    [The saved user-specific file lives in /var/spool/cron]
    ls /var/spool/cron
        ladmin  root

Add non-user-specifc cron files to /etc/cron.d
    Filename is not important, only syntax
    Should specify a user; jobs are run as root if a user is not specified

Scripts can be added to the following directories:
    /etc/cron.hourly
    /etc/cron.daily
    /etc/cron.weekly
    /etc/cron.monthly
    [Files have a different syntax; no timing information, just a command/script; timing determined by folder]
    [Must make these files executable with 'chmod +x <filename>' or they won't run]

cat /etc/anacrontab
    [anacron is run by cron every hour to check /etc/anacrontab]
    [/etc/anacrontab can be manually updated to add custom entries]
    [anacron runs scripts in the cron.<period> directories defined in /etc/anacrontab]
    [Only lists 'cron.daily' 'cron.weekly' 'cron.monthly' but custom directories can be added]
    [Depending on the period, there is a different delay and random timing component]
    [Uses the 'run-parts' command to execute all scripts in a given directory]

crontab -l
    [Lists the current user's cron jobs]

crontab -l -u <username>
    [Lists a specified user's cron jobs]

cron security
    /etc/cron.allow
        [If exists (not by default), only listed users can use cron]
    /etc/cron.deny
        [If exists (by default), listed users cannot use cron]

Time stepping:
    Use */2 to run something every second minute/hour/day/etc.
    Use 5-20/5 to run something every 5th, 10th, 15th, 20th minute/hour/day/etc.

@@@
@@@ Exercise 12.1 Running Scheduled Tasks Through cron
@@@
    cat /etc/crontab
        [Never edit directly]
    crontab -e
        8 20 * * 1-7 logger Special crontab message about Stockholm from root
        :wq
    cd /etc/cron.hourly
        vi eachhour
            logger This hourly message is written in Stockholm by /etc/cron.hourly/eachhour at $(date)
        ls -l eachhour
            -rw-r--r--. 1 root root 42 Feb 25 19:47 eachhour
        chmod +x eachhour
        ls -l eachhour
            -rwxr-xr-x. 1 root root 42 Feb 25 19:47 eachhour
    cd /etc/cron.d
        vi eachhour
            11 * * * * root logger This message is written in Stockholm by /etc/cron.d/eachhour
            :wq
        [Need to make executable? Apparently no.]
    grep 'Stockholm' /var/log/messages
        Feb 25 20:01:04 virthost root: This hourly message is written in Stockholm by /etc/cron.hourly/eachhour at Sat Feb 25 20:01:04 CET 2017
            [From '/etc/cron.hourly/eachhour']
        Feb 25 20:08:02 virthost root: Special crontab message about Stockholm from root
            [From 'crontab -e']
        Feb 25 20:11:03 virthost root: This message is written in Stockholm by /etc/cron.d/eachhour
            [From '/etc/cron.d/eachhour']
@@@

@@@
@@@ Exercise 12.2 Scheduling Jobs with at
@@@
    systemctl status atd
        ● atd.service - Job spooling tools
           Loaded: loaded (/usr/lib/systemd/system/atd.service; enabled; vendor preset: enabled)
           Active: active (running) since Sat 2017-02-25 11:15:42 CET; 8h ago
         Main PID: 1356 (atd)
           CGroup: /system.slice/atd.service
                   └─1356 /usr/sbin/atd -f

        Feb 25 11:15:42 virthost.local systemd[1]: Started Job spooling tools.
        Feb 25 11:15:42 virthost.local systemd[1]: Starting Job spooling tools...
    date
        Sat Feb 25 19:57:56 CET 2017
    at 20:30
        at>
            logger This is a message from Sweden scheduled by at
            Ctrl+D
                at> <EOT>
                job 5 at Sat Feb 25 20:30:00 2017
    atq
        5       Sat Feb 25 20:30:00 2017 a root
                                         ^ ('a' for 'at'; 'b' for 'batch')
    at 20:35
        at>
            logger This message from at will never be seen
            Ctrl+D
                at> <EOT>
                job 6 at Sat Feb 25 20:35:00 2017
    atq
        5       Sat Feb 25 20:30:00 2017 a root
        6       Sat Feb 25 20:35:00 2017 a root
    atrm 6
    atq
        Sat Feb 25 20:30:00 2017 a root
    grep 'Sweden' /var/log/messages
        Feb 25 20:30:02 virthost root: This is a message from Sweden scheduled by at
@@@

at jobs are stored at /var/spool/at

at security:
    /etc/at.allow
        [If exists (not by default), only listed users can use at]
    /etc/at.deny
        [If exists (by default), listed users cannot use at]

Remove multiple at jobs
    atrm 14 15 16

atd controls 'at' and 'batch'

batch jobs only start when system performance is below a set threshold (default 0.8)

atd -l 0.7
    [Sets batch job threshold to 0.7; best for single CPU systems]
atd -l 3.0
    [Sets batch job threshold to 3.0; best for multi CPU systems]

batch
    at>
        logger Hey Sweden this is a batch job!
        Ctrl+D
            at> <EOT>
            job 10 at Sat Feb 25 20:48:00 2017
atq
    10      Sat Feb 25 21:48:00 2017 b root
                                     ^ ('a' for 'at'; 'b' for 'batch')
grep 'Sweden' /var/log/messages
    Feb 25 20:49:29 virthost root: Hey Sweden this is a batch job!

Review Questions
1. crontab -e <OR> /etc/cron.d
2. 0 14 1,15 * *
3. */2 * * * *
4. 0 0 19 9 4
5. 0, 7, sun
6. crontab -e -u lisa
7. echo "boris" >> /etc/cron.deny
8. /etc/anacrontab -OR- /etc/cron.daily/<job-name>
9. atd
10. atq

@@@
@@@ Lab 12.1
@@@
    1.  crontab -e
            0 23 * * * yum update -y
                [Configure as root; don't need to specify a username]
            :wq
    2.  vi /etc/cron.d/rebootjob
            0 03 25 2 * root /sbin/reboot
                [Should specify a username; otherwise will run as root by default]
            :wq
@@@



13-13-13-13-13-13-13-13-13-13-13-13-13-13-13-13-13-13-13-13-13-13-13-13-13-13-13-13-13-13-13-13-13-13-13-13-13-13-13-13-13-13
13-13                                                 13-13-13-13-13-13-13-13-13-13-13-13-13-13-13-13-13-13-13-13-13-13-13-13
13-13    Chapter 13: Configuring Logging (23 pg.)     13-13-13-13-13-13-13-13-13-13-13-13-13-13-13-13-13-13-13-13-13-13-13-13
13-13                                                 13-13-13-13-13-13-13-13-13-13-13-13-13-13-13-13-13-13-13-13-13-13-13-13
13-13-13-13-13-13-13-13-13-13-13-13-13-13-13-13-13-13-13-13-13-13-13-13-13-13-13-13-13-13-13-13-13-13-13-13-13-13-13-13-13-13

Do I Know This Already?
C D C A D C D A D A

Important log files/locations:
    /var/log/messages
    /var/log/dmesg
    /var/log/secure
    /var/log/boot.log
    /var/log/audit/audit.log
    /var/log/maillog
    /var/log/samba/
    /var/log/sssd
    /var/log/cups/
    /var/log/httpd/

logger -p kern.err My Message
    [Writes "My Message" to the 'kernel facility' with 'error priority']

@@@
@@@ Exercise 13.1 Using Live Log Monitoring and logger
@@@
    [First terminal as root]
        sudo -i
        tail -f /var/log/messages
    [Second terminal as ladmin]
        su - user
        su -
            [Enter wrong password]
        logger hello
    [First terminal as root]
        [/var/log/messages]
            Feb 26 20:56:42 virthost su: FAILED SU (to root) ladmin on pts/0
            Feb 26 20:57:32 virthost ladmin: hello
        Ctrl+C
        tail -n 20 /var/log/secure
            Feb 26 20:56:02 virthost su: pam_unix(su-l:session): session opened for user user by ladmin(uid=0)
            Feb 26 20:56:40 virthost unix_chkpwd[9114]: password check failed for user (root)
            Feb 26 20:56:40 virthost su: pam_unix(su-l:auth): authentication failure; logname=ladmin uid=1001 euid=0 tty=pts/0 ruser=user rhost=  user=root
            Feb 26 20:56:40 virthost su: pam_succeed_if(su-l:auth): requirement "uid >= 1000" not met by user "root"
@@@

rpm -qc rsyslog
    /etc/logrotate.d/syslog
    /etc/rsyslog.conf
    /etc/sysconfig/rsyslog

[If options need to be passed to rsyslogd service on startup, edit /etc/sysconfig/rsyslog]
    [The only line in this file is SYSLOGD_OPTIONS=""]

cd /etc/rsyslog.d/
    [Can add custom "snap-in" files here, instead of directly adding lines to rsyslog.conf]
    debug.conf
        *.debug /var/log/messages-debug

man 5 rsyslog.conf
    [Lists all facilities and priorities]
        [A "selector" is the set 'facility.priority']
    kern.info
        [All kernel messages at info level and higher]
    kern.*
        [All kernel messages]
    *.info
        [All info level and higher messages]
    *.info;auth.none
        [All info level and higher messages, except auth.info messages]
    local0,local1.notice
        [All notice level and higher messages from local0 and local1]
    daemon.warning;mail.crit;user.emerg
        [Multiple types of facility and priority messages to the same place]
    cron.=debug
        [Only the debug level cron messages, nothing else]
    kern.*;kern.!alert
        [All kernel messages except alert and higher]
    kern.*;kern.!=alert
        [All kernel messages except alert]

#local0.info                                            /var/log/custom_test.log
#local0.*                                               /var/log/custom_test.log
#*.info                                                 /var/log/custom_test.log
#*.info;local0.none                                     /var/log/custom_test.log
#local0,local1.notice                                   /var/log/custom_test.log
#local0.warning;local1.crit                             /var/log/custom_test.log
#local0.=debug                                          /var/log/custom_test.log
#local0.*;local0.!alert                                 /var/log/custom_test.log
#local0.*;local0.!=alert                                /var/log/custom_test.log

[TODO The following does not work]
    $template TempTest,"-p local1.info Dumpster Fire!"
    local0.alert    -?TempTest
    ^/bin/logger;TempTest

[Instead of sending messages to files, they can be sent to modules, like :modulename:]
    [For example, to use the User Message Module, send to ":omusrmsg:*" for all users]
    [To send only to specific users, send to ":omusrmsg:root,user1,user2"]

@@@
@@@ Exercise 13.2 Changing rsyslog.conf Rules
@@@
    yum install -y httpd
    vi /etc/httpd/conf/httpd.conf
        ErrorLog syslog:local1
        :wq
    systemctl restart httpd
    vi /etc/rsyslog.conf
        local1.err    -/var/log/httpd-error.log
        [The '-/' buffers the writes for efficiency]
    systemctl restart rsyslog
    http://127.0.01
    cat /var/log/httpd-error.log
        Feb 27 13:03:23 virthost httpd[16522]: [autoindex:error] [pid 16522] [client 127.0.0.1:38812]
        AH01276: Cannot serve directory /var/www/html/: No matching DirectoryIndex(index.html,index.php)
        found,and server-generated directory index forbidden by Options directive
    echo "*.debug /var/log/messages-debug" > /etc/rsyslog.d/debug.conf
    systemctl restart rsyslog
    [In a second terminal]
        tail -f /var/log/messages-debug
    logger -p daemon.debug "Daemon Debug Message"
    [In a second terminal]
        [See the debug message]
        Ctrl+C
@@@

vi /etc/logrotate.conf
    [Configure logrotate service parameters]
cd /etc/logrotate.d
    [Contains "snap-in" files from RPMs that dictate log rotation]
    [File settings in logrotate.d overwrite default settings in logrotate.conf]

systemd-journald
    [Log messages in the journal are binary and stored in /run/log/journal]
    [View with journalctl]

[There are many journal filtering commands]
    man journalctl

@@@
@@@ Exercise 13.3 Discovering journalctl
@@@
    journalctl
        q
    journalctl --no-pager
        [Prints everything to the screen rather than using less]
    journalctl -f
        [Tails the journal]
        Ctrl+C
    journalctl <TAB><TAB>
        CODE_FILE=    SYSLOG_FACILITY=      _EXE=         _SOURCE_REALTIME_TIMESTAMP=    _UDEV_SYSNAME=
        CODE_FUNC=    SYSLOG_IDENTIFIER=    _GID=         _SYSTEMD_CGROUP=               _UID=
        CODE_LINE=    SYSLOG_PID=           _HOSTNAME=    _SYSTEMD_OWNER_UID=            __CURSOR=
        ...
        [Shows options that can be used for filtering]
            journalctl _UID=0
                [Opens the journal in less, only showing messages created by the user with UID=0 (root)]
                q
    journalctl -n 20
        [Opens the last 20 lines of the journal in less]
        q
    journalctl -p err
    journalctl -p 3
        [Opens the journal in less, only showing messages of the given priority or higher (more severe)]
    journalctl -p crit..err
    journalctl -p 0..3
        [Opens the journal in less, only showing messages between the given priorities, inclusive; order doesn't matter]
    journalctl --since "YYYY-MM-DD hh:mm:ss" --until "YYYY-MM-DD hh:mm:ss"
        journalctl --since "2017-02-26 20:21:22" --until "2017-02-27 13:14:15"
        [Also '-S' and '-U']
            journalctl -S "2017-02-26 20:21:22" -U "2017-02-27 13:14:15"
        [Can use 'yesterday' 'today' 'tomorrow']
            journalctl -S "yesterday" -U "today"
        [Can use relative time, such as 'now' '+' '-' in seconds]
            journalctl -S -120 -U now
    journalctl _PID=1 --since 9:00:00 --until 15:00:00
        [Opens the journal in less, only showing messages from PID=1 between the given hours of the current day]
    journalctl --since yesterday -p err
        [Errors (or worse) since yesterday]
    journalctl -o verbose
        Sat 2017-02-25 23:26:32.520948 CET [s=a133193081f74aa9bc21d877a03c20c8;i=1;b=60a3c75e234e48b8aa3daa7d8c1977f7;m=2ef097;t=5496256a048f4;x=ba84d36d0067fd
            PRIORITY=6
            _TRANSPORT=driver
            MESSAGE=Runtime journal is using 8.0M (max allowed 91.1M, trying to leave 136.7M free of 903.7M available <E2><86><92> current limit 91.1M).
            MESSAGE_ID=ec387f577b844b8fa948f33cad9a75e6
            _PID=105
            _UID=0
            _GID=0
            _COMM=systemd-journal
            _EXE=/usr/lib/systemd/systemd-journald
            _CMDLINE=/usr/lib/systemd/systemd-journald
            _CAP_EFFECTIVE=5402800cf
            _SYSTEMD_CGROUP=/system.slice/systemd-journald.service
            _SYSTEMD_UNIT=systemd-journald.service
            _SYSTEMD_SLICE=system.slice
            _BOOT_ID=60a3c75e234e48b8aa3daa7d8c1977f7
            _MACHINE_ID=a69e103ac0b941bb8c45ae4a567d31e9
            _HOSTNAME=virthost.local
        [Every detail per journal entry]
    journalctl _SYSTEMD_UNIT=sshd.service
        [Shows all sshd.service journal entries]
@@@

[/run/log/journal is cleared every reboot]
[The journal is not persistent, but a copy can be create to enable this; see Ex. 13.4]
[The journal is limited by default to 10% of the file system]
[The journal will not grow if less than 15% of file system space remains]

vi /etc/systemd/journald.conf
    [Edit the default journald settings]

@@@
@@@ Exercise 13.4 Making the journald Journal Permanent
@@@
    mkdir /var/log/journal
    chown root:systemd-journal /var/log/journal
    chmod 2755 /var/log/journal
    Either:
        reboot
        -OR-
        killall -USR1 systemd-journald
    journalctl -b
        [Shows log messages since the last reboot; relevant since journald is now persistent]
    [Making the journal persistent removes the /run/log/journal file]
    [The journal will be rotated like a regular log file]
@@@

Review Questions
1. /etc/rsyslog.conf
2. /var/log/secure
3. 5 weeks
4. logger -p user.notice <message>
5. *.=info /var/log/messages.info
6. /etc/systemd/journald.conf
7. journalctl -f
8. journalctl _PID=1 -S 9:00 -U 15:00
9. journalctl -b
10. mkdir /var/log/journal/
    chown root:systemd-journal /var/log/journal/
    chmod 2755 /var/log/journal/
    killall -USR1 systemd-journald

@@@
@@@ Lab 13.1
@@@
    1.  Configure the journal to be persistent [see Ex. 13.4]
    2.  echo "*.=info /var/log/messages.info" > /etc/rsyslog.d/info.conf
    3.  vi /etc/logrotate.conf
            rotate 10
@@@



14-14-14-14-14-14-14-14-14-14-14-14-14-14-14-14-14-14-14-14-14-14-14-14-14-14-14-14-14-14-14-14-14-14-14-14-14-14-14-14-14-14
14-14                                                 14-14-14-14-14-14-14-14-14-14-14-14-14-14-14-14-14-14-14-14-14-14-14-14
14-14    Chapter 14: Managing Partitions (28 pg.)     14-14-14-14-14-14-14-14-14-14-14-14-14-14-14-14-14-14-14-14-14-14-14-14
14-14                                                 14-14-14-14-14-14-14-14-14-14-14-14-14-14-14-14-14-14-14-14-14-14-14-14
14-14-14-14-14-14-14-14-14-14-14-14-14-14-14-14-14-14-14-14-14-14-14-14-14-14-14-14-14-14-14-14-14-14-14-14-14-14-14-14-14-14

Do I Know This Already?
A B C C C B D D B&D B

Master Boot Record (MBR)
    [First 512 bytes on a disk]
    [Basic Input Output System (BIOS) only]
    [4 partition maximum]
    [2 TiB maximum partition size]
    [32 bit partition data size]
    [primary, extended, logical]

GUID Partition Table (GPT)
    [First 2 MiB and last 2 MiB (backup) on a disk]
    [BIOS and Unified Extensible Firmware Interface (UEFI)]
    [128 partition maximum]
    [8 ZiB maximum partition size (1024^4 GiB)]
    [128 bit partition data size]
    [no partition 'types']

Kilobyte (KB) - 1000 bytes
Kibibyte (KiB) - 1024 bytes
Megabyte (MG) - 1000 KB
Mebibyte (MiB) - 1024 KiB

/dev/sda    [SCSI driver for SCSI and SATA disks; physical servers and VMware VMs]
/dev/hda    [Legacy IDE disk device type; rarely see now]
/dev/vda    [Disk in a KVM VM using the virtio disk driver]
/dev/xvda   [Disk in a Xen VM using the Xen virtual disk driver; RHEL running in AWS]

fdisk for MBR
gdisk for GPT

@@@
@@@ Exercise 14.1 Creating MBR Partitions with fdisk
@@@
    At boot on a test VM:
        IDE - 150MB
        AHCI (SATA) - 10GB* /dev/sda
        ACHI (SATA) - 200MB /dev/sdb
        SCSI (SCSI) - 130MB /dev/sdc
        SCSI (SAS) - 112MB /dev/sdd

    dd if=/dev/sda of=/root/diskfile1 bs=1M count=1
    dd if=/dev/sdb of=/root/diskfile2 bs=1M count=1
    dd if=/dev/sdc of=/root/diskfile3 bs=1M count=1

    cp /etc/fstab /root/fstab

    fdisk /dev/sdb
        Welcome to fdisk (util-linux 2.23.2).
        Changes will remain in memory only, until you decide to write them.
        Be careful before using the write command.

        Device does not contain a recognized partition table
        Building a new DOS disklabel with disk identifier 0x51b54358.

        p
            Disk /dev/sdb: 209 MB, 209704448 bytes, 409579 sectors
            Units = sectors of 1 * 512 = 512 bytes
            Sector size (logical/physical): 512 bytes / 512 bytes
            I/O size (minimum/optimal): 512 bytes / 512 bytes
            Disk label type: dos
            Disk identifier: 0x24bdf885

               Device Boot      Start         End      Blocks   Id  System

        n
            Partition type:
               p   primary (0 primary, 0 extended, 4 free)
               e   extended
            Select (default p): p
            Partition number (1-4, default 1): 1
            First sector (2048-409578, default 2048): 2048
            Last sector, +sectors or +size{K,M,G} (2048-409578, default 409578): +100M
            Partition 1 of type Linux and of size 100 MiB is set

        p
            Disk /dev/sdb: 209 MB, 209704448 bytes, 409579 sectors
            Units = sectors of 1 * 512 = 512 bytes
            Sector size (logical/physical): 512 bytes / 512 bytes
            I/O size (minimum/optimal): 512 bytes / 512 bytes
            Disk label type: dos
            Disk identifier: 0x24bdf885

                Device Boot      Start         End      Blocks   Id  System
                /dev/sdb1         2048      206847      102400   83  Linux

        w
            The partition table has been altered!
            Calling ioctl() to re-read partition table.
            Syncing disks.

    [The in-memory kernel partition table can't be updated automatically when in use]
    If not synced, compare:
        fdisk -l /dev/sdb
        cat /proc/partitions
    Then run:
        partprobe /dev/sdb
@@@

To clear a partition table:
    dd if=/dev/zero of=/dev/sdb bs=1M count=1

[If more than four partitions are needed on MBR, then use extended partitions]
[Filesystems can't exist on extended partitions; only logical partitions can]

@@@
@@@ Exercise 14.2 Creating Logical Partitions
@@@
    fdisk /dev/sdb
        [Welcome message]

        p
            Device Boot      Start         End      Blocks   Id  System
            /dev/sdb1         2048      206847      102400   83  Linux
            /dev/sdb2       206848      227327       10240   83  Linux
            /dev/sdb3       227328      268287       20480   83  Linux

        n
            Partition type:
               p   primary (3 primary, 0 extended, 1 free)
               e   extended
            Select (default e): e
            Selected partition 4
            First sector (268288-409578, default 268288):
            Using default value 268288
            Last sector, +sectors or +size{K,M,G} (268288-409578, default 409578):
            Using default value 409578
            Partition 4 of type Extended and of size 69 MiB is set

        [All four partitions are now full; create a new one anyway]

        n
            All primary partitions are in use
            Adding logical partition 5
            First sector (270336-409578, default 270336):
            Using default value 270336
            Last sector, +sectors or +size{K,M,G} (270336-409578, default 409578): +50M
            Partition 5 of type Linux and of size 50 MiB is set

        p
            Disk /dev/sdb: 209 MB, 209704448 bytes, 409579 sectors
            Units = sectors of 1 * 512 = 512 bytes
            Sector size (logical/physical): 512 bytes / 512 bytes
            I/O size (minimum/optimal): 512 bytes / 512 bytes
            Disk label type: dos
            Disk identifier: 0x24bdf885

               Device Boot          Start         End      Blocks   Id  System
               /dev/sdb1             2048      206847      102400   83  Linux
               /dev/sdb2           206848      227327       10240   83  Linux
               /dev/sdb3           227328      268287       20480   83  Linux
               /dev/sdb4           268288      409578       70645+   5  Extended
               /dev/sdb5           270336      372735       51200   83  Linux

        w
            [Confirmation]
@@@

[Running gdisk on a disk with MBR and partitions will corrupt that disk]

@@@
@@@ Exercise 14.3 Creating GPT Partitions with gdisk
@@@
    gdisk /dev/sdc
        GPT fdisk (gdisk) version 0.8.6

        Partition table scan:
          MBR: not present
          BSD: not present
          APM: not present
          GPT: not present

        Creating new GPT entries.

    p
        Disk /dev/sdc: 307197 sectors, 150.0 MiB
        Logical sector size: 512 bytes
        Disk identifier (GUID): DCDDF6BB-68BD-45E5-AF00-2C68CC93D5E6
        Partition table holds up to 128 entries
        First usable sector is 34, last usable sector is 307163
        Partitions will be aligned on 2048-sector boundaries
        Total free space is 307130 sectors (150.0 MiB)

        Number  Start (sector)    End (sector)  Size       Code  Name

    n
        Partition number (1-128, default 1): 1
        First sector (34-307163, default = 2048) or {+-}size{KMGTP}: 2048
        Last sector (2048-307163, default = 307163) or {+-}size{KMGTP}: +55M
        Current type is 'Linux filesystem'
        Hex code or GUID (L to show codes, Enter = 8300): 8300

    p
        Disk /dev/sdc: 307197 sectors, 150.0 MiB
        Logical sector size: 512 bytes
        Disk identifier (GUID): DCDDF6BB-68BD-45E5-AF00-2C68CC93D5E6
        Partition table holds up to 128 entries
        First usable sector is 34, last usable sector is 307163
        Partitions will be aligned on 2048-sector boundaries
        Total free space is 194490 sectors (95.0 MiB)

        Number  Start (sector)    End (sector)  Size       Code  Name
           1            2048          114687   55.0 MiB    8300  Linux filesystem

    w
        Final checks complete. About to write GPT data. THIS WILL OVERWRITE EXISTING
        PARTITIONS!!

        Do you want to proceed? (Y/N): y
        OK; writing new GUID partition table (GPT) to /dev/sdc.
        The operation has completed successfully.

    [Execute partprobe if necessary to sync disks]
@@@

mkfs -t ext4 /dev/sdb2
-OR-
mkfs.ext4 /dev/sdb2
-OR-
mke2fs -t ext4 /dev/sdb2

mkfs [Default is ext2]

[XFS requires the partition size to be at least 16M (4096 blocks @ 4KiB/block)]

@@@
@@@ Exercise 14.4 Creating a File System
@@@
    mkfs -t xfs /dev/sdb1
        meta-data=/dev/sdb1              isize=512    agcount=4, agsize=6400 blks
                 =                       sectsz=512   attr=2, projid32bit=1
                 =                       crc=1        finobt=0, sparse=0
        data     =                       bsize=4096   blocks=25600, imaxpct=25
                 =                       sunit=0      swidth=0 blks
        naming   =version 2              bsize=4096   ascii-ci=0 ftype=1
        log      =internal log           bsize=4096   blocks=855, version=2
                 =                       sectsz=512   sunit=0 blks, lazy-count=1
        realtime =none                   extsz=4096   blocks=0, rtextents=0

    mkfs.xfs /dev/sdb3
        meta-data=/dev/sdb3              isize=512    agcount=1, agsize=5120 blks
                 =                       sectsz=512   attr=2, projid32bit=1
                 =                       crc=1        finobt=0, sparse=0
        data     =                       bsize=4096   blocks=5120, imaxpct=25
                 =                       sunit=0      swidth=0 blks
        naming   =version 2              bsize=4096   ascii-ci=0 ftype=1
        log      =internal log           bsize=4096   blocks=855, version=2
                 =                       sectsz=512   sunit=0 blks, lazy-count=1
        realtime =none                   extsz=4096   blocks=0, rtextents=0
@@@

[tune2fs works on ext2/ext3/ext4 file systems only]

tune2fs -l /dev/sdb2
    tune2fs 1.42.9 (28-Dec-2013)
    Filesystem volume name:   <none>
    Last mounted on:          <not available>
    Filesystem UUID:          a96837de-7ef4-49a4-94b9-845af7c91fc7
    ...
    Filesystem features:      has_journal ext_attr resize_inode dir_index filetype extent 64bit flex_bg sparse_super huge_file uninit_bg dir_nlink extra_isize
    Filesystem flags:         signed_directory_hash
    Default mount options:    user_xattr acl
    ...

Enable/disable file system features on ext2/ext3/ext4 file systems:
    tune2fs -O has_journal
    tune2fs -O ^has_journal

Enable/disable default file system mount options on ext2/ext3/ext4 file systems (therefore no need to specify them in /etc/fstab):
    Enable:  tune2fs -o acl,usr_xattr
    Disable: tune2fs -o ^acl,^usr_xattr

Set a filesystem label on ext2/ext3/ext4:
    tune2fs -L "my_disk_label" /dev/sdb2
    -OR-
    e2label /dev/sdb2 "my_disk_label"

    tune2fs -l /dev/sdb2 | grep 'label'
        Filesystem volume name:   my_disk_label

[On XFS file systems, use xfs_admin to adjust file system parameters]
xfs_admin -L "my_disk_label" /dev/sdb1
    writing all SBs
    xfs_admin: truncating label length from 13 to 12
    new label = "my_disk_labe"
xfs_admin -l /dev/sdb1
    label = "my_disk_labe"

@@@
@@@ Exercise 14.5 Creating a Swap Partition
@@@
    fdisk /dev/sdb
        p
            Device Boot         Start         End      Blocks   Id  System
            /dev/sdb1            2048      206847      102400   83  Linux
            /dev/sdb2          206848      227327       10240   83  Linux
            ...
        t
            Partition number (1-5, default 5): 1
            Hex code (type L to list all codes): 82
            Changed type of partition 'Linux' to 'Linux swap / Solaris'
        p
            Device Boot         Start         End      Blocks   Id  System
            /dev/sdb1            2048      206847      102400   82  Linux swap / Solaris
            /dev/sdb2          206848      227327       10240   83  Linux
            ...
        w
            [Confirmation]

    mkswap /dev/sdb1
        mkswap: /dev/sdb1: warning: wiping old xfs signature.
        Setting up swapspace version 1, size = 102396 KiB
        no label, UUID=7e5d9285-ba2f-4f14-871f-b8b1dacb68f7

    free -m
                  total        used        free      shared  buff/cache   available
        Mem:       1839         496         828           9         509        1132
        Swap:      1023           0        1023
                    ^                       ^
    swapon /dev/sdb1
        [Activate an additional 100M of swap]

    free -m
                  total        used        free      shared  buff/cache   available
        Mem:       1839         496         834           9         509        1132
        Swap:      1123           0        1123
                    ^                       ^

    [Procedure for gdisk is identical]
    [Can change an existing partition type from ext4 or xfs to swap without issue]
@@@

Instead of creating a swap filesystem, a swap file can be created on the current file system:
    dd if=/dev/zero of=/my_swapfile bs=1M count=100
        100+0 records in
        100+0 records out
        104857600 bytes (105 MB) copied, 0.0863466 s, 1.2 GB/s
    mkswap /my_swapfile
        Setting up swapspace version 1, size = 102396 KiB
        no label, UUID=cb84e494-af32-4d68-bf52-ed93c6ec8aad
    swapon /my_swapfile
        swapon: /my_swapfile: insecure permissions 0644, 0600 suggested.
    chmod 600 /my_swapfile

cat /proc/swaps
    Filename            Type            Size    Used    Priority
    /dev/dm-1           partition       1048572 0       -1
    /dev/sdb1           partition       102396  0       -2
    /dev/sdc1           partition       51196   0       -3
    /my_swapfile        file            102396  0       -4

mount /dev/sdb3 /mnt/xfs
    mount | grep 'sdb3'
        /dev/sdb3 on /mnt type xfs (rw,relatime,seclabel,attr2,inode64,noquota)

umount /dev/sdb3
-OR-
umount /mnt/xfs

mount /dev/sdb1 /mnt/ext4
    mount | grep 'sdb1'
        /dev/sdb1 on /mnt/ext4 type ext4 (rw,relatime,seclabel,data=ordered)

umount /dev/sdb1
-OR-
umount /mnt/ext4

tune2fs -l /dev/sdb1 | grep 'mount options'
    Default mount options:    user_xattr acl

tune2fs -o ^user_xattr,^acl /dev/sdb1
    tune2fs 1.42.9 (28-Dec-2013)

tune2fs -l /dev/sdb1 | grep 'mount options'
    Default mount options:    (none)

[Removing the mount options via tune2fs doesn't seem to prevent using chattr or setfacl]

blkid
    /dev/sda1: UUID="4700bf88-6f1b-446d-a369-d4614ce9d614" TYPE="xfs"
    /dev/sda2: UUID="mS8FyW-lhbn-3e80-8O2g-0fX2-LIvX-8Q95l4" TYPE="LVM2_member"
    /dev/sdb1: LABEL="my_ext4_disk" UUID="baa28b18-bf10-47b4-a4c1-47bf0c67d1d3" TYPE="ext4"
    /dev/sdb2: UUID="d31d23fe-5dfc-4e7d-94ef-9f96d6dd67f1" TYPE="swap"
    /dev/sdb3: LABEL="my_xfs_disk" UUID="1bc8450b-532d-4316-a6ef-eae0ecce6f24" TYPE="xfs"
    /dev/sdc1: UUID="d9dffa5e-44fa-4d8b-981f-2ca16a07279c" TYPE="swap" PARTLABEL="Linux swap" PARTUUID="5f65bd4c-12ea-4d14-8827-46e1cf4bd280"
    /dev/mapper/cl_odin-root: UUID="9a1e7042-03a8-4829-9939-d345533fc189" TYPE="xfs"
    /dev/mapper/cl_odin-swap: UUID="03b12f9c-6a39-41e3-a32d-8428f902ceed" TYPE="swap"

[GPT partitions include "PARTLABEL" and "PARTUUID"]

mount /dev/sdb1 /mnt
-OR-
mount LABEL="my_ext4_disk" /mnt
-OR-
mount UUID="baa28b18-bf10-47b4-a4c1-47bf0c67d1d3" /mnt

[Use /etc/fstab for auto-mounting file systems]

|           Device           | Mount Point | File System |    Mount Options    | Dump Support | Automatic Check |
  /dev/mapper/cl-centos-root    /                xfs            defaults              1               1
  UUID=baa28b18-bf10-47b4-d4    /boot            xfs            defaults              1               2
  /dev/mapper/cl-centos-swap    swap             swap           defaults              0               0
  LABEL=my_xfs_disk             /mnt/dir1        ext4           ro,noatime            1               0
  /dev/sdb3                     /my_dir          xfs            acl,user_xttr         1               2
  10.1.1.145:/vol/data          /netapp_data     nfs            rw,hard,_netdev       0               0

@@@
@@@ Exercise 14.6 Mounting Partitions Through /etc/fstab
@@@
    blkid
        /dev/sda1: UUID="4700bf88-6f1b-446d-a369-d4614ce9d614" TYPE="xfs"
        /dev/sda2: UUID="mS8FyW-lhbn-3e80-8O2g-0fX2-LIvX-8Q95l4" TYPE="LVM2_member"
        /dev/sdb1: UUID="db37ed47-cdfe-46de-bbcf-bcc830106a7e" TYPE="xfs"
        ...
    mkdir -p /mounts/data
    vi /etc/fstab
        UUID="db37ed47-cdfe-46de-bbcf-bcc830106a7e"    /mounts/data    xfs    defaults    1 2
        :wq
    mount -a
    df -h
        Filesystem                Size  Used Avail Use% Mounted on
        /dev/mapper/cl_odin-root  8.0G  5.9G  2.2G  74% /
        devtmpfs                  905M     0  905M   0% /dev
        tmpfs                     920M  100K  920M   1% /dev/shm
        tmpfs                     920M  8.9M  912M   1% /run
        tmpfs                     920M     0  920M   0% /sys/fs/cgroup
        /dev/sda1                1014M  226M  789M  23% /boot
        tmpfs                     184M   12K  184M   1% /run/user/1000
        /dev/sdb1                  97M  5.2M   92M   6% /mounts/data
@@@

Review Questions
1. gdisk
2. fdisk
3. XFS
4. /etc/fstab
5. noauto
6. mkswap
7. mount -a
8. ext2
9. mkfs.ext4 <OR> mkfs -t ext4
10. blkid

@@@
@@@ Lab 14.1
@@@
    1.  dd if=/root/diskfile1 of=/dev/sda
        dd if=/root/diskfile2 of=/dev/sdb
        dd if=/root/diskfile3 of=/dev/sdc
    2.  \cp /root/fstab /etc/fstab
@@@

@@@
@@@ Lab 14.2
@@@
    1.  gdisk /dev/sdb
            n
                Partition number (1-128, default 1):
                First sector (34-409545, default = 2048) or {+-}size{KMGTP}:
                Last sector (2048-409545, default = 409545) or {+-}size{KMGTP}: +100M
                Current type is 'Linux filesystem'
                Hex code or GUID (L to show codes, Enter = 8300): 8200
                Changed type of partition to 'Linux swap'
            n
                Partition number (2-128, default 2):
                First sector (34-409545, default = 206848) or {+-}size{KMGTP}:
                Last sector (206848-409545, default = 409545) or {+-}size{KMGTP}: +100M
                Current type is 'Linux filesystem'
                Hex code or GUID (L to show codes, Enter = 8300): 8300
                Changed type of partition to 'Linux filesystem'
            w
                [Confirmation]
        mkswap /dev/sdb1
            mkswap: /dev/sdb1: warning: wiping old xfs signature.
            Setting up swapspace version 1, size = 102396 KiB
            no label, UUID=449f53e0-7d0b-4ea6-b5a8-ed9f4a15db8a
        mkfs.ext4 /dev/sdb2
            mke2fs 1.42.9 (28-Dec-2013)
            Filesystem label=
            OS type: Linux
            Block size=1024 (log=0)
            ...
            Creating journal (4096 blocks): done
            Writing superblocks and filesystem accounting information: done
    2.  blkid | grep 'sdb'
            /dev/sdb1: UUID="449f53e0-7d0b-4ea6-b5a8-ed9f4a15db8a" TYPE="swap" PARTLABEL="Linux swap" PARTUUID="80f36f00-e8c8-45da-8dbf-bdd09223a04a"
            /dev/sdb2: UUID="e3a7f9f4-ed83-4d10-bbc1-38f8e605710a" TYPE="ext4" PARTLABEL="Linux filesystem" PARTUUID="4c0e43b5-642d-428b-86ef-30a9c5c1ba50"
        mkdir -p /mounts/data
        vi /etc/fstab
            UUID="449f53e0-7d0b-4ea6-b5a8-ed9f4a15db8a"    swap    swap    defaults    0 0
            UUID="e3a7f9f4-ed83-4d10-bbc1-38f8e605710a"    /mounts/data    ext4    defaults    0 0
            :wq
        mount -a

    3.  reboot
        df -hT
        blkid
        mount
        cat /proc/swaps
@@@



15-15-15-15-15-15-15-15-15-15-15-15-15-15-15-15-15-15-15-15-15-15-15-15-15-15-15-15-15-15-15-15-15-15-15-15-15-15-15-15-15-15
15-15                                                          15-15-15-15-15-15-15-15-15-15-15-15-15-15-15-15-15-15-15-15-15
15-15    Chapter 15: Managing LVM Logical Volumes (19 pg.)     15-15-15-15-15-15-15-15-15-15-15-15-15-15-15-15-15-15-15-15-15
15-15                                                          15-15-15-15-15-15-15-15-15-15-15-15-15-15-15-15-15-15-15-15-15
15-15-15-15-15-15-15-15-15-15-15-15-15-15-15-15-15-15-15-15-15-15-15-15-15-15-15-15-15-15-15-15-15-15-15-15-15-15-15-15-15-15

Do I Know This Already?
B C D C B&C A&B C B A B

Just remember:
    pv<TAB><TAB> --help
    vg<TAB><TAB> --help
    lv<TAB><TAB> --help

@@@
@@@ Exercise 15.1 Creating the Physical Volume
@@@
    fdisk /dev/sdb
    o
        Building a new DOS disklabel with disk identifier 0x5f2e844f.
    n
        Partition type:
           p   primary (0 primary, 0 extended, 4 free)
           e   extended
        Select (default p): p
        Partition number (1-4, default 1): 1
        First sector (2048-409578, default 2048): 2048
        Last sector, +sectors or +size{K,M,G} (2048-409578, default 409578): +100M
        Partition 1 of type Linux and of size 100 MiB is set
    t
        Selected partition 1
        Hex code (type L to list all codes): 8e
        Changed type of partition 'Linux' to 'Linux LVM'
    w
        The partition table has been altered!
        Calling ioctl() to re-read partition table.
        Syncing disks.

    pvcreate /dev/sdb1
        Physical volume "/dev/sdb1" successfully created.
    pvs
        PV         VG      Fmt  Attr PSize   PFree
        /dev/sda2  cl_odin lvm2 a--    9.00g      0
        /dev/sdb1          lvm2 ---  100.00m 100.00m
    pvdisplay
        --- Physical volume ---
        PV Name               /dev/sda2
        VG Name               cl_odin
        PV Size               9.00 GiB / not usable 2.00 MiB
        Allocatable           yes (but full)
        PE Size               4.00 MiB
        Total PE              2303
        Free PE               0
        Allocated PE          2303
        PV UUID               mS8FyW-lhbn-3e80-8O2g-0fX2-LIvX-8Q95l4
        "/dev/sdb1" is a new physical volume of "100.00 MiB"
        --- NEW Physical volume ---
        PV Name               /dev/sdb1
        VG Name
        PV Size               100.00 MiB
        Allocatable           NO
        PE Size               0
        Total PE              0
        Free PE               0
        Allocated PE          0
        PV UUID               PULXqp-SO4R-pRaN-Lkp0-ooGJ-VQSD-tEPllw
@@@

lsblk
    NAME             MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT
    sda                8:0    0   10G  0 disk
    |-sda1             8:1    0    1G  0 part /boot
    `-sda2             8:2    0    9G  0 part
      |-cl_odin-root 253:0    0    8G  0 lvm  /
      `-cl_odin-swap 253:1    0    1G  0 lvm  [SWAP]
    sdb                8:16   0  200M  0 disk
    `-sdb1             8:17   0  100M  0 part
    sdc                8:32   0  130M  0 disk
    sdd                8:48   0  112M  0 disk
    sr0               11:0    1 1024M  0 rom

vgcreate vg_mydata1 /dev/sdb1

[Can skip the pvcreate step when creating a Volume Group from a partition]
    fdisk /dev/sdc
        n
            p
            1
            2048
            +100M
        t
            8e
        w
            [Confirmation]
    vgcreate vg_mydata2 /dev/sdc1
        Physical volume "/dev/sdc1" successfully created.
        Volume group "vg_mydata2" successfully created

[Can skip the pvcreate step when creating a Volume Group from an entire disk]
    vgcreate vg_mydata3 /dev/sdd
        Physical volume "/dev/sdd" successfully created.
        Volume group "vg_mydata3" successfully created

[When viewing pvdisplay output, "PE" means "Physical Extent"]
[Default is 4MB; must be multiple of 2MB; set 8MB with 'vgcreate -s 8 vg_mydata2 /dev/sdc1']

vgs
    VG         #PV #LV #SN Attr   VSize   VFree
    cl_odin      1   2   0 wz--n-   9.00g      0
    vg_mydata1   1   0   0 wz--n-  96.00m  96.00m
    vg_mydata2   1   0   0 wz--n-  96.00m  96.00m
    vg_mydata3   1   0   0 wz--n- 110.00m 110.00m

vgdisplay
    --- Volume group ---
    VG Name               vg_mydata1
    System ID
    Format                lvm2
    Metadata Areas        1
    Metadata Sequence No  1
    VG Access             read/write
    VG Status             resizable
    MAX LV                0
    Cur LV                0
    Open LV               0
    Max PV                0
    Cur PV                1
    Act PV                1
    VG Size               96.00 MiB
    PE Size               4.00 MiB
    Total PE              24
    Alloc PE / Size       0 / 0
    Free  PE / Size       24 / 96.00 MiB
    VG UUID               qwpLdl-l9pW-Bphd-bCGr-equl-1Qah-x2oimW
    ...

Also:
    pvs /dev/<device>
    pvdisplay /dev/<device>
    vgs <volume-group>
    vgdisplay <volume-group>

LVMs accessible three ways:
    /dev/<vg-name>/<lv-name>
    /dev/dm-<#>
    /dev/mapper/<vg-name>-<lv-name>

lvcreate -n <new-lv-name> -L <absolute-size> <existing-vg-name>
    lvcreate -n lv_mydata1_1 -L 75M vg_mydata1
-OR-
lvcreate -n <new-lv-name> -l <relative-size> <existing-vg-name>
    lvcreate -n lv_mydata1_1 -l 50%FREE vg_mydata1

@@@
@@@ Exercise 15.2 Creating the Volume Group and Logical Volumes
@@@
    pvs
        PV         VG         Fmt  Attr PSize   PFree
        /dev/sda2  cl_odin    lvm2 a--    9.00g      0
        /dev/sdb1             lvm2 ---  100.00m 100.00m
        ...
    vgcreate vg_mydata1 /dev/sdb1
        Volume group "vg_mydata1" successfully created
    vgs
        VG         #PV #LV #SN Attr   VSize   VFree
        cl_odin      1   2   0 wz--n-   9.00g      0
        vg_mydata1   1   0   0 wz--n-  96.00m  96.00m
    pvs
        PV         VG         Fmt  Attr PSize   PFree
        /dev/sda2  cl_odin    lvm2 a--    9.00g      0
        /dev/sdb1  vg_mydata1 lvm2 a--   96.00m  96.00m
        ...
    lvcreate -n lv_mydata1_1 -l 50%FREE vg_mydata1
        Logical volume "lv_mydata1_1" created.
    lvs
        LV           VG         Attr       LSize  Pool Origin Data%  Meta%  Move Log Cpy%Sync Convert
        root         cl_odin    -wi-ao----  8.00g
        swap         cl_odin    -wi-ao----  1.00g
        lv_mydata1_1 vg_mydata1 -wi-a----- 48.00m
    lvdisplay
        --- Logical volume ---
        LV Path                /dev/vg_mydata1/lv_mydata1_1
        LV Name                lv_mydata1_1
        VG Name                vg_mydata1
        LV UUID                uER6fH-wV7m-ZKam-KBs6-z76d-S9xI-IUFG2u
        LV Write Access        read/write
        LV Creation host, time server1.example.com, 2017-03-02 13:31:30 +0100
        LV Status              available
        # open                 1
        LV Size                48.00 MiB
        Current LE             12
        Segments               1
        Allocation             inherit
        Read ahead sectors     auto
        - currently set to     8192
        Block device           253:2
    mkfs.xfs /dev/vg_mydata1/lv_mydata1_1
        meta-data=/dev/vg_mydata1/lv_mydata1_1 isize=512    agcount=2, agsize=6144 blks
                 =                       sectsz=512   attr=2, projid32bit=1
                 =                       crc=1        finobt=0, sparse=0
        data     =                       bsize=4096   blocks=12288, imaxpct=25
                 =                       sunit=0      swidth=0 blks
        naming   =version 2              bsize=4096   ascii-ci=0 ftype=1
        log      =internal log           bsize=4096   blocks=855, version=2
                 =                       sectsz=512   sunit=0 blks, lazy-count=1
        realtime =none                   extsz=4096   blocks=0, rtextents=0
    mkdir /files
    vi /etc/fstab
        /dev/vg_mydata1/lv_mydata1_1    /files    xfs    defaults    1 2
        :wq
    mount -a
    mount | grep 'files'
        /dev/mapper/vg_mydata1-lv_mydata1_1 on /files type xfs (rw,relatime,seclabel,attr2,inode64,noquota)
@@@

LVM Commands:
    pvcreate
    pvs
    pvdisplay
    vgcreate
    vgs
    vgdisplay
    lvcreate
    lvs
    lvdisplay

'lvextend' extends logical volumes (and filesystems with '-r' flag)
'lvreduce' shrinks logical volumes (and filesystems with '-r' flag)
'lvresize' can do both

@@@
@@@ Exercise 15.3 Resizing Logical Volumes
@@@
    pvs
        PV         VG         Fmt  Attr PSize   PFree
        /dev/sda2  cl_odin    lvm2 a--    9.00g      0
        /dev/sdb1  vg_mydata1 lvm2 a--   96.00m  48.00m
        /dev/sdc1  vg_mydata2 lvm2 a--   96.00m  96.00m
        /dev/sdd   vg_mydata3 lvm2 a--  110.00m 110.00m
    vgs
        VG         #PV #LV #SN Attr   VSize   VFree
        cl_odin      1   2   0 wz--n-   9.00g      0
        vg_mydata1   1   1   0 wz--n-  96.00m  48.00m
        vg_mydata2   1   0   0 wz--n-  96.00m  96.00m
        vg_mydata3   1   0   0 wz--n- 110.00m 110.00m
    fdisk /dev/sdb
        n
            p
            2
            206848
            409578
        t
            2
            8e
        w
            The partition table has been altered!
            Calling ioctl() to re-read partition table.
            WARNING: Re-reading the partition table failed with error 16: Device or resource busy.
            The kernel still uses the old table. The new table will be used at
            the next reboot or after you run partprobe(8) or kpartx(8)
            Syncing disks.
    partprobe
    cat /proc/partitions
        ...
        8       16     204789 sdb
        8       17     102400 sdb1
        8       18     101365 sdb2
        ...
    vgextend vg_mydata1 /dev/sdb2
        Physical volume "/dev/sdb2" successfully created.
        Volume group "vg_mydata1" successfully extended
    pvs
        PV         VG         Fmt  Attr PSize   PFree
        /dev/sda2  cl_odin    lvm2 a--    9.00g      0
        /dev/sdb1  vg_mydata1 lvm2 a--   96.00m  48.00m
        /dev/sdb2  vg_mydata1 lvm2 a--   96.00m  96.00m
        /dev/sdc1  vg_mydata2 lvm2 a--   96.00m  96.00m
        /dev/sdd   vg_mydata3 lvm2 a--  110.00m 110.00m
    vgs
        VG         #PV #LV #SN Attr   VSize   VFree
        cl_odin      1   2   0 wz--n-   9.00g      0
        vg_mydata1   2   1   0 wz--n- 192.00m 144.00m
        vg_mydata2   1   0   0 wz--n-  96.00m  96.00m
        vg_mydata3   1   0   0 wz--n- 110.00m 110.00m
    [vg_mydata1 now shows #PV:2 and more space]
    vgreduce vg_mydata1 /dev/sdb2
        Removed "/dev/sdb2" from volume group "vg_mydata1"
    pvs
        PV         VG         Fmt  Attr PSize   PFree
        /dev/sda2  cl_odin    lvm2 a--    9.00g      0
        /dev/sdb1  vg_mydata1 lvm2 a--   96.00m  48.00m
        /dev/sdb2             lvm2 ---   98.99m  98.99m
        /dev/sdc1  vg_mydata2 lvm2 a--   96.00m  96.00m
        /dev/sdd   vg_mydata3 lvm2 a--  110.00m 110.00m
    vgs
        VG         #PV #LV #SN Attr   VSize   VFree
        cl_odin      1   2   0 wz--n-   9.00g      0
        vg_mydata1   1   1   0 wz--n-  96.00m  48.00m
        vg_mydata2   1   0   0 wz--n-  96.00m  96.00m
        vg_mydata3   1   0   0 wz--n- 110.00m 110.00m
    vgextend vg_mydata1 /dev/sdb2
        Volume group "vg_mydata1" successfully extended
    lvs
        LV           VG         Attr       LSize  Pool Origin Data%  Meta%  Move Log Cpy%Sync Convert
        root         cl_odin    -wi-ao----  8.00g
        swap         cl_odin    -wi-ao----  1.00g
        lv_mydata1_1 vg_mydata1 -wi-a----- 48.00m
    df -hT
        Filesystem               Type      Size  Used Avail Use% Mounted on
        /dev/mapper/cl_odin-root xfs       8.0G  5.9G  2.2G  74% /
        devtmpfs                 devtmpfs  905M     0  905M   0% /dev
        tmpfs                    tmpfs     920M   84K  920M   1% /dev/shm
        tmpfs                    tmpfs     920M  8.8M  912M   1% /run
        tmpfs                    tmpfs     920M     0  920M   0% /sys/fs/cgroup
        /dev/sda1                xfs      1014M  226M  789M  23% /boot
        tmpfs                    tmpfs     184M   16K  184M   1% /run/user/42
        tmpfs                    tmpfs     184M     0  184M   0% /run/user/1000
    lvextend -r -l +50%FREE /dev/vg_mydata1/lv_mydata1_1
        Phase 1 - find and verify superblock...
        Phase 2 - using internal log
                - zero log...
                - scan filesystem freespace and inode maps...
                - found root inode chunk
        Phase 3 - for each AG...
                - scan (but don't clear) agi unlinked lists...
                - process known inodes and perform inode discovery...
                - agno = 0
                - agno = 1
                - process newly discovered inodes...
        Phase 4 - check for duplicate blocks...
                - setting up duplicate extent list...
                - check for inodes claiming duplicate blocks...
                - agno = 0
                - agno = 1
        No modify flag set, skipping phase 5
        Phase 6 - check inode connectivity...
                - traversing filesystem ...
                - traversal finished ...
                - moving disconnected inodes to lost+found ...
        Phase 7 - verify link counts...
        No modify flag set, skipping filesystem flush and exiting.
          Size of logical volume vg_mydata1/lv_mydata1_1 changed from 48.00 MiB (12 extents) to 120.00 MiB (30 extents).
          Logical volume vg_mydata1/lv_mydata1_1 successfully resized.
        meta-data=/dev/mapper/vg_mydata1-lv_mydata1_1 isize=512    agcount=2, agsize=6144 blks
                 =                       sectsz=512   attr=2, projid32bit=1
                 =                       crc=1        finobt=0 spinodes=0
        data     =                       bsize=4096   blocks=12288, imaxpct=25
                 =                       sunit=0      swidth=0 blks
        naming   =version 2              bsize=4096   ascii-ci=0 ftype=1
        log      =internal               bsize=4096   blocks=855, version=2
                 =                       sectsz=512   sunit=0 blks, lazy-count=1
        realtime =none                   extsz=4096   blocks=0, rtextents=0
        data blocks changed from 12288 to 30720
    pvs
        PV         VG         Fmt  Attr PSize   PFree
        /dev/sda2  cl_odin    lvm2 a--    9.00g      0
        /dev/sdb1  vg_mydata1 lvm2 a--   96.00m      0
        /dev/sdb2  vg_mydata1 lvm2 a--   96.00m  72.00m
        /dev/sdc1  vg_mydata2 lvm2 a--   96.00m  96.00m
        /dev/sdd   vg_mydata3 lvm2 a--  110.00m 110.00m
    vgs
        VG         #PV #LV #SN Attr   VSize   VFree
        cl_odin      1   2   0 wz--n-   9.00g      0
        vg_mydata1   2   1   0 wz--n- 192.00m  72.00m
        vg_mydata2   1   0   0 wz--n-  96.00m  96.00m
        vg_mydata3   1   0   0 wz--n- 110.00m 110.00m
    lvs
        LV           VG         Attr       LSize   Pool Origin Data%  Meta%  Move Log Cpy%Sync Convert
        root         cl_odin    -wi-ao----   8.00g
        swap         cl_odin    -wi-ao----   1.00g
        lv_mydata1_1 vg_mydata1 -wi-a----- 120.00m
    lvresize -r -L +32M vg_mydata1/lv_mydata1_1
        [Success]
    lvreduce -r -L -52M /dev/vg_mydata1/lv_mydata1_1
        fsadm: Xfs filesystem shrinking is unsupported
        [Doesn't work on XFS; only works on Ext4 and Btrfs]
    mkfs.ext4 /dev/vg_mydata1/lv_mydata1_1
    lvresize -r -L -52M /dev/vg_mydata1/lv_mydata1_1
        fsck from util-linux 2.23.2
        /sbin/fsck.xfs: XFS file system.
        resize2fs 1.42.9 (28-Dec-2013)
        Resizing the filesystem on /dev/mapper/vg_mydata1-lv_mydata1_1 to 102400 (1k) blocks.
        The filesystem on /dev/mapper/vg_mydata1-lv_mydata1_1 is now 102400 blocks long.
          Size of logical volume vg_mydata1/lv_mydata1_1 changed from 152.00 MiB (38 extents) to 100.00 MiB (25 extents).
          Logical volume vg_mydata1/lv_mydata1_1 successfully resized.
    lvs
        LV           VG         Attr       LSize   Pool Origin Data%  Meta%  Move Log Cpy%Sync Convert
        root         cl_odin    -wi-ao----   8.00g
        swap         cl_odin    -wi-ao----   1.00g
        lv_mydata1_1 vg_mydata1 -wi-a----- 100.00m
@@@

Review Questions
1. 8e00
2. vgcreate -s 4MiB vggroup /dev/sdb3
3. pvs
4. vgextend vggroup /dev/sdd
5. lvcreate -n lvvol1 -L 6M vgname (requires a 2MiB physical extent size)
6. lvextend -r -L +100M /dev/vgname/lvvol1
7. vgextend
8. -r
9. lvs
10. fsck /dev/vgdata/lvdata

@@@
@@@ Lab 15.1
@@@
    1.  dd if=/dev/zero of=/dev/sdb bs=1M count=600
        gdisk /dev/sdb
            n
                1
                2048
                +600M
                8e00
            p
            w
            y
        partprobe
        vgcreate vggroup /dev/sdb1
            Physical volume "/dev/sdb1" successfully created.
            Volume group "vggroup" successfully created
        pvs
            PV         VG      Fmt  Attr PSize   PFree
            /dev/sda2  cl_odin lvm2 a--    9.00g      0
            /dev/sdb1  vggroup lvm2 a--  596.00m 596.00m
        vgs
            VG      #PV #LV #SN Attr   VSize   VFree
            cl_odin   1   2   0 wz--n-   9.00g      0
            vggroup   1   0   0 wz--n- 596.00m 596.00m
        lvcreate -n lvgroup -L 500M vggroup
            Logical volume "lvgroup" created.
        mkfs.xfs /dev/vggroup/lvgroup
            meta-data=/dev/vggroup/lvgroup   isize=512    agcount=4, agsize=32000 blks
                     =                       sectsz=512   attr=2, projid32bit=1
                     =                       crc=1        finobt=0, sparse=0
            data     =                       bsize=4096   blocks=128000, imaxpct=25
                     =                       sunit=0      swidth=0 blks
            naming   =version 2              bsize=4096   ascii-ci=0 ftype=1
            log      =internal log           bsize=4096   blocks=855, version=2
                     =                       sectsz=512   sunit=0 blks, lazy-count=1
            realtime =none                   extsz=4096   blocks=0, rtextents=0
        mkdir /groups
        echo "/dev/vggroup/lvgroup    /groups    xfs    defaults    1 2" | tee -a /etc/fstab
        mount -a
        mount | grep 'lvgroup'
            /dev/mapper/vggroup-lvgroup on /groups type xfs (rw,relatime,seclabel,attr2,inode64,noquota)
    2.  gdisk /dev/sdb
            n
                2
                1230848
                +300M
                8e00
            p
            w
            y
        partprobe
        vgextend vggroup /dev/sdb2
            Physical volume "/dev/sdb2" successfully created.
            Volume group "vggroup" successfully extended
        lvextend -r -L +250M /dev/vggroup/lvgroup
            Rounding size to boundary between physical extents: 252.00 MiB.
              Size of logical volume vggroup/lvgroup changed from 500.00 MiB (125 extents) to 752.00 MiB (188 extents).
              Logical volume vggroup/lvgroup successfully resized.
            meta-data=/dev/mapper/vggroup-lvgroup isize=512    agcount=4, agsize=32000 blks
                     =                       sectsz=512   attr=2, projid32bit=1
                     =                       crc=1        finobt=0 spinodes=0
            data     =                       bsize=4096   blocks=128000, imaxpct=25
                     =                       sunit=0      swidth=0 blks

            naming   =version 2              bsize=4096   ascii-ci=0 ftype=1
            log      =internal               bsize=4096   blocks=855, version=2
                     =                       sectsz=512   sunit=0 blks, lazy-count=1
            realtime =none                   extsz=4096   blocks=0, rtextents=0
            data blocks changed from 128000 to 192512
    3.  df -hT
            Filesystem                  Type      Size  Used Avail Use% Mounted on
            ...
            /dev/mapper/vggroup-lvgroup xfs       749M   26M  724M   4% /groups
@@@



# # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #
#                                                             #
#  Part 1-3: Performing Advanced System Administration Tasks  #
#                                                             #
# # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #


16-16-16-16-16-16-16-16-16-16-16-16-16-16-16-16-16-16-16-16-16-16-16-16-16-16-16-16-16-16-16-16-16-16-16-16-16-16-16-16-16-16
16-16                                                       16-16-16-16-16-16-16-16-16-16-16-16-16-16-16-16-16-16-16-16-16-16
16-16     Chapter 16: Basic Kernel Management (18 pg.)      16-16-16-16-16-16-16-16-16-16-16-16-16-16-16-16-16-16-16-16-16-16
16-16                                                       16-16-16-16-16-16-16-16-16-16-16-16-16-16-16-16-16-16-16-16-16-16
16-16-16-16-16-16-16-16-16-16-16-16-16-16-16-16-16-16-16-16-16-16-16-16-16-16-16-16-16-16-16-16-16-16-16-16-16-16-16-16-16-16

Do I Know This Already?
A B B-NOT-A C A B C C C C&D

dmesg
    [kernel-related messages showing time relative to the start of the kernel]

journalctl --dmesg
-OR-
journalctl -k
    [kernel-related messages showing clock time]

/proc/*
    [A file interface to the Linux kernel]

cat /proc/meminfo
cat /proc/cpuinfo
cat /proc/partitions
cat /proc/swaps
cat /proc/stat
cat /proc/consoles

uname -a
    Linux server1.example.com 3.10.0-514.6.1.el7.x86_64 #1 SMP Wed Jan 18 13:06:36 UTC 2017 x86_64 x86_64 x86_64 GNU/Linux

hostnamectl status
    Static hostname: server1.example.com
          Icon name: computer-vm
            Chassis: vm
         Machine ID: b101d0db23e44e9f9a4be5f01ca6416e
            Boot ID: fb73071502fc4b7dbe6fadc0909471b1
     Virtualization: kvm
    Operating System: CentOS Linux 7 (Core)
        CPE OS Name: cpe:/o:centos:centos:7

             Kernel: Linux 3.10.0-514.6.1.el7.x86_64
       Architecture: x86-64

cat /etc/redhat-release
    CentOS Linux release 7.3.1611 (Core)

systemctl status systemd-udevd
    ● systemd-udevd.service - udev Kernel Device Manager
       Loaded: loaded (/usr/lib/systemd/system/systemd-udevd.service; static; vendor preset: disabled)
       Active: active (running) since Thu 2017-03-02 16:11:26 CET; 4h 38min ago
         Docs: man:systemd-udevd.service(8)
               man:udev(7)
     Main PID: 512 (systemd-udevd)
       CGroup: /system.slice/systemd-udevd.service
               └─512 /usr/lib/systemd/systemd-udevd

systemd-udevd reads:
    /usr/lib/udev/rules.d/*
    /etc/udev/rules.d/*

udevadm monitor
    monitor will print the received events for:
    UDEV - the event which udev sends out after rule processing
    KERNEL - the kernel uevent
[Add a USB device via VirtualBox]
    KERNEL[5383.335582] add      /devices/pci0000:00/0000:00:0b.0/usb1/1-1 (usb)
    KERNEL[5383.435301] add      /devices/pci0000:00/0000:00:0b.0/usb1/1-1/1-1:1.0 (usb)
    ...
    KERNEL[5383.592230] add      /bus/usb/drivers/uvcvideo (drivers)
    UDEV  [5383.594950] add      /module/uvcvideo (module)
    ...
Ctrl+C

Specify additional modules to be loaded by the systemd-modules-load.service daemon by creating a program.conf file:
    vi /etc/modules-load.d/<module-name>.conf
        # Load <module-name> at boot
        <module-name>
        :wq

lsmod
    [Lists currently loaded kernel modules]
    [Takes no arguments]

modinfo <module-name>
    [Displays information about the specified kernel module]
    e.g. modinfo cryptd

modprobe <module-name>
    [Loads a specified kernel module file and all of its dependencies]
    [Module must reside in /lib/modules/`uname -r`, e.g. /lib/modules/3.10.0-514.6.1.el7.x86_64/kernel/net/mac80211/mac80211.ko]
    e.g. modprobe mac80211
        lsmod | grep mac80211
            Module        Size  Used by
            mac80211    682454  0
            cfg80211    593832  1 mac80211

modprobe -r <module-name>
    [Unloads the specified kernel module, considering its dependencies]
    e.g. modprobe -r mac80211
        lsmod | grep mac80211
            [No results]

Don't use anymore:
    insmod
    rmmod

@@@
@@@ Exercise 16.1 Managing Kernel Modules from the Command Line
@@@
    lsmod | head
    modprobe ext4
    lsmod | grep 'ext4'
        Module       Size  Used by
        ext4       583541  0
        mbcache     14958  1 ext4
        jbd2       102945  1 ext4
    modinfo ext4
        filename:       /lib/modules/3.10.0-514.6.1.el7.x86_64/kernel/fs/ext4/ext4.ko
        license:        GPL
        description:    Fourth Extended Filesystem
        author:         Remy Card, Stephen Tweedie, Andrew Morton, Andreas Dilger, Theodore Ts'o and others
        alias:          fs-ext4
        ...
    modprobe -r ext4
    lsmod | grep 'ext4'
        [No results]
    modprobe -r xfs
        modprobe: FATAL: Module xfs is in use.
@@@

lspci -k
    00:00.0 Host bridge: Intel Corporation 440FX - 82441FX PMC [Natoma] (rev 02)
    00:01.0 ISA bridge: Intel Corporation 82371SB PIIX3 ISA [Natoma/Triton II]
    00:01.1 IDE interface: Intel Corporation 82371AB/EB/MB PIIX4 IDE (rev 01)
            Kernel driver in use: ata_piix
            Kernel modules: ata_piix, pata_acpi, ata_generic
    00:02.0 VGA compatible controller: InnoTek Systemberatung GmbH VirtualBox Graphics Adapter
    ...

Create files to load modules with parameters automatically:
    /etc/modprobe.d/<module-name>.conf

@@@
@@@ Exercise 16.2 Loading Kernel Modules with Parameters
@@@
    lsmod | grep 'cdrom'
        Module     Size  Used by
        cdrom     42556  1 sr_mod
    modprobe -r cdrom
        modprobe: FATAL: Module cdrom is in use.
    modprobe -r sr_mod; modprobe -r cdrom
    modinfo cdrom
        filename:       /lib/modules/3.10.0-514.6.1.el7.x86_64/kernel/drivers/cdrom/cdrom.ko
        license:        GPL
        rhelversion:    7.3
        srcversion:     BE3BD0D17D080229D55B173
        depends:
        intree:         Y
        vermagic:       3.10.0-514.6.1.el7.x86_64 SMP mod_unload modversions
        signer:         CentOS Linux kernel signing key
        sig_key:        EE:3B:C2:53:44:A6:71:F6:D7:76:4A:5C:FD:83:AB:4B:AF:DB:E7:4D
        sig_hashalgo:   sha256
        parm:           debug:bool
        parm:           autoclose:bool
        parm:           autoeject:bool
        parm:           lockdoor:bool
        parm:           check_media_type:bool
        parm:           mrw_format_restart:bool
    modprobe cdrom debug=1
    dmesg
        [Sometimes load information is displayed]
    vi /etc/modprobe.d/cdrom
        options cdrom debug=1
        :wq
        [Debug option will be enabled every time the cdrom kernel module is loaded]
@@@

yum upgrade kernel
-OR-
yum install kernel
    [A new kernel is installed beside the old kernel]
    [The last four installed kernels are in /boot]

Review Questions
1. uname -v (according to 'man uname'); for the kernel release: uname -r
2. /etc/redhat-release
3. lsmod
4. modinfo <module-name>
5. modprobe -r
6. Check for dependencies via lsmod to unload first
7. modinfo <module-name>
8. /etc/modprobe.d/<module-name>.conf
9. options cdrom debug=1
10. yum upgrade kernel <OR> yum install kernel

@@@
@@@ Lab 16.1
@@@
    1.  yum upgrade kernel
            ==========================================================================================
             Package                   Arch          Version                   Repository        Size
            ==========================================================================================
            Installing:
             kernel                    x86_64        3.10.0-514.6.2.el7        updates           37 M

            Transaction Summary
            ==========================================================================================
            Install  1 Package

            Total download size: 37 M
            Installed size: 148 M

            reboot

    2.  dmesg
        journalctl -k
        journalctl --dmesg

    3.  lspci -k | grep 'net' -A3
            00:03.0 Ethernet controller: Intel Corporation 82540EM Gigabit Ethernet Controller (rev 02)
                    Subsystem: Intel Corporation PRO/1000 MT Desktop Adapter
                    Kernel driver in use: e1000
                    Kernel modules: e1000
        modinfo -F parm e1000
            TxDescriptors:Number of transmit descriptors (array of int)
            RxDescriptors:Number of receive descriptors (array of int)
            Speed:Speed setting (array of int)
            Duplex:Duplex setting (array of int)
            AutoNeg:Advertised auto-negotiation setting (array of int)
            FlowControl:Flow Control setting (array of int)
            XsumRX:Disable or enable Receive Checksum offload (array of int)
            TxIntDelay:Transmit Interrupt Delay (array of int)
            TxAbsIntDelay:Transmit Absolute Interrupt Delay (array of int)
            RxIntDelay:Receive Interrupt Delay (array of int)
            RxAbsIntDelay:Receive Absolute Interrupt Delay (array of int)
            InterruptThrottleRate:Interrupt Throttling Rate (array of int)
            SmartPowerDownEnable:Enable PHY smart power down (array of int)
            copybreak:Maximum size of packet that is copied to a new buffer on receive (uint)
            debug:Debug level (0=none,...,16=all) (int)
        ls /sys/module/e1000/parameters | while read param; do echo -n "$param: "; cat /sys/module/e1000/parameters/$param; done;
            copybreak: 256
        modprobe e1000 debug=2
            [No effect]
        echo "options e1000 debug=2" | tee /etc/modprobe.d/e1000.conf
@@@



17-17-17-17-17-17-17-17-17-17-17-17-17-17-17-17-17-17-17-17-17-17-17-17-17-17-17-17-17-17-17-17-17-17-17-17-17-17-17-17-17-17
17-17                                                                17-17-17-17-17-17-17-17-17-17-17-17-17-17-17-17-17-17-17
17-17    Chapter 17: Configuring a Basic Apache Server (14 pg.)      17-17-17-17-17-17-17-17-17-17-17-17-17-17-17-17-17-17-17
17-17                                                                17-17-17-17-17-17-17-17-17-17-17-17-17-17-17-17-17-17-17
17-17-17-17-17-17-17-17-17-17-17-17-17-17-17-17-17-17-17-17-17-17-17-17-17-17-17-17-17-17-17-17-17-17-17-17-17-17-17-17-17-17

Do I Know This Already?
A A-NOT-B C A B D C A A C

yum install httpd
-OR-
yum groups install "Basic Web Server"

/etc/httpd/conf/httpd.conf
    ServerRoot
        [Where configuration files are located; default is /etc/httpd]
    DocumentRoot
        [Where web content is located; default is /var/www/html]

@@@
@@@ Exercise 17.1 Setting Up a Basic Web Server
@@@
    yum groups install "Basic Web Server"
        [Complete!]
    vi /etc/httpd/conf/httpd.conf
        DocumentRoot "/var/www/html"
    echo "Welcome to my web server" | tee /var/www/html/index.html
    systemctl start httpd; systemctl enable httpd
        Created symlink from /etc/systemd/system/multi-user.target.wants/httpd.service to /usr/lib/systemd/system/httpd.service.
    systemctl status httpd
        ● httpd.service - The Apache HTTP Server
           Loaded: loaded (/usr/lib/systemd/system/httpd.service; enabled; vendor preset: disabled)
           Active: active (running) since Fri 2017-03-03 10:09:35 CET; 56s ago
             Docs: man:httpd(8)
                   man:apachectl(8)
         Main PID: 31509 (httpd)
           Status: "Total requests: 0; Current requests/sec: 0; Current traffic:   0 B/sec"
           CGroup: /system.slice/httpd.service
                   ├─31509 /usr/sbin/httpd -DFOREGROUND
                   ├─31510 /usr/sbin/httpd -DFOREGROUND
                   ├─31511 /usr/sbin/httpd -DFOREGROUND
                   ├─31512 /usr/sbin/httpd -DFOREGROUND
                   ├─31513 /usr/sbin/httpd -DFOREGROUND
                   ├─31514 /usr/sbin/httpd -DFOREGROUND
                   └─31515 /usr/sbin/httpd -DFOREGROUND
         
        Mar 03 10:09:35 server1.example.com systemd[1]: Starting The Apache HTTP Server...
        Mar 03 10:09:35 server1.example.com systemd[1]: Started The Apache HTTP Server.
    yum install elinks
        [A text-only web browser for non-graphical systems]
    elinks http://localhost
        [Success]
@@@

ls -la /etc/httpd
    drwxr-xr-x. 2 root root  37 Mar  3 10:08 conf
    drwxr-xr-x. 2 root root 135 Mar  3 09:51 conf.d
    drwxr-xr-x. 2 root root 186 Mar  3 09:51 conf.modules.d
    lrwxrwxrwx. 1 root root  19 Mar  3 09:50 logs -> ../../var/log/httpd
    lrwxrwxrwx. 1 root root  29 Mar  3 09:50 modules -> ../../usr/lib64/httpd/modules
    lrwxrwxrwx. 1 root root  10 Mar  3 09:50 run -> /run/httpd

/etc/httpd/conf/
    [Contains the main configuration files; 'httpd.conf' and 'magic']
/etc/httpd/conf.d/
    [Contains snap-in files from RPMs; 'ssl.conf', 'userdir.conf', etc.]
    [Files loaded from httpd.conf by the line "IncludeOptional conf.d/*.conf"]
/etc/httpd/conf.modules.d/
    [Contains configuration files used by additional modules; '00-ssl.conf', '01-cgi.conf', etc.]
    [Files loaded from httpd.conf by the line "Include conf.modules.d/*.conf"]
    [Files contain the 'LoadModule' command with <module-name> and path to associated <module>.so file]

@@@
@@@ Exercise 17.2 Installing Apache Virtual Hosts
@@@
    vi /etc/hosts
        192.168.222.100 account.example.com account
        192.168.222.100 sales.example.com sales
        :wq
    vi /etc/httpd/conf/httpd.conf
        <Directory "/www/docs">
            AllowOverride None
            Require all granted
        </Directory>
    vi /etc/httpd/conf.d/account.example.com.conf
        <VirtualHost *:80>
            ServerAdmin webmaster@account.example.com
            DocumentRoot /www/docs/account.example.com
            ServerName account.example.com
            ErrorLog logs/account.example.com-error_log
            CustomLog logs/account.example.com-access_log common
        </VirtualHost>
        :wq
    mkdir -p /www/docs/account.example.com
    echo "Welcome to the account server." | tee /www/docs/account.example.com/index.html
    [Temporarily switch off SELinux]
        setenforce 0
    systemctl restart httpd
    elinks http://account.example.com
        [Welcome to the account server.]
    cp /etc/httpd/conf.d/account.example.com.conf /etc/httpd/conf.d/sales.example.com.conf
    vi /etc/httpd/conf.d/sales.example.com.conf
        :%s/account/sales/g
        :wq
    mkdir -p /www/docs/sales.example.com
    echo "Welcome to the sales server." | tee /www/docs/sales.example.com/index.html
    systemctl restart httpd
    elinks http://account.example.com
        [Welcome to the account server.]
    elinks http://sales.example.com
        [Welcome to the sales server.]
    vi /etc/hosts
        172.25.1.101 account.example.com account
        10.11.12.100 sales.example.com sales
        :wq
    elinks http://account.example.com
        [Welcome to the account server.]
    elinks http://sales.example.com
        [Welcome to the sales server.]
@@@

Review Questions
1. "Basic Web Server"
2. systemctl enable httpd
3. /etc/httpd/conf.d/
4. elinks <web-address>
5. /etc/httpd/conf/httpd.conf
6. /var/www/html/
7. index.html
8. systemctl status httpd
9. /etc/httpd/conf.d/
10. /etc/httpd/

@@@
@@@ Lab 17.1
@@@
    1.  yum groups install "Basic Web Server"
        systemctl enable httpd
    2.  echo "Welcome to my web server." | tee /var/www/html/index.html
    3.  elinks http://localhost
    4.  yum install httpd-manual
    5.  Browse to http://localhost/manual
            [Success]
            [Enabled by /etc/httpd/conf.d/manual.conf]
            [Files located in /usr/share/httpd/manual/]
@@@



18-18-18-18-18-18-18-18-18-18-18-18-18-18-18-18-18-18-18-18-18-18-18-18-18-18-18-18-18-18-18-18-18-18-18-18-18-18-18-18-18-18
18-18                                                                            18-18-18-18-18-18-18-18-18-18-18-18-18-18-18
18-18    Chapter 18: Managing and Understanding the Boot Procedure (22 pg.)      18-18-18-18-18-18-18-18-18-18-18-18-18-18-18
18-18                                                                            18-18-18-18-18-18-18-18-18-18-18-18-18-18-18
18-18-18-18-18-18-18-18-18-18-18-18-18-18-18-18-18-18-18-18-18-18-18-18-18-18-18-18-18-18-18-18-18-18-18-18-18-18-18-18-18-18

Do I Know This Already?
A C D D A B B D B A

Systemd unit types:
    systemctl -t help
        Available unit types:
        service
        socket
        busname
        target
        snapshot
        device
        mount
        automount
        swap
        timer
        path
        slice
        scope

System default unit files: /usr/lib/systemd/system/
System-specific modifications (override defaults): /etc/systemd/system/
Runtime configuration: /run/systemd/system/

Service unit file components:
    - [Unit]
        Description=, After=, Before=
    - [Service]
        Type=, ExecStart=, ExecStop=
    - [Install]
        WantedBy=

systemctl show <unit-name>
    e.g. systemctl show sshd
        Type=forking
        Restart=on-failure
        PIDFile=/var/run/sshd.pid
        ...

@@@
@@@ Exercise 18.1 Managing Units with systemctl
@@@
    yum install vsftpd
    systemctl start vsftpd
    systemctl status vsftpd
        ● vsftpd.service - Vsftpd ftp daemon
           Loaded: loaded (/usr/lib/systemd/system/vsftpd.service; disabled; vendor preset: disabled)
           Active: active (running) since Fri 2017-03-03 14:16:31 CET; 28s ago
          Process: 5508 ExecStart=/usr/sbin/vsftpd /etc/vsftpd/vsftpd.conf (code=exited, status=0/SUCCESS)
         Main PID: 5509 (vsftpd)
           CGroup: /system.slice/vsftpd.service
                   └─5509 /usr/sbin/vsftpd /etc/vsftpd/vsftpd.conf
        Mar 03 14:16:31 server1.example.com systemd[1]: Starting Vsftpd ftp daemon...
        Mar 03 14:16:31 server1.example.com systemd[1]: Started Vsftpd ftp daemon.
    systemctl enable vsftpd
        Created symlink from /etc/systemd/system/multi-user.target.wants/vsftpd.service to /usr/lib/systemd/system/vsftpd.service.
    systemctl status vsftpd
        ● vsftpd.service - Vsftpd ftp daemon
           Loaded: loaded (/usr/lib/systemd/system/vsftpd.service; enabled; vendor preset: disabled)
           Active: active (running) since Fri 2017-03-03 14:16:31 CET; 2min 59s ago
         Main PID: 5509 (vsftpd)
           CGroup: /system.slice/vsftpd.service
                   └─5509 /usr/sbin/vsftpd /etc/vsftpd/vsftpd.conf
        Mar 03 14:16:31 server1.example.com systemd[1]: Starting Vsftpd ftp daemon...
        Mar 03 14:16:31 server1.example.com systemd[1]: Started Vsftpd ftp daemon.
@@@

systemctl list-units --type=service
-OR-
systemctl --type=service
    UNIT                 LOAD      ACTIVE    SUB        DESCRIPTION
    abrt-ccpp.service    loaded    active    exited     Install ABRT coredump hook
    abrt-oops.service    loaded    active    running    ABRT kernel log watcher
    abrt-xorg.service    loaded    active    running    ABRT Xorg log watcher
    ...

systemctl --type=service --all
    UNIT                   LOAD      ACTIVE      SUB        DESCRIPTION
    abrt-ccpp.service      loaded    active      exited     Install ABRT coredump hook
    abrt-oops.service      loaded    active      running    ABRT kernel log watcher
    abrt-vmcore.service    loaded    inactive    dead       Harvest vmcores for ABRT
    ...

systemctl --type=service --failed
      UNIT            LOAD      ACTIVE    SUB       DESCRIPTION
    ● rngd.service    loaded    failed    failed    Hardware RNG Entropy Gatherer Daemon

systemctl status -l <unit-name>
    [Sometimes excessive output is ellipsized; this shows everything]

systemctl list-unit-files --type=service
    UNIT FILE                  STATE
    abrt-ccpp.service          enabled
    abrt-oops.service          enabled
    abrt-pstoreoops.service    disabled
    ...

systemctl list-dependencies <unit-name>
    [List a unit's dependencies; what it depends on]
    e.g. systemctl list-dependencies vsftpd
        vsftpd.service
        ● ├─system.slice
        ● └─basic.target
        ●   ├─alsa-restore.service
        ●   ├─alsa-state.service
        ...

systemctl list-dependencies --reverse <unit-name>
    [List units that are dependent on the specified unit]
    e.g. systemctl list-dependencies --reverse vsftpd
        vsftpd.service
        ● └─multi-user.target
        ●   └─graphical.target

@@@
@@@ Conflicting Units Exercise
@@@
    yum install iptables-services
    cat /usr/lib/systemd/system/firewalld.service | less
        [Unit]
        ...
        Conflicts=iptables.service ip6tables.service ebtables.service ipset.service
        ...
    cat /usr/lib/systemd/system/iptables.service | less
        [No "Conflicts" line]
    systemctl status firewalld
        ● firewalld.service - firewalld - dynamic firewall daemon
           Loaded: loaded (/usr/lib/systemd/system/firewalld.service; enabled; vendor preset: enabled)
           Active: active (running) since Thu 2017-03-02 16:11:43 CET; 22h ago
             Docs: man:firewalld(1)
         Main PID: 798 (firewalld)
           CGroup: /system.slice/firewalld.service
                   └─798 /usr/bin/python -Es /usr/sbin/firewalld --nofork --nopid
    systemctl status iptables
        ● iptables.service - IPv4 firewall with iptables
           Loaded: loaded (/usr/lib/systemd/system/iptables.service; disabled; vendor preset: disabled)
           Active: inactive (dead)
    systemctl start iptables
        ● iptables.service - IPv4 firewall with iptables
           Loaded: loaded (/usr/lib/systemd/system/iptables.service; disabled; vendor preset: disabled)
           Active: active (exited) since Fri 2017-03-03 15:27:55 CET; 38s ago
          Process: 7444 ExecStart=/usr/libexec/iptables/iptables.init start (code=exited, status=0/SUCCESS)
         Main PID: 7444 (code=exited, status=0/SUCCESS)
        [TODO Supposed to fail to start due to "Conflicts" in '.service' definition; starts anyway though]
    systemctl stop firewalld
    systemctl stop iptables
    systemctl mask iptables
        Created symlink from /etc/systemd/system/iptables.service to /dev/null.
    systemctl status iptables
        ● iptables.service
           Loaded: masked (/dev/null; bad)
           Active: inactive (dead) since Fri 2017-03-03 15:30:49 CET; 7min ago
         Main PID: 7676 (code=exited, status=0/SUCCESS)
    systemctl start iptables
        Failed to start iptables.service: Unit is masked.
    systemctl enable iptables
        Failed to execute operation: Cannot send after transport endpoint shutdown
@@@

@@@
@@@ Enabling a Service Unit Exercise
@@@
    systemctl status vsftpd
        ● vsftpd.service - Vsftpd ftp daemon
           Loaded: loaded (/usr/lib/systemd/system/vsftpd.service; enabled; vendor preset: disabled)
           Active: active (running) since Fri 2017-03-03 14:28:21 CET; 1h 17min ago
         Main PID: 5757 (vsftpd)
           CGroup: /system.slice/vsftpd.service
                   └─5757 /usr/sbin/vsftpd /etc/vsftpd/vsftpd.conf
    ls -l /etc/systemd/system/multi-user.target.wants | grep 'vsftpd'
        [No results]
    systemctl enable vsftpd
        Created symlink from /etc/systemd/system/multi-user.target.wants/vsftpd.service to /usr/lib/systemd/system/vsftpd.service.
    ls -l /etc/systemd/system/multi-user.target.wants | grep 'vsftpd'
        lrwxrwxrwx. 1 root root    38 Mar  3 15:48 vsftpd.service -> /usr/lib/systemd/system/vsftpd.service
@@@

[On the exam, don't forget to enable services that need to auto-start after a reboot]

systemctl --type=target
    UNIT                 LOAD      ACTIVE    SUB       DESCRIPTION
    basic.target         loaded    active    active    Basic System
    cryptsetup.target    loaded    active    active    Encrypted Volumes
    getty.target         loaded    active    active    Login Prompts
    graphical.target     loaded    active    active    Graphical Interface
    ...

systemctl --type=target --all
    UNIT                   LOAD      ACTIVE   SUB    DESCRIPTION
    basic.target           loaded    active   active Basic System
    cryptsetup.target      loaded    active   active Encrypted Volumes
  ● dirsrv.target          not-found inactive dead   dirsrv.target
    emergency.target       loaded    inactive dead   Emergency Mode
    ...

RunLevel->Target Mapping (symbolic links in /usr/lib/systemd/system):
    runlevel 0 -> poweroff.target
    runlevel 1 -> rescue.target
    runlevel 2 -> multi-user.target
    runlevel 3 -> multi-user.target
    runlevel 4 -> multi-user.target
    runlevel 5 -> graphical.target
    runlevel 6 -> reboot.target

@@@
@@@ Exercise 18.2 Isolating Targets
@@@
    cd /usr/lib/systemd/system
    grep 'Isolate' *.target
        anaconda.target:AllowIsolate=yes
        ctrl-alt-del.target:AllowIsolate=yes
        default.target:AllowIsolate=yes
        emergency.target:AllowIsolate=yes
        graphical.target:AllowIsolate=yes
        ...
    systemctl isolate rescue.target
        PolicyKit daemon disconnected from the bus.
        We are no longer a registered authentication agent.
    systemctl isolate reboot.target
        [Reboots; don't need to be in /usr/lib/systemd/system for the command to work]
@@@

systemctl get-default
    graphical.target
systemctl set-default <target>.target
    e.g. systemctl set-default multi-user.target
        Removed symlink /etc/systemd/system/default.target.
        Created symlink from /etc/systemd/system/default.target to /usr/lib/systemd/system/multi-user.target.

GRUB 2 starting point for configuration:
    /etc/default/grub

Other GRUB 2 config files:
    /etc/grub.d/

GRUB 2 main config file (DO NOT EDIT THIS FILE):
    /boot/grub2/grub.cfg
    [Pulls boot menu kernel entries from config files in /etc/grub.d/]
    [After each "linux16", shows kernel boot options for that menu entry]

[GRUB 2 adds support for extended functionality via modules, available in /boot/grub2/i386-pc/]

[Recommend removing 'rhgb' and 'quiet' from the boot parameters in /etc/default/grub]

man 7 bootparam
    [Description of boot-time parameters for the kernel]

@@@
@@@ Exercise 18.3 Applying Modifications to GRUB2
@@@
    vi /etc/default/grub
        [Remove 'rhgb' and 'quiet' from the 'GRUB_CMDLINE_LINUX' parameter]
        [Change the 'GRUB_TIMEOUT' parameter from '5' to '10' seconds]
        :wq
    grub2-mkconfig -o /boot/grub2/grub.cfg
    -OR-
    grub2-mkconfig > /boot/grub2/grub.cfg
        Generating grub configuration file ...
        Found linux image: /boot/vmlinuz-3.10.0-514.6.2.el7.x86_64
        Found initrd image: /boot/initramfs-3.10.0-514.6.2.el7.x86_64.img
        Found linux image: /boot/vmlinuz-3.10.0-514.6.1.el7.x86_64
        Found initrd image: /boot/initramfs-3.10.0-514.6.1.el7.x86_64.img
        Found linux image: /boot/vmlinuz-3.10.0-514.el7.x86_64
        Found initrd image: /boot/initramfs-3.10.0-514.el7.x86_64.img
        Found linux image: /boot/vmlinuz-0-rescue-b101d0db23e44e9f9a4be5f01ca6416e
        Found initrd image: /boot/initramfs-0-rescue-b101d0db23e44e9f9a4be5f01ca6416e.img
        done
    reboot
        [Check for a longer menu timeout and for messages scrolling by on the screen]
@@@

Review Questions
1. Something started by systemd, like a service, target, mount, socket, etc.
2. systemctl mask <target-name>.target
3. /etc/default/grub
4. systemctl --type=service
5. systemctl enable <service-name>
6. systemctl isolate rescue.target
7. Doesn't have the "AllowIsolate=yes" parameter
8. systemctl list-dependencies --reverse <service-name>
9. /etc/default/grub
10. grub2-mkconfig > /boot/grub2/grub.cfg

@@@
@@@ Lab 18.1
@@@
    systemctl enable firewalld
    systemctl mask iptables
@@@

@@@
@@@ Lab 18.2
@@@
    vi /etc/default/grub
        [Remove 'rhgb' and 'quiet' from the 'GRUB_CMDLINE_LINUX' parameter]
        :wq
    grub2-mkconfig > /boot/grub2/grub.cfg
        Generating grub configuration file ...
        Found linux image: /boot/vmlinuz-3.10.0-514.6.2.el7.x86_64
        Found initrd image: /boot/initramfs-3.10.0-514.6.2.el7.x86_64.img
        Found linux image: /boot/vmlinuz-3.10.0-514.6.1.el7.x86_64
        Found initrd image: /boot/initramfs-3.10.0-514.6.1.el7.x86_64.img
        Found linux image: /boot/vmlinuz-3.10.0-514.el7.x86_64
        Found initrd image: /boot/initramfs-3.10.0-514.el7.x86_64.img
        Found linux image: /boot/vmlinuz-0-rescue-b101d0db23e44e9f9a4be5f01ca6416e
        Found initrd image: /boot/initramfs-0-rescue-b101d0db23e44e9f9a4be5f01ca6416e.img
        done
@@@



19-19-19-19-19-19-19-19-19-19-19-19-19-19-19-19-19-19-19-19-19-19-19-19-19-19-19-19-19-19-19-19-19-19-19-19-19-19-19-19-19-19
19-19                                                                19-19-19-19-19-19-19-19-19-19-19-19-19-19-19-19-19-19-19
19-19    Chapter 19: Troubleshooting the Boot Procedure (20 pg.)     19-19-19-19-19-19-19-19-19-19-19-19-19-19-19-19-19-19-19
19-19                                                                19-19-19-19-19-19-19-19-19-19-19-19-19-19-19-19-19-19-19
19-19-19-19-19-19-19-19-19-19-19-19-19-19-19-19-19-19-19-19-19-19-19-19-19-19-19-19-19-19-19-19-19-19-19-19-19-19-19-19-19-19

Do I Know This Already?
C B B D A&C B C C A C

The Linux boot procedure:
1. Performing Power-On Self Test (POST) - hardware initialized from UEFI/BIOS firmware
2. Selecting the bootable device - bootable device located from UEFI firmware or Master Boot Record (MBR)
3. Loading the boot loader - from the bootable device, the boot loader is loaded; usually GRUB 2
4. Loading the kernel - boot loader presents a boot menu; kernel loaded together with initramfs
5. Starting /sbin/init - kernel loaded into memory; /sbin/init process and udev daemon loaded from initramfs image
6. Processing initrd.target - systemd executes all initrd.target units; root fs on disk mounted on /sysroot
7. Switching to the root file system - system switches to root fs on disk; systemd process loaded from disk
8. Running the default target - systemd executes all default.target units; login screen presented; 90% loaded

@@@
@@@ Exercise 19.1 Exploring troubleshooting targets
@@@
    [Restart the Linux server]
    [At the GRUB 2 menu, select the first line and hit 'e']
    [Find the line "linux16 /vmlinuz"; remove 'rhgb' and 'quiet'; add 'systemd.unit=rescue.target']
    Ctrl-X
        "Welcome to emergency mode! After logging in, type 'journalctl -xb' to view
         system logs, 'systemctl reboot' to reboot, 'systemctl default' or ^D to
         boot into default mode."
         "Give the root password for maintenance"
            [Enter the root password]
    systemctl list-units
        [80 active units; 25 active services]
    systemctl show-environment
        [Displays environment variables 'LANG' and 'PATH']
    systemctl reboot
    [At the GRUB 2 menu, select the first line and hit 'e']
    [Find the line "linux16 /vmlinuz"; add 'systemd.unit=emergency.target']
    Ctrl-X
        "Welcome to emergency mode! After logging in, type 'journalctl -xb' to view
         system logs, 'systemctl reboot' to reboot, 'systemctl default' or ^D to
         try again to boot into default mode."
         "Give the root password for maintenance"
            [Enter the root password]
    systemctl list-units
        [10 active units; 3 active services]
@@@

@@@
@@@ Exercise 19.2 Using the Rescue Option
@@@
    [Restart the Linux server and load the Installation Disk]
    [Select the "Troubleshooting" menu option]
    [Select the "Rescue a CentOS (Red Hat) Linux system"]
    [Select option '1' to find the Linux installation and mount it on '/mnt/sysimage']
    [Press 'Enter' to get to a shell]
    ls
        bin     dev    firmware           lib      lost+found    modules    root    sbin    tmp    var
        boot    etc    imjournal.state    lib64    mnt           proc       run     sys     usr
    [Missing: 1, data, files, groups, home, media, opt, srv, www]
    [Extra: firmware, imjournal.state, lost+found, modules]
    chroot /mnt/sysimage
        [Rebuild GRUB 2]
            lsblk
                [Identify the primary disk]
                grub2-install /dev/sda
                Installing for i386-pc platform.
                Installation finished. No error reported.
        [Rebuild initramfs]
            ls /usr/lib/dracut/dracut.conf.d/*
                [System default dracut configuration files]
            ls /etc/dracut.conf.d/*
                [Custom dracut configuration files]
            ls /etc/dracut.conf
                [The default dracut configuration file]
            dracut
                Will not override existing initramfs (/boot/initramfs-3.10.0-514.el7.x86_64.img) without --force
            dracut --force
        exit
    reboot
@@@

[If an /etc/fstab entry is incorrect, the system will wait 90 seconds during boot before going to emergency mode]
["Give root password for maintenance" is a 'fsck' prompt]
journalctl -xb -p err

@@@
@@@ Reset the Root Password Exercise
@@@
    [Restart the Linux server]
    [At the GRUB2 menu, select the first line and hit 'e']
    [Find the line "linux16 /vmlinuz"; add 'rd.break']
    Ctrl-X
        [Generating "/run/initramfs/rdsosreport.txt"]
    [No root login required]
    ls
        bin    dracut-state.sh    etc     kernel    lib64    root    sbin        sys        tmp     var
        dev    early_cpio         init    lib       proc     run     shutdown    sysroot    user
    mount -o remount,rw /sysroot
        [Changes the /sysroot mount from 'ro' to 'rw']
    chroot /sysroot
        ls
            bin     dev    firmware           lib      lost+found    modules    root    sbin    tmp    var
            boot    etc    imjournal.state    lib64    mnt           proc       run     sys     usr
        passwd
            [Changing password for user root.]
        [This changes the SELinux policy on /etc/shadow to 'unlabeled_t', which will prevent any user from logging in]
        [Fix SELinux labels by running 'load_policy -i' and 'chcon -t shadow_t /etc/shadow' (or 'restorecon /etc/shadow')]
        [Easier method is to execute 'touch /.autorelabel'; but full SELinux relabel can take a long time at next boot]
        exit
    reboot [or 'exit' again]
@@@

@@@
@@@ Recover a Virtual Machine Exercise
@@@
    virsh list --all
    virsh destroy smallvm1
    virsh dumpxml smallvm1 | grep "source file="
        <source file='/var/lib/libvirt/images/smallvm1.qcow2'/>
    cd /var/lib/libvirt/images

    [kpartx doesn't work on .qcow2 images, only .img (raw) images]
        qemu-img convert -f qcow2 -O raw smallvm1.qcow2 smallvm1.img
        kpartx -av /var/lib/libvirt/images/smallvm1.img
            add map loop2p1 (253:2): 0 2097152 linear /dev/loop2 2048
            add map loop2p2 (253:3): 0 6289408 linear /dev/loop2 2099200

    [Check partitions]
        fdisk /dev/loop0
            p
                 Device Boot      Start         End      Blocks   Id  System
                loop2p1   *        2048     2099199     1048576   83  Linux
                loop2p2         2099200     8388607     3144704   8e  Linux LVM

    [Scan for physical volumes]
        pvscan
            PV /dev/sda2             VG cl              lvm2 [19.00 GiB / 0    free]
            PV /dev/mapper/loop0p2   VG cl              lvm2 [3.00 GiB / 0    free]
            Total: 2 [21.99 GiB] / in use: 2 [21.99 GiB] / in no VG: 0 [0   ]

    [Check logical volumes]
        lvs
            LV   VG Attr       LSize   Pool Origin Data%  Meta%  Move Log Cpy%Sync Convert
            root cl -wi-ao----  17.00g
            root cl -wi-------   2.59g
            swap cl -wi-ao----   2.00g
            swap cl -wi------- 412.00m

    [Activate the logical volumes]
        vgchange -a y cl
            Multiple VGs found with the same name: skipping cl
            Use --select vg_uuid=<uuid> in place of the VG name.

        vgdisplay | grep -e "VG Size" -e "VG UUID"
            VG Size               19.00 GiB
            VG UUID               ChEJVX-pt1U-xOEH-70Un-0nhu-ISiU-KfchcF
            VG Size               3.00 GiB
            VG UUID               u40VVm-VJfe-y0E8-kGSr-L2TL-7Kwm-yzZxPw

        vgrename u40VVm-VJfe-y0E8-kGSr-L2TL-7Kwm-yzZxPw vg_small
            Processing VG cl because of matching UUID u40VVm-VJfe-y0E8-kGSr-L2TL-7Kwm-yzZxPw
            Volume group "u40VVm-VJfe-y0E8-kGSr-L2TL-7Kwm-yzZxPw" successfully renamed to "vg_small"

        vgchange -a y vg_small
            2 logical volume(s) in volume group "vg_small" now active

        lvs
            LV   VG       Attr       LSize   Pool Origin Data%  Meta%  Move Log Cpy%Sync Convert
            root cl       -wi-ao----  17.00g
            swap cl       -wi-ao----   2.00g
            root vg_small -wi-a-----   2.59g
            swap vg_small -wi-a----- 412.00m

    mkdir /root2
    mount /dev/mapper/vg_small-root /root2
    mount /dev/mapper/loop0p1 /root2/boot
    mount -o bind /dev /root2/dev
    mount -o bind /proc /root2/proc
    mount -o bind /sys /root2/sys
    chroot /root2
    dracut --force
    grub2-mkconfig -o /boot/grub2/grub.cfg
    exit

    umount /root2/dev
    umount /root2/proc
    umount /root2/sys
    umount /root2/boot
    umount /root2
    vgchange -a n vg_small
    kpartx -dv /var/lib/libvirt/images/smallvm1.img
        del devmap : loop0p2
        del devmap : loop0p1
        loop deleted : /dev/loop0

    [Convert from .img back to .qcow2]
        qemu-img convert -f raw -O qcow2 smallvm1.img smallvm1.qcow2
@@@

Review Questions
1. e
2. Problem with /etc/fstab
3. rd.break (NOT systemd.unit=rescue.target)
4. Use a rescue disk
5. systemctl list-units
6. rd.break
7. load_policy -i
8. chcon -t shadow_t /etc/shadow (or better, 'restorecon /etc/shadow')
9. grub2-mkconfig -o /boot/grub2/grub.cfg
10. systemd.unit=emergency.target

@@@
@@@ Lab 19.1
@@@
    1.  [Wait for the GRUB 2 boot menu]
        e
        rd.break
        Ctrl+X
        mount -o remount,rw /sysroot
        chroot /sysroot
        passwd
            [Change the password]
        load_policy -i
        restorecon /etc/shadow
        exit
        reboot
    2.  [Corrupt /etc/fstab so that boot fails]
            vi /etc/fstab
                [Change the boot UUID]
                :wq
            reboot
        ["Give root password for maintenance"]
            [Enter the root password]
            vi /etc/fstab
                [Fix the boot UUID]
                :wq
            reboot
    3.  [Restart the Linux server with a rescue disk mounted]
        [Select the "Troubleshooting" menu option]
        [Select the "Rescue a CentOS (Red Hat) Linux system"]
        [Select option '1' to find the Linux installation and mount it on '/mnt/sysimage']
        [Press 'Enter' to get to a shell]
    4.  dracut --force <kernel-name>
@@@



# # # # # # # # # # # # # # # # # # # # #
#                                       #
#  Part 1-4: Managing Network Services  #
#                                       #
# # # # # # # # # # # # # # # # # # # # #


20-20-20-20-20-20-20-20-20-20-20-20-20-20-20-20-20-20-20-20-20-20-20-20-20-20-20-20-20-20-20-20-20-20-20-20-20-20-20-20-20-20
20-20                                              20-20-20-20-20-20-20-20-20-20-20-20-20-20-20-20-20-20-20-20-20-20-20-20-20
20-20    Chapter 20: Using Kickstart (21 pg.)      20-20-20-20-20-20-20-20-20-20-20-20-20-20-20-20-20-20-20-20-20-20-20-20-20
20-20                                              20-20-20-20-20-20-20-20-20-20-20-20-20-20-20-20-20-20-20-20-20-20-20-20-20
20-20-20-20-20-20-20-20-20-20-20-20-20-20-20-20-20-20-20-20-20-20-20-20-20-20-20-20-20-20-20-20-20-20-20-20-20-20-20-20-20-20

Do I Know This Already?
B A&B D C B A B C B D

[The network server can be NFS, FTP, or HTTP]
[Need to provide the boot image via PXE boot by a TFTP server, working with the DHCP server]
[A Kickstart file is provided by the installation server; it is an answer file]

@@@
@@@ Exercise 20.1 Setting Up the Network Installation Server
@@@
    [If using VirtualBox, use network type "Internal Network"]
    [Load an Installation Disk; mount it on /mnt]
    mkdir /www/docs/account.example.com/install
    cp -r /mnt/. /www/docs/account.example.com/install
    vi /etc/httpd/conf.d/account.example.com.conf
        Options Indexes
    systemctl restart httpd
    elinks http://account.example.com/install
    elinks http://192.168.222.100/install

    virt-manager &
        File -> New Virtual Machine
            Network Install -> Forward
            URL: http://account.example.com/install -> Forward
            1536 MiB RAM & 2 CPUs -> Forward
            6.0 GiB storage -> Forward
            Name: testnetinstall -> Finish
@@@

@@@
@@@ Configuring the TFTP Server for PXE Boot (NOT HOW THE BOOK DOES IT, BUT BETTER)
@@@
    yum provides */semanage
        yum install policycoreutils-python

    yum install httpd
    mkdir /var/www/install

    mount /dev/cdrom /var/www/install
    -OR-
    mount -o loop /root/CentOS7.iso /var/www/install

    systemctl start httpd
    systemctl enable httpd

    mkdir -p /var/lib/tftpboot/pxelinux/pxelinux.cfg
    restorecon -R /var/lib/tftpboot

    vi /var/lib/tftpboot/pxelinux/pxelinux.cfg/default
        DEFAULT vesamenu.c32
        PROMPT 0
        TIMEOUT 300
        MENU TITLE PXE Boot Menu
        LABEL Linux
            MENU LABEL ^Install RHEL
            MENU default
            KERNEL vmlinuz
            APPEND initrd=initrd.img inst.repo=http://<local-ip>/install
        :wq

    yum install syslinux
    cp /usr/share/syslinux/pxelinux.0 /var/lib/tftpboot/pxelinux
    cp /usr/share/syslinux/vesamenu.c32 /var/lib/tftpboot/pxelinux
    cp /var/www/install/images/pxeboot/vmlinuz /var/lib/tftpboot/pxelinux
    cp /var/www/install/images/pxeboot/initrd.img /var/lib/tftpboot/pxelinux

    firewall-cmd --add-service=dhcp --permanent
        success
    firewall-cmd --add-service=tftp --permanent
        success
    firewall-cmd --add-service=http --permanent
        success
    firewall-cmd --reload
        success

    [IF ON THE HYPERVISOR]
        virsh net-edit default
            <ip address='192.168.122.1' netmask='255.255.255.0'>
              <tftp root='/var/lib/tftpboot'/>
              <dhcp>
                <range start='192.168.122.2' end='192.168.122.254'/>
                <bootp file='pxelinux/pxelinux.0'/>
              </dhcp>
            </ip>

    [IF ON A HYPERVISOR-HOSTED VM]
        vi /etc/dnsmasq.conf
            150 <Enter>
            dhcp-range=192.168.187.240,192.168.187.249,255.255.255.0,12h
            160 <Enter>
            dhcp-option=3,192.168.187.2
            100 <Enter>
            dhcp-boot=pxelinux.0
            57 <Enter>
            enable-tftp
            3 <Enter>
            tftp-root=/var/lib/tftpboot/pxelinux
            :wq
        systemctl start dnsmasq
        systemctl enable dnsmasq

    tail -f /var/log/messages
    [Start a server on this network and select PXE Boot in the boot menu]
@@@

@@@
@@@ Exercise 20.2 Configuring the TFTP Server for PXE Boot (DON'T USE THIS; USE THE ABOVE METHOD INSTEAD)
@@@
    yum install xinetd
    yum install tftp-server
    mkdir /var/lib/tftpboot/pxelinux
    vi /etc/xinetd.d/tftp
        disable = no
    systemctl start xinetd
    systemctl enable xinetd

    yum install dhcp
    systemctl enable dhcpd
    vi /etc/dhcp/dhcpd.conf
        subnet 192.168.222.0 netmask 255.255.255.0 {
            option routers 192.168.222.1;
            range 192.168.222.240 192.168.222.250;
            next-server 192.168.222.100;
            filename "pxelinux/pxelinux.0";
        }

        cp /www/docs/account.example.com/install/Packages/syslinux-4.05-13.el7.x86_64.rpm /tmp
        cd /tmp
        rpm2cpio syslinux-4.05-13.el7.x86_64.rpm | cpio -idmv
        cp /tmp/usr/share/syslinux/pxelinux.0 /var/lib/tftpboot/pxelinux/
    -OR-
        yum install syslinux
        cp /usr/share/syslinux/pxelinux.0 /var/lib/tftpboot/pxelinux/
        cp /usr/share/syslinux/vesamenu.c32 /var/lib/tftpboot/pxelinux/

    mkdir /var/lib/tftpboot/pxelinux/pxelinux.cfg
    vi /var/lib/tftpboot/pxelinux/pxelinux.cfg/default
        DEFAULT vesamenu.c32
        PROMPT 0
        TIMEOUT 300
        MENU TITLE PXE Boot Menu
        LABEL Linux
            MENU LABEL ^Install RHEL Manually
            MENU default
            KERNEL vmlinuz
            APPEND initrd=initrd.img inst.repo=http://192.168.222.100/install
        LABEL Rescue
            MENU LABEL ^Rescue System
            KERNEL vmlinuz
            APPEND initrd=initrd.img rescue
        LABEL Local
            MENU LABEL Boot from ^Local Drive
            LOCALBOOT 0
        LABEL Tools
            MENU LABEL Tools
            KERNEL vesamenu.c32
            APPEND pxelinux.cfg/tools
        :wq
    [Optional, but seems to do nothing]
        cp /boot/grub/splash.xpm.gz /var/lib/tftpboot/pxelinux

    cp /www/docs/account.example.com/install/images/pxeboot/vmlinuz /var/lib/tftpboot/pxelinux
    cp /www/docs/account.example.com/install/images/pxeboot/initrd.img /var/lib/tftpboot/pxelinux

    systemctl restart dhcpd
    systemctl restart xinetd

    firewall-cmd --permanent --add-service=dhcp
        success
    firewall-cmd --permanent --add-service=tftp
        success
    firewall-cmd --permanent --add-service=http
        success
    firewall-cmd --reload
        success

    tail -f /var/log/messages
    [Start a server on this network and select PXE Boot in the boot menu]
@@@

@@@
@@@ Exercise 20.3 Performing a Virtual Machine Network Installation Using a Kickstart File
@@@
    [REQUIRES AT LEAST 1280MB RAM!]

    scp 192.168.222.241:/root/anaconda-ks.cfg /www/docs/account.example.com
    chmod 644 /www/docs/account.example.com/anaconda-ks.cfg

    vi /var/lib/tftpboot/pxelinux/pxelinux.cfg/default
        [Add the following to the 'pxelinux.cfg/default' file]
        LABEL Kickstart
            MENU LABEL Install RHEL using ^Kickstart
            KERNEL vmlinuz
            APPEND initrd=initrd.img inst.repo=http://192.168.222.100/install inst.ks=http://192.168.222.100/anaconda-ks.cfg
        :wq

    [Start a server on this network and select PXE Boot in the boot menu]
    [The server will skip straight to the graphical installation without intervention]
@@@

GUI for creating/modifying Kickstart:
    system-config-kickstart
    system-config-kickstart /root/anaconda-ks.cfg

Manually modifying Kickstart:
    Change '--device=enp0s3' to '--device=eth0'
    Remove the entire line 'rootpw'
        [This will cause the installation process to prompt for a new root password]

Validate a Kickstart file:
    ksvalidator /www/docs/account.example.com/ks.cfg
    [No output indicates a good file]

Review Questions
1. /root/anaconda-ks.cfg
2. system-config-kickstart
3. LVM logical volumes, individual RPM packages, firewalld configurations
4. inst.ks=http://server.example.com/kickstart.cfg
5. A network-based installation repository (HTTP, FTP, NFS), a TFTP server with the boot image, a DHCP server pointing to the TFTP server and boot image name
6. xinetd
7. /var/lib/tftpboot/pxelinux/pxelinux.cfg/default
8. syslinux
9. RHN (boot.iso)
10. /var/lib/tftpboot/

@@@
@@@ Lab 20.1
@@@
    1.  [Set up a HTTP installation server]
    2.  [Set up a TFTP server and DHCP server]
    3.  [Create a basic Kickstart file]
            [Put /home on a dedicated partition or logical volume]
            [Install the 'nmap' package]
    4.  [Install a VM using this configuration]
@@@



21-21-21-21-21-21-21-21-21-21-21-21-21-21-21-21-21-21-21-21-21-21-21-21-21-21-21-21-21-21-21-21-21-21-21-21-21-21-21-21-21-21
21-21                                              21-21-21-21-21-21-21-21-21-21-21-21-21-21-21-21-21-21-21-21-21-21-21-21-21
21-21    Chapter 21: Managing SELinux (24 pg.)     21-21-21-21-21-21-21-21-21-21-21-21-21-21-21-21-21-21-21-21-21-21-21-21-21
21-21                                              21-21-21-21-21-21-21-21-21-21-21-21-21-21-21-21-21-21-21-21-21-21-21-21-21
21-21-21-21-21-21-21-21-21-21-21-21-21-21-21-21-21-21-21-21-21-21-21-21-21-21-21-21-21-21-21-21-21-21-21-21-21-21-21-21-21-21

Do I Know This Already?
D A-AND-D A D C D B B A D

Changing between SELinux enabled and disabled requires a reboot; set here:
    vi /etc/sysconfig/selinux
        SELINUX=enforcing
        -OR-
        SELINUX=permissive
        -OR-
        SELINUX=disabled

When SELinux is enabled, the system can switch between 'enforcing' and 'permissive':
    setenforce 1
    getenforce
        Enforcing
    setenforce 0
    getenforce
        Permissive
    [Doesn't change 'SELINUX=' setting in /etc/sysconfig/selinux]

sestatus
    SELinux status:                 enabled
    SELinuxfs mount:                /sys/fs/selinux
    SELinux root directory:         /etc/selinux
    Loaded policy name:             targeted
    Current mode:                   permissive
    Mode from config file:          enforcing
    Policy MLS status:              enabled
    Policy deny_unknown status:     allowed
    Max kernel policy version:      28

sestatus -v
    [Same section as above]

    Process contexts:
    Current context:                unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c1023
    Init context:                   system_u:system_r:init_t:s0
    /usr/sbin/sshd                  system_u:system_r:sshd_t:s0-s0:c0.c1023

    File contexts:
    Controlling terminal:           unconfined_u:object_r:user_devpts_t:s0
    /etc/passwd                     system_u:object_r:passwd_file_t:s0
    /etc/shadow                     system_u:object_r:shadow_t:s0
    /bin/bash                       system_u:object_r:shell_exec_t:s0
    /bin/login                      system_u:object_r:login_exec_t:s0
    /bin/sh                         system_u:object_r:bin_t:s0 -> system_u:object_r:shell_exec_t:s0
    /sbin/agetty                    system_u:object_r:getty_exec_t:s0
    /sbin/init                      system_u:object_r:bin_t:s0 -> system_u:object_r:init_exec_t:s0
    /usr/sbin/sshd                  system_u:object_r:sshd_exec_t:s0

@@@
@@@ Exercise 21.1 Manipulating SELinux Modes
@@@
    getenforce
        Enforcing
    setenforce 0
    getenforce
        Permissive
    vi /etc/sysconfig/selinux
        SELINUX=disabled
        :wq
    reboot
    getenforce
        Disabled
    setenforce 1
        setenforce: SELinux is disabled
    vi /etc/sysconfig/selinux
        SELINUX=enforcing
        :wq
    reboot
    sestatus -v
        [Shows SELinux status]
@@@

[DO NOT edit /etc/sysconfig/selinux during the exam!]

SELinux context labels can apply to:
    - files
    - directories
    - ports
    - processes
    - users

ls -Z /
    -rw-r--r--. root root system_u:object_r:etc_runtime_t:s0 1
    lrwxrwxrwx. root root system_u:object_r:bin_t:s0       bin -> usr/bin
    dr-xr-xr-x. root root system_u:object_r:boot_t:s0      boot
    drwxr-xr-x+ root root unconfined_u:object_r:default_t:s0 data
    ...

ps auxZ | sort -rk5
    LABEL                                       USER     PID   %CPU   %MEM        VSZ      RSS   TTY   STAT   START   TIME   COMMAND
    system_u:system_r:xdm_t:s0-s0:c0.c1023      gdm     2970    0.3    5.1    1378064    96372     ?   Sl     20:58   0:02   gnome-shell --mode=gdm
    system_u:system_r:firewalld_t:s0            root     875    0.0    1.4     327268    26744     ?   Ssl    20:57   0:00   /usr/bin/python -Es /usr/sbin/firewalld --nofork --nopid
    system_u:system_r:xdm_t:s0-s0:c0.c1023      gdm     3046    0.0    1.0     713768    18888     ?   Sl     20:58   0:00   /usr/libexec/goa-daemon
    system_u:system_r:virtd_t:s0-s0:c0.c1023    root    1415    0.0    1.0     623060    20348     ?   Ssl    20:57   0:00   /usr/sbin/libvirtd
    ...

netstat -peanutZ
    Active Internet connections (servers and established)
    Proto   Recv-Q   Send-Q    Local Address       Foreign Address   State     User    Inode    PID/Program name   Security Context
    tcp          0        0    0.0.0.0:111         0.0.0.0:*         LISTEN    0       15072    1/systemd          system_u:system_r:init_t:s0
    tcp          0        0    192.168.122.1:53    0.0.0.0:*         LISTEN    0       25054    2794/dnsmasq       system_u:system_r:dnsmasq_t:s0-s0:c0.c1023
    tcp          0        0    0.0.0.0:22          0.0.0.0:*         LISTEN    0       22418    1748/sshd          system_u:system_r:sshd_t:s0-s0:c0.c1023
    ...

Context label parts:
    - User ('_u')
    - Role ('_r')
    - Type ('_t')

'semanage' vs. 'chcon'
    [semanage writes context info to the SELinux policy, then applies it to the file system]
    [chcon only writes context info to the file system]
    [Contexts written by chcon will be overwritten by a file system relabel, or by reapplication of the policy]
    [DO NOT USE chcon!]

yum provides */semanage
yum install policycoreutils-python

semanage fcontext -a -t <context> "/mydir(/.*)?"
restorecon -R -v /mydir

man semanage
    G
    semanage-fcontext (8)

man semanage-fcontext
    /example
    [Good examples]

@@@
@@@ Exercise 21.2 Setting a Context Label on a Nondefault Apache Document Root
@@@
    mkdir /web
    vi /web/index.html
        Welcome to my web server for SELinux testing.
        :wq
    cp /etc/httpd/conf/httpd.conf /etc/httpd/conf/httpd.conf.BAK
    vi /etc/httpd/conf/httpd.conf
        DocumentRoot "/web"
        <Directory "/web">
            AllowOverride None
            Require all granted
        </Directory>
        :wq
    systemctl restart httpd
    elinks http://localhost
        [Default Red Hat web page; not what we want]
    setenforce 0
    elinks http://localhost
        Welcome to my web server for SELinux testing.
    setenforce 1
    ls -laZ /web
        drwxr-xr-x. root root unconfined_u:object_r:default_t:s0 .
        dr-xr-xr-x. root root system_u:object_r:root_t:s0      ..
        -rw-r--r--. root root unconfined_u:object_r:default_t:s0 index.html
    semanage fcontext -a -t httpd_sys_content_t "/web(/.*)?"
    restorecon -R -v /web
        restorecon reset /web context unconfined_u:object_r:default_t:s0->unconfined_u:object_r:httpd_sys_content_t:s0
        restorecon reset /web/index.html context unconfined_u:object_r:default_t:s0->unconfined_u:object_r:httpd_sys_content_t:s0
    ls -laZ /web
        drwxr-xr-x. root root unconfined_u:object_r:httpd_sys_content_t:s0 .
        dr-xr-xr-x. root root system_u:object_r:root_t:s0      ..
        -rw-r--r--. root root unconfined_u:object_r:httpd_sys_content_t:s0 index.html
    elinks http://localhost
        Welcome to my web server for SELinux testing.
@@@

[TODO Practice this next exercise a lot!]

@@@
@@@ Exercise 21.3 Installing SELinux-Specific Man Pages
@@@
    man -k _selinux
        pam_selinux (8)      - PAM module to set the default security context
    yum provides */sepolicy
    yum install policycoreutils-devel
    sepolicy manpage -a -p /usr/share/man/man8
        [Adds 823 _selinux man pages]
    man -k _selinux
        pam_selinux (8)      - PAM module to set the default security context
        [No change yet; need to rebuild man database]
    mandb
        [Processing]
    man -k _selinux
    man -k _selinux | grep 'http'
        apache_selinux (8)   - Security Enhanced Linux Policy for the httpd processes
        httpd_helper_selinux (8) - Security Enhanced Linux Policy for the httpd_helper processes
        httpd_passwd_selinux (8) - Security Enhanced Linux Policy for the httpd_passwd processes
        httpd_php_selinux (8) - Security Enhanced Linux Policy for the httpd_php processes
        httpd_rotatelogs_selinux (8) - Security Enhanced Linux Policy for the httpd_rotatelogs processes
        httpd_selinux (8)    - Security Enhanced Linux Policy for the httpd processes
        httpd_suexec_selinux (8) - Security Enhanced Linux Policy for the httpd_suexec processes
        httpd_sys_script_selinux (8) - Security Enhanced Linux Policy for the httpd_sys_script processes
        httpd_unconfined_script_selinux (8) - Security Enhanced Linux Policy for the httpd_unconfined_script processes
        httpd_user_script_selinux (8) - Security Enhanced Linux Policy for the httpd_user_script processes
    man httpd_selinux
        [Read through this man page]
@@@

[New files inherit the context from their parent directory]
[Copied files inherit the context from their parent directory]
[Moved files, or files copied with 'cp -a', retain their original context]

Can relabel the filesystem two ways:
    touch /.autorelabel -> reboot
    -OR-
    restorecon -Rv /

@@@
@@@ Exercise 21.4 Using restorecon to Relabel Files
@@@
    ls -Z /etc/hosts
        -rw-r--r--. root root system_u:object_r:net_conf_t:s0  /etc/host
                                                ^^^^^^^^^^
    cp /etc/hosts ~
    ls -Z ~/hosts
        -rw-r--r--. root root unconfined_u:object_r:admin_home_t:s0 /root/hosts
                                                    ^^^^^^^^^^^^
    \mv ~/hosts /etc
    ls -Z /etc/hosts
        -rw-r--r--. root root unconfined_u:object_r:admin_home_t:s0 /etc/hosts
                                                    ^^^^^^^^^^^^
    restorecon -v /etc/hosts
        restorecon reset /etc/hosts context unconfined_u:object_r:admin_home_t:s0->unconfined_u:object_r:net_conf_t:s0
                                                                  ^^^^^^^^^^^^                           ^^^^^^^^^^
    ls -Z /etc/hosts
        -rw-r--r--. root root unconfined_u:object_r:net_conf_t:s0 /etc/hosts
                                                    ^^^^^^^^^^
    touch ./autorelabel
    reboot
@@@

Show SELinux Booleans:
    getsebool -a
        abrt_anon_write --> off
        abrt_handle_event --> off
        abrt_upload_watch_anon_write --> on
        ...
        [Alphabetical order; only shows current state]
    -OR-
    semanage boolean -l
        SELinux boolean        State  Default    Description
        privoxy_connect_any    (on   ,   on)     Determine whether privoxy can connect to all tcp ports.
        smartmon_3ware         (off  ,  off)     Determine whether smartmon can support devices on 3ware controllers.
        mpd_enable_homedirs    (off  ,  off)     Determine whether mpd can traverse user home directories.
        ...
        [Not sorted; shows current state and default; provides description]

Change SELinux Boolean values:
    setsebool <boolean-name> on
    setsebool <boolean-name> off
        [Applies to current runtime only]
    setsebool -P <boolean-name> on
    setsebool -P <boolean-name> off
        [Permanent change]

@@@
@@@ Exercise 21.5 Working with SELinux Booleans
@@@
    getsebool -a | grep 'ftp'
        ftpd_anon_write --> off
        ...
    setsebool ftpd_anon_write on
    getsebool ftpd_anon_write
        ftpd_anon_write --> on
    semanage boolean -l | grep 'ftpd_anon_write'
        ftpd_anon_write    (on   ,  off)    Determine whether ftpd can modify public files used for public file transfer services. Directories/Files must be labeled public_content_rw_t.
                            ^^      ^^^
    setsebool -P ftpd_anon_write on
    semanage boolean -l | grep 'ftpd_anon_write'
        ftpd_anon_write    (on   ,   on)    Determine whether ftpd can modify public files used for public file transfer services. Directories/Files must be labeled public_content_rw_t.
                            ^^       ^^
@@@

grep AVC /var/log/audit/audit.log
    type=AVC msg=audit(1489061405.591:403): avc:  denied  { read } for  pid=8816 comm="rpm" name="hosts" dev="dm-0" ino=9400290 scontext=
        system_u:system_r:setroubleshootd_t:s0-s0:c0.c1023 tcontext=unconfined_u:object_r:admin_home_t:s0 tclass=file
    type=USER_AVC msg=audit(1489062601.800:253): pid=1 uid=0 auid=4294967295 ses=4294967295 subj=system_u:system_r:init_t:s0 msg='avc:
        received policyload notice (seqno=2)  exe="/usr/lib/systemd/systemd" sauid=0 hostname=? addr=? terminal=?'

yum provides */sealert
yum install setroubleshoot-server
sealert -a /var/log/audit/audit.log | less

Review Questions
1. setenforce 0
2. getsebool -a <OR> semanage boolean -l
3. yum provides */sepolicy; yum install policycoreutils-devel; sepolicy manpage -a -p /usr/share/man/man8; mandb; man -k _selinux
4. setroubleshoot-server (sealert)
5. semanage fcontext -a -t httpd_sys_content_t "/web(/.*)?"; restorecon -Rv /web
6. Never use chcon
7. /etc/sysconfig/selinux
8. /var/log/audit/audit.log
9. man -k _selinux | grep 'ftp'; man ftpd_selinux; /file contexts
10. sealert -a /var/log/audit/audit.log | grep <service-name>
    -OR-
    setenforce 0 [and try again to see if SELinux is the problem]

@@@
@@@ Lab 21.1
@@@
    1.  [Repeat of Exercise 21.2]
    2.  vi /root/hosts2
            192.168.122.200 labipa.example.com
            192.168.122.210 server1.example.com
            192.168.122.220 server2.example.com
            :wq
        ls -Z /root/hosts2
            -rw-r--r--. root root unconfined_u:object_r:admin_home_t:s0 /root/hosts2
        mv /root/hosts2 /etc
        semanage fcontext -a -t net_conf_t /etc/hosts2
        restorecon -v /etc/hosts2
            restorecon reset /etc/hosts2 context unconfined_u:object_r:admin_home_t:s0->unconfined_u:object_r:net_conf_t:s0
        ls -Z /etc/hosts2
            -rw-r--r--. root root unconfined_u:object_r:net_conf_t:s0 /etc/hosts2
@@@



22-22-22-22-22-22-22-22-22-22-22-22-22-22-22-22-22-22-22-22-22-22-22-22-22-22-22-22-22-22-22-22-22-22-22-22-22-22-22-22-22-22
22-22                                                    22-22-22-22-22-22-22-22-22-22-22-22-22-22-22-22-22-22-22-22-22-22-22
22-22    Chapter 22: Configuring a Firewall (15 pg.)     22-22-22-22-22-22-22-22-22-22-22-22-22-22-22-22-22-22-22-22-22-22-22
22-22                                                    22-22-22-22-22-22-22-22-22-22-22-22-22-22-22-22-22-22-22-22-22-22-22
22-22-22-22-22-22-22-22-22-22-22-22-22-22-22-22-22-22-22-22-22-22-22-22-22-22-22-22-22-22-22-22-22-22-22-22-22-22-22-22-22-22

Do I Know This Already?
A C D C C B-NOT-A A D B A

Service XML files stored:
    /usr/lib/firewalld/services
        [81 XML files]
    /etc/firewalld/services
        [0 XML files]

cat /usr/lib/firewalld/services/ipsec.xml
    <?xml version="1.0" encoding="utf-8"?>
    <service>
      <short>IPsec</short>
      <description>Internet Protocol Security (IPsec)...</description>
      <port protocol="ah" port=""/>
      <port protocol="esp" port=""/>
      <port protocol="udp" port="500"/>
      <port protocol="udp" port="4500"/>
    </service>

@@@
@@@ Exercise 22.1 Managing the Firewall with Firewall-cmd
@@@
    firewall-cmd --get-zones
        work drop internal external trusted home dmz public block
    firewall-cmd --get-default-zone
        public
    firewall-cmd --get-active-zones
        public
            interfaces: enp0s3 enp0s8 enp0s9 enp0s10
    firewall-cmd --get-services
        RH-Satellite-6 amanda-client amanda-k5-client bacula bacula-client ceph ceph-mon dhcp dhcpv6 dhcpv6-client dns docker-registry
        dropbox-lansync freeipa-ldap freeipa-ldaps freeipa-replication ftp high-availability http https imap imaps ipp ipp-client ipsec
        iscsi-target kadmin kerberos kpasswd ldap ldaps libvirt libvirt-tls mdns mosh mountd ms-wbt mysql nfs ntp openvpn pmcd pmproxy
        pmwebapi pmwebapis pop3 pop3s postgresql privoxy proxy-dhcp ptp pulseaudio puppetmaster radius rpc-bind rsyncd samba samba-client
        sane smtp smtps snmp snmptrap squid ssh synergy syslog syslog-tls telnet tftp tftp-client tinc tor-socks transmission-client vdsm
        vnc-server wbem-https xmpp-bosh xmpp-client xmpp-local xmpp-server
    firewall-cmd --list-services
        dhcp dhcpv6-client http ssh tftp
    firewall-cmd --list-all
        public (active)
          target: default
          icmp-block-inversion: no
          interfaces: enp0s10 enp0s3 enp0s8 enp0s9
          sources:
          services: dhcp dhcpv6-client http ssh tftp
          ports:
          protocols:
          masquerade: no
          forward-ports:
          sourceports:
          icmp-blocks:
          rich rules:
    firewall-cmd --list-all --zone=public
        [Same output as above]
    firewall-cmd --add-service=vnc-server
        success
    firewall-cmd --list-services
        dhcp dhcpv6-client http ssh tftp vnc-server
                                         ^^^^^^^^^^
    systemctl restart firewalld
    firewall-cmd --list-services
        dhcp dhcpv6-client http ssh tftp
                                         ^^^^^^^^^^
    firewall-cmd --add-service=vnc-server --permanent
        success
    firewall-cmd --list-services
        dhcp dhcpv6-client http ssh tftp
                                         ^^^^^^^^^^
    firewall-cmd --reload
    firewall-cmd --list-services
        dhcp dhcpv6-client vnc-server http ssh tftp
                           ^^^^^^^^^^
    firewall-cmd --add-port=2022/tcp --permanent
        success
    firewall-cmd --reload
    firewall-cmd --list-all
        public (active)
          target: default
          icmp-block-inversion: no
          interfaces: enp0s10 enp0s3 enp0s8 enp0s9
          sources:
          services: dhcp dhcpv6-client http ssh tftp vnc-server
          ports: 2022/tcp
          protocols:
          masquerade: no
          forward-ports:
          sourceports:
          icmp-blocks:
          rich rules:
@@@

@@@
@@@ Exercise 22.2 Using Firewall-config
@@@
    firewall-config &
    [In the GUI]
        Runtime dropdown -> Permanent dropdown
        Zones tab -> 'public' Zone -> Services sub-tab -> activate 'http' & 'ssh' services
        Zones tab -> 'public' Zone -> Ports sub-tab -> Add button -> 2022 & tcp
        Services tab -> 'kerberos' service -> Modules sub-tab -> [no modules listed]
        Services tab -> 'ftp' service -> Modules sub-tab -> 'nf_conntrack_ftp' module listed
        [Close the GUI]
    firewall-cmd --list-all
        [Permanent changes not shown in runtime]
    firewall-cmd --reload
    firewall-cmd --list-all
        [Permanent changes are shown]
@@@

Review Questions
1. firewalld
2. firewall-cmd --add-port=2355/udp
3. firewall-cmd --list-all-zones
4. firewall-cmd --remove-service=vnc-server
5. firewall-cmd --reload
6. firewall-cmd --list-all
7. firewall-cmd --add-interface=eno1 --zone=public [--permanent]
8. The default zone
9. firewall-cmd --add-source=192.168.0.0/24 [--permanent]
10. firewall-cmd --get-services

@@@
@@@ Lab 22.1
@@@
    1.  firewall-cmd --get-zones
            work drop internal external trusted home dmz public block
        firewall-cmd --add-service=http --add-service=ftp --add-service=ssh --zone=home
            success
        firewall-cmd --list-services --zone=home
            ssh mdns samba-client dhcpv6-client http ftp
        nmcli device | awk '{print $1}' | tail -n +2
            virbr0
            enp0s10
            enp0s3
            enp0s8
            enp0s9
            lo
            virbr0-nic
        firewall-cmd --add-interface=enp0s3 --add-interface=enp0s8 --add-interface=enp0s9 --add-interface=enp0s10 --zone=home
            The interface is under control of NetworkManager, setting zone to 'home'.
            The interface is under control of NetworkManager, setting zone to 'home'.
            The interface is under control of NetworkManager, setting zone to 'home'.
            The interface is under control of NetworkManager, setting zone to 'home'.
            success
        firewall-cmd --get-active-zones
            home
                interfaces: enp0s3 enp0s8 enp0s9 enp0s10
        firewall-cmd --set-default-zone=home
            success
    2.  firewall-cmd --runtime-to-permanent
            success
        systemctl restart firewalld
        firewall-cmd --list-all
            home (active)
              target: default
              icmp-block-inversion: no
              interfaces: enp0s10 enp0s3 enp0s8 enp0s9
              sources:
              services: dhcpv6-client ftp http mdns samba-client ssh
              ports:
              protocols:
              masquerade: no
              forward-ports:
              sourceports:
              icmp-blocks:
              rich rules:
@@@



23-23-23-23-23-23-23-23-23-23-23-23-23-23-23-23-23-23-23-23-23-23-23-23-23-23-23-23-23-23-23-23-23-23-23-23-23-23-23-23-23-23
23-23                                                                23-23-23-23-23-23-23-23-23-23-23-23-23-23-23-23-23-23-23
23-23    Chapter 23: Configuring Remote Mounts and FTP (23 pg.)      23-23-23-23-23-23-23-23-23-23-23-23-23-23-23-23-23-23-23
23-23                                                                23-23-23-23-23-23-23-23-23-23-23-23-23-23-23-23-23-23-23
23-23-23-23-23-23-23-23-23-23-23-23-23-23-23-23-23-23-23-23-23-23-23-23-23-23-23-23-23-23-23-23-23-23-23-23-23-23-23-23-23-23

Do I Know This Already?
B D B D A D D B(&D) (A&)C A

[Can use 'nfsvers=' to force a certain NFS version]

@@@
@@@ Exercise 23.1 Mounting an NFS Share
@@@
    [On the NFS client machine]
        yum search nfs
        yum install nfs-utils
        showmount -e 172.25.1.103
            clnt_create: RPC: Port mapper failure - Unable to receive: errno 113 (No route to host)

    [On the NFS server machine]
        vi /etc/exports
            /home 172.25.1.0/255.255.255.0(rw)
            /etc 172.25.1.101(ro)
            :wq
            [If changed, run 'exportfs -ra' to re-read the /etc/exports file]
        systemctl start rpcbind
        systemctl enable rpcbind
        systemctl start mountd
        systemctl enable mountd
        systemctl start nfs
        systemctl enable nfs
        firewall-cmd --add-service=rpc-bind --add-service=mountd --add-service=nfs --permanent
        firewall-cmd --reload
        firewall-cmd --list-services
            ftp rpc-bind http https ntp dhcpv6-client kerberos ldaps nfs ssh dns ldap mountd kpasswd

    [On the NFS client machine]
        showmount -e 172.25.1.103
            Export list for 172.25.1.103:
            /home 172.25.1.0/255.255.255.0
            /etc  172.25.1.101
        mount 172.25.1.103:/ /mnt
        mount | grep 172.25.1.103
            172.25.1.103:/ on /mnt type nfs4 (rw,relatime,vers=4.0,rsize=262144,wsize=262144,namlen=255,hard,proto=tcp,timeo=600,retrans=2,sec=sys,clientaddr=172.25.1.101,local_lock=none,addr=172.25.1.103)
        ls /mnt
            etc  home
        touch /mnt/home/file.test
            touch: cannot touch ‘/mnt/home/file.test’: Permission denied
        umount /mnt
@@@

@@@
@@@ Exercise 23.2 Discovering and Mounting SMB Shares
@@@
    yum install cifs-utils samba-client
    firewall-cmd --add-service=samba-client --permanent
    firewall-cmd --reload

    smbclient -L ipa.example.com
        Enter root's password:
            [Hit <Enter> without typing anything]
        Anonymous login successful
        Domain=[MYSAMBA] OS=[Windows 6.1] Server=[Samba 4.4.4]
                Sharename       Type      Comment
                ---------       ----      -------
                print$          Disk      Printer Drivers
                sambashare      Disk      My Samba Share
                IPC$            IPC       IPC Service (Samba 4.4.4)
        Anonymous login successful
        Domain=[MYSAMBA] OS=[Windows 6.1] Server=[Samba 4.4.4]
                Server               Comment
                ---------            -------
                Workgroup            Master
                ---------            -------

    yum install samba-common-tools
    net share -l -S ipa.example.com
        Enter root's password:
            [Hit <Enter> without typing anything]
        Anonymous login successful
        Enumerating shared resources (exports) on remote server:
        Share name   Type     Description
        ----------   ----     -----------
        print$       Disk     Printer Drivers
        sambashare   Disk     My Samba Share
        IPC$         IPC      IPC Service (Samba 4.4.4)

    mount -t cifs -o guest //ipa.example.com/sambashare /mnt
    mount | grep ipa.example.com
        //ipa.example.com/sambashare on /mnt type cifs (rw,relatime,vers=1.0,sec=none,cache=strict,domain=IPA,uid=0,noforceuid,gid=0,noforcegid,addr=172.25.1.103,unix,posixpaths,serverino,mapposix,acl,rsize=1048576,wsize=65536,echo_interval=60,actimeo=1)
    umount /mnt

    vi /root/creds
        username=lisa
        password=password
        domain=mydomain
        :wq
    chown root:root /root/creds
    chmod 600 /root/creds
    mount -t cifs -o credentials=/root/creds //ipa.example.com/sambashare /mnt
    mount | grep ipa.example.com
        //ipa.example.com/sambashare on /mnt type cifs (rw,relatime,vers=1.0,cache=strict,username=lisa,domain=mydomain,uid=0,noforceuid,gid=0,noforcegid,addr=172.25.1.103,unix,posixpaths,serverino,mapposix,acl,rsize=1048576,wsize=65536,echo_interval=60,actimeo=1)
    umount /mnt
@@@

Samba via GUI:
    Places -> Browse Network
    -OR-
    Network -> Connect to Server
        smb://ipa.example.com/sambashare

Mounting NFS shares via /etc/fstab:
    <server-name-or-ip>:/<share-dir>    /<mount-point>    nfs    _netdev,x-systemd.automount,sync    0 0
        vi /etc/fstab
            ipa.example.com:/home    /mnt    nfs    _netdev,x-systemd.automount,sync    0 0
            :wq
        mount -a
        ls /mnt
            [Contents of ipa.example.com:/home]
        umount /mnt

Mounting Samba shares via /etc/fstab:
    //<server-name-or-ip>/<share-dir>    /<mount-point>    cifs    _netdev,x-systemd.automount,username=<username>,password=<password>    0 0
        vi /etc/fstab
            //ipa.example.com/sambashare    /mnt    cifs    _netdev,x-systemd.automount,username=lisa,password=password    0 0
            :wq
        mount -a
        ls /mnt
            [Contents of ipa.example.com:/sambashare]
        umount /mnt
    -OR-
    vi /root/creds
        username=lisa
        password=password
        domain=mydomain
        :wq
    chown root:root /root/creds
    chmod 600 /root/creds
    //<server-name-or-ip>/<share-dir>    /<mount-point>    cifs    _netdev,x-systemd.automount,credentials=/root/creds    0 0
        vi /etc/fstab
            //ipa.example.com/sambashare    /mnt    cifs    _netdev,x-systemd.automount,credentials=/root/creds    0 0
            :wq
        mount -a
        ls /mnt
            [Contents of ipa.example.com:/sambashare]
        umount /mnt
    [If guest access is permitted, can an also use options "_netdev,x-systemd.automount,guest"]

@@@
@@@ Exercise 23.3 Configuring Direct and Indirect Maps to Mount NFS Shares
@@@
    showmount -e ipa [ipa.example.com] [172.25.1.103]
        Export list for ipa.example.com:
        /home 172.25.1.0/255.255.255.0
        /etc  172.25.1.101
        /data 172.25.1.101

    yum install autofs
    vi /etc/auto.master.d/demo.autofs
        /shares    /etc/auto.indirect
        /-         /etc/auto.direct
        :wq
    vi /etc/auto.indirect
        ipa_etc    -rw,sync    ipa.example.com:/etc
        :wq
    vi /etc/auto.direct
        /mnt    -rw,sync    ipa.example.com:/home
        :wq
    echo "/remote_data    /etc/auto.data" | tee -a /etc/auto.master
    vi /etc/auto.data
        ipa_data    -rw,sync    ipa.example.com:/data
        :wq
    systemctl start autofs
    systemctl enable autofs

    findmnt
        ...
        ├─/misc           /etc/auto.misc         autofs    rw,relatime,fd=7,pgrp=4304,timeout=300,minproto=5,maxproto=5,indirect
        ├─/net            -hosts                 autofs    rw,relatime,fd=13,pgrp=4304,timeout=300,minproto=5,maxproto=5,indirect
        ├─/shares         /etc/auto.indirect     autofs    rw,relatime,fd=19,pgrp=4304,timeout=300,minproto=5,maxproto=5,indirect
        ├─/mnt            /etc/auto.direct       autofs    rw,relatime,fd=25,pgrp=4304,timeout=300,minproto=5,maxproto=5,direct
        └─/remote_data    /etc/auto.data         autofs    rw,relatime,fd=30,pgrp=4872,timeout=300,minproto=5,maxproto=5,indirect

    ls /mnt
        [The direct mount immediately shows the contents of /mnt]
    ls /shares
        [The indirect mount is empty; autofs doesn't it considered "accessed" yet]
    ls /shares/*
        ls: cannot access /shares/*: No such file or directory
        [Still nothing]
    ls /shares/ipa_etc
        [autofs finally mounts the NFS share; contents of /etc from ipa.example.com are displayed]
    ls /remote_data
        [The indirect mount is empty; autofs doesn't it considered "accessed" yet]
    ls /remote_data/*
        ls: cannot access /remote_data/*: No such file or directory
        [Still nothing]
    ls /remote_data/ipa_data
        [autofs finally mounts the NFS share; contents of /data from ipa.example.com are displayed]

    findmnt
        ...
        ├─/misc                      /etc/auto.misc        autofs    rw,relatime,fd=7,pgrp=4872,timeout=300,minproto=5,maxproto=5,indirect
        ├─/net                       -hosts                autofs    rw,relatime,fd=13,pgrp=4872,timeout=300,minproto=5,maxproto=5,indirect
        ├─/shares                    /etc/auto.indirect    autofs    rw,relatime,fd=19,pgrp=4872,timeout=300,minproto=5,maxproto=5,indirect
        │ └─/shares/ipa_etc          ipa:/etc              nfs4      rw,relatime,sync,vers=4.0,rsize=262144,wsize=262144,namlen=255,hard,proto=tcp,port=0,timeo=600,retrans=2,sec=sys,clientaddr=172.25.1.101,local_lock=none,addr=172.25.1.103
        ├─/mnt                       /etc/auto.direct      autofs    rw,relatime,fd=25,pgrp=4872,timeout=300,minproto=5,maxproto=5,direct
        └─/remote_data               /etc/auto.data        autofs    rw,relatime,fd=30,pgrp=4872,timeout=300,minproto=5,maxproto=5,indirect
          └─/remote_data/ipa_data    ipa:/data             nfs4      rw,relatime,sync,vers=4.0,rsize=262144,wsize=262144,namlen=255,hard,proto=tcp,port=0,timeo=600,retrans=2,sec=sys,clientaddr=172.25.1.101,local_lock=none,addr=172.25.1.103
@@@

NFS wildcard indirect automount:
    vi /etc/auto.master.d/home.autofs
        /home/guests    /etc/auto.homes
        :wq
    vi /etc/auto.homes
        *    -rw,sync    ipa.example.com:/home/&
        :wq
    systemctl restart autofs
    ls /home/guests
        [Nothing yet]
    ls /home/guests/ladmin
        [Contents of ipa.example.com:/home/ladmin]

Samba indirect automount:
    vi /etc/auto.master.d/samba.autofs
        /samba     /etc/auto.samba
        :wq
    vi /etc/auto.samba
        shares    -fstype=cifs,credentials=/root/creds    ://ipa.example.com/sambashare
        :wq
    systemctl restart autofs
    ls /samba
        [Nothing yet]
    ls /samba/shares
        [Contents of //ipa.example.com/sambashare]

@@@
@@@ Exercise 23.4 Configuring an FTP Anonymous Drop Box
@@@
    [From server1]
        yum install vsftpd
        mkdir /var/ftp/uploads
        chmod 0730 /var/ftp/uploads
        chgrp ftp /var/ftp/uploads
        vi /etc/vsftpd/vsftpd.conf
            anon_umask=077
            anon_upload_enable=YES
            anon_mkdir_write_enable=YES
            chown_uploads=YES
            chown_username=root
            :wq
        systemctl start vsftpd
        systemctl enable vsftpd
        firewall-cmd --add-service=ftp --permanent
            success
        firewall-cmd --reload
            success

    [From server2]
        yum install lftp
        lftp server1
            ls
                drwxr-xr-x    2 0        0               6 Nov 05 19:43 pub
                drwx-wx---    2 0        50              6 Mar 11 22:19 uploads
            cd uploads
            put /etc/hosts
                put: Access failed: 553 Could not create file. (hosts)
            quit

    [From server1]
        grep avc /var/log/audit/audit.log
            type=AVC msg=audit(1489275720.667:457): avc:  denied  { write } for  pid=4327 comm="vsftpd" name="uploads" dev="dm-0" ino=21249272
            scontext=system_u:system_r:ftpd_t:s0-s0:c0.c1023 tcontext=unconfined_u:object_r:public_content_t:s0 tclass=dir
        getsebool -a | grep ftpd_anon
            ftpd_anon_write --> off
        semanage boolean -l | grep ftpd_anon
            ftpd_anon_write    (off   ,   off)    Determine whether ftpd can modify public files used for public file transfer services. Directories/Files must be labeled public_content_rw_t.
        setsebool -P ftpd_anon_write on
        semanage boolean -l | grep ftpd_anon
            ftpd_anon_write    (on   ,   on)    Determine whether ftpd can modify public files used for public file transfer services. Directories/Files must be labeled public_content_rw_t.
        semanage fcontext -a -t public_content_rw_t "/var/ftp/uploads(/.*)?"
        restorecon -Rv /var/ftp/uploads
            restorecon reset /var/ftp/uploads context unconfined_u:object_r:public_content_t:s0->unconfined_u:object_r:public_content_rw_t:s0

    [From server2]
        lftp server1
            cd uploads
            put /etc/hosts
                338 bytes transferred
            ls
                [Nothing returned; anonymous drop box]

    [From server1]
        ls /var/ftp/uploads
            hosts
            [Drop was successful]
@@@

Review Questions
1. /etc/krb5.keytab
2. showmount -e server1
3. mount [-t nfs] server1:/share /mnt
4. smbclient -L server1 <OR> net share -l -S server1
5. samba-client and cifs-utils
6. mount -t cifs -o guest //server1/data /mnt
7. //<server-name>/<samba-share>    /mnt    cifs    _netdev,x-systemd.automount,credentials=/root/creds    0 0
8. Must have the extension '.autofs'; '/<share-name>' for indirect automounts; '/-' for direct automounts; absolute filename with mount specifics
9. To perform a mount on an existing directory
10. /etc/vsftpd/vsftpd.conf

@@@
@@@ Lab 23.1
@@@
    1.  showmount -e ipa
            Export list for ipa:
            /home 172.25.1.0/255.255.255.0
            /etc  172.25.1.101
            /data 172.25.1.101
        vi /etc/auto.master.d/lab.autofs
            /-    /etc/auto.lab
            :wq
        vi /etc/auto.lab
            /labdata    -rw,sync    ipa:/data
            :wq
        systemctl restart autofs
        findmnt
            ├─/labdata    /etc/auto.lab    autofs    rw,relatime,fd=25,pgrp=11267,timeout=300,minproto=5,maxproto=5,direct
        ls /labdata
            [Contents of ipa:/data]
        findmnt
            ├─/labdata      /etc/auto.lab    autofs    rw,relatime,fd=25,pgrp=11267,timeout=300,minproto=5,maxproto=5,direct
            │ └─/labdata    ipa:/data        nfs4      rw,relatime,sync,vers=4.0,rsize=262144,wsize=262144,namlen=255,hard,proto=tcp,port=0,timeo=600,retrans=2,sec=sys,clientaddr=172.25.1.101,local_lock=none,addr=172.25.1.103

    2.  smbclient -L ipa
            Enter root's password:
            Anonymous login successful
            Domain=[MYSAMBA] OS=[Windows 6.1] Server=[Samba 4.4.4]
                    Sharename       Type      Comment
                    ---------       ----      -------
                    print$          Disk      Printer Drivers
                    sambashare      Disk      My Samba Share
                    IPC$            IPC       IPC Service (Samba 4.4.4)
            Anonymous login successful
            Domain=[MYSAMBA] OS=[Windows 6.1] Server=[Samba 4.4.4]
                    Server               Comment
                    ---------            -------
                    Workgroup            Master
                    ---------            -------
        mkdir -p /srv/samba/guest
        vi /etc/fstab
            //ipa.example.com/sambashare    /srv/samba/guest    cifs    _netdev,x-systemd.automount,guest    0 0
            :wq
        mount -a
        findmnt
            ├─/srv/samba/guest    //ipa.example.com/sambashare    cifs    rw,relatime,vers=1.0,sec=none,cache=strict,domain=IPA,uid=0,noforceuid,gid=0,noforceuid,gid=0,noforcegid,addr=172.25.1.103,unix,posixpaths,serverino,mapposix,acl,rsize=1048576,wsize=65536,echo_interval=60,actimeo=1
        ls /srv/samba/guest
            [Contents of ipa:/sambashare]

    3.  [On server1]
            mkdir /var/ftp/downloads
            chgrp ftp /var/ftp/downloads
            chmod 2755 /var/ftp/downloads
            touch /var/ftp/downloads/test.file
            semanage boolean -l | grep 'ftp'
                [Shows all 'ftp' booleans]
            setsebool -P ftpd_anon_write off
            vi /etc/vsftpd/vsftpd.conf
                #write_enable=YES
                #anon_upload_enable=YES
                #anon_mkdir_write_enable=YES
                #chown_uploads=YES
                #chown_username=root
        [On server2]
            cd /root
            lftp server1
                ls
                    drwxr-sr-x    2 0        50             23 Mar 12 16:11 downloads
                    drwxr-xr-x    2 0        0               6 Nov 05 19:43 pub
                    drwx-wx---    2 0        50             19 Mar 11 23:48 uploads
                cd uploads
                ls
                    [Nothing visible]
                put /etc/hosts
                    put: Access failed: 553 Could not create file. (hosts)
                cd ../downloads
                ls
                    -rw-r--r--    1 0        50              0 Mar 12 16:21 test.file
                put /etc/hosts
                    put: Access failed: 553 Could not create file. (hosts)
                get test.file
                    [Success]
                quit
            ls /root/test.file
                /root/test.file
@@@



24-24-24-24-24-24-24-24-24-24-24-24-24-24-24-24-24-24-24-24-24-24-24-24-24-24-24-24-24-24-24-24-24-24-24-24-24-24-24-24-24-24
24-24                                                       24-24-24-24-24-24-24-24-24-24-24-24-24-24-24-24-24-24-24-24-24-24
24-24    Chapter 24: Configuring Time Services (14 pg.)     24-24-24-24-24-24-24-24-24-24-24-24-24-24-24-24-24-24-24-24-24-24
24-24                                                       24-24-24-24-24-24-24-24-24-24-24-24-24-24-24-24-24-24-24-24-24-24
24-24-24-24-24-24-24-24-24-24-24-24-24-24-24-24-24-24-24-24-24-24-24-24-24-24-24-24-24-24-24-24-24-24-24-24-24-24-24-24-24-24

Do I Know This Already?
C D D C D C A C D D

vi /etc/chrony.conf
    # Use public servers from the pool.ntp.org project.
    # Please consider joining the pool (http://www.pool.ntp.org/join.html).
    server 0.centos.pool.ntp.org iburst
    server 1.centos.pool.ntp.org iburst
    server 2.centos.pool.ntp.org iburst
    server 3.centos.pool.ntp.org iburst
    ...

Convert 'epoch time' to 'human time':
    date --date '@1420987251'
        Sun Jan 11 15:40:51 CET 2015

date
    Sun Mar 12 18:41:56 CET 2017

date +%d-%m-%y
    12-03-17

date -s 16:03
    [Sets the system time to 4:03PM]

hwclock -c
    hw-time      system-time         freq-offset-ppm   tick
    1489297372   1489340815.320280
    1489297382   1489340825.321843               156      2
    1489297392   1489340835.322760               124      1
    [Updates every 10 seconds]
    Ctrl+C

hwclock --systohc
    [Set the Hardware Clock to the current System Time]

hwclock --hctosys
    [Set the System Time from the Hardware Clock]

timedatectl [status]
          Local time: Sun 2017-03-12 18:29:17 CET
      Universal time: Sun 2017-03-12 17:29:17 UTC
            RTC time: Sun 2017-03-12 05:25:14
           Time zone: Europe/Stockholm (CET, +0100)
         NTP enabled: yes
    NTP synchronized: yes
     RTC in local TZ: no
          DST active: no
     Last DST change: DST ended at
                    Sun 2016-10-30 02:59:59 CEST
                    Sun 2016-10-30 02:00:00 CET
     Next DST change: DST begins (the clock jumps one hour forward) at
                    Sun 2017-03-26 01:59:59 CET
                    Sun 2017-03-26 03:00:00 CEST

timedatectl set-time "2012-10-30 18:17:16"

timedatectl list-timezones
    Africa/Abidjan
    Africa/Accra
    Africa/Addis_Ababa
    ...

timedatectl set-timezone <timezone>

timedatectl set-local-rtc {0,1}
    [RTC in UTC | RTC in local time (keep in UTC)]

timedatectl set-ntp {0,1}
    [Turns off|on  NTP]

@@@
@@@ Exercise 24.1 Managing Local Time
@@@
    date
        Sun Mar 12 19:07:10 CET 2017
    hwclock
        Sun 12 Mar 2017 07:03:09 AM CET  -0.407347 seconds
    hwclock -c
        hw-time      system-time         freq-offset-ppm   tick
        1489298744   1489342187.280796
        1489298754   1489342197.283576               278      3
        1489298764   1489342207.284945               207      2
        1489298774   1489342217.286538               191      2
        ...
        Ctrl+C
    date -d '@1489298744'
        Sun Mar 12 07:05:44 CET 2017
    timedatectl status
              Local time: Sun 2017-03-12 19:11:55 CET
          Universal time: Sun 2017-03-12 18:11:55 UTC
                RTC time: Sun 2017-03-12 06:07:52
               Time zone: Europe/Stockholm (CET, +0100)
             NTP enabled: yes
        NTP synchronized: yes
         RTC in local TZ: no
              DST active: no
         Last DST change: DST ended at
                        Sun 2016-10-30 02:59:59 CEST
                        Sun 2016-10-30 02:00:00 CET
         Next DST change: DST begins (the clock jumps one hour forward) at
                        Sun 2017-03-26 01:59:59 CET
                        Sun 2017-03-26 03:00:00 CEST
    timedatectl list-timezones
        Africa/Abidjan
        Africa/Accra
        Africa/Addis_Ababa
        ...
    timedatectl set-timezone Europe/Amsterdam
    timedatectl status | grep 'zone'
        Time zone: Europe/Amsterdam (CET, +0100)
    timedatectl set-ntp 1
    vi /etc/chrony.conf
        # Use public servers from the pool.ntp.org project.
        # Please consider joining the pool (http://www.pool.ntp.org/join.html).
        server 0.centos.pool.ntp.org iburst
        server 1.centos.pool.ntp.org iburst
        server 2.centos.pool.ntp.org iburst
        server 3.centos.pool.ntp.org iburst
        ...
    systemctl status chronyd
        ● chronyd.service - NTP client/server
           Loaded: loaded (/usr/lib/systemd/system/chronyd.service; enabled; vendor preset: enabled)
           Active: active (running) since Sun 2017-03-12 00:12:19 CET; 19h ago
          Process: 853 ExecStartPost=/usr/libexec/chrony-helper update-daemon (code=exited, status=0/SUCCESS)
          Process: 762 ExecStart=/usr/sbin/chronyd $OPTIONS (code=exited, status=0/SUCCESS)
         Main PID: 771 (chronyd)
           CGroup: /system.slice/chronyd.service
                   └─771 /usr/sbin/chronyd
    systemctl status -l chronyd
        [Same output as above]
@@@

Can set the time zone four ways:
    - timedatectl set-timezone <timezone>
    - ln -sf /usr/share/zoneinfo/Europe/Stockholm /etc/localtime
    - tzselect
        Please identify a location so that time zone rules can be set correctly.
        Please select a continent or ocean.
         1) Africa
         2) Americas
         3) Antarctica
         ...
         [Not persistent!]
    - system-config-date &

Review Questions
1. date -s 16:24
2. hwclock --systohc
3. date -d '@1234567890'
4. hwclock --hctosys
5. chronyd
6. timedatectl set-ntp 1
7. /etc/chrony.conf
8. timedatectl list-timezones
9. timedatectl set-timezone <timezone>
10. timedatectl set-time <time>

@@@
@@@ Lab 24.1
@@@
    1.  hwclock -c
        hwclock --systohc
    2.  timedatectl list-timezones | grep 'Boston'
            [No result]
        timedatectl set-timezone "America/New_York"
        timedatectl | grep 'zone'
            Time zone: America/New_York (EDT, -0400)
@@@
